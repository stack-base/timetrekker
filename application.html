<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTrekker</title>
    <link rel="icon" href="https://stack-base.github.io/media/brand/stackbase/stackbase-icon.png" type="image/x-icon">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        heading: ['Ubuntu', 'sans-serif'],
                        display: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#0B0F19',
                        },
                        oled: {
                            base: '#000000',
                            surface: '#0f0f0f',
                            highlight: '#1a1a1a',
                            border: '#2a2a2a',
                        },
                        priority: {
                            high: '#ef4444',
                            med: '#eab308',
                            low: '#3b82f6',
                            none: '#525252'
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #262626; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #404040; }

        .glass {
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid #2a2a2a;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .animate-fade-out { animation: fadeOut 0.3s ease-out forwards; }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .custom-checkbox input:checked + div {
            background: linear-gradient(to right, #8b5cf6, #ec4899);
            border-color: transparent;
        }
        
        body { background-color: #000000; color: #e5e7eb; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        
        @keyframes breathe {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        .animate-breathe { animation: breathe 4s ease-in-out infinite; }
        
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="h-screen w-full overflow-hidden flex selection:bg-purple-500/30 font-sans bg-oled-base">

    <div id="toast-container" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center gap-2 pointer-events-none"></div>

    <div id="custom-prompt-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
        <div class="bg-oled-surface border border-oled-border w-full max-w-sm rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-200">
            <h3 id="prompt-title" class="text-lg font-semibold text-white font-heading mb-4">Enter Value</h3>
            <input type="text" id="prompt-input" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-3 py-2 outline-none focus:border-purple-500 transition-colors text-sm font-sans mb-6" autocomplete="off">
            <div class="flex justify-end space-x-3">
                <button id="prompt-cancel-btn" class="text-gray-400 hover:text-white font-medium text-sm transition-colors">Cancel</button>
                <button id="prompt-confirm-btn" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg font-bold text-sm transition-colors">Save</button>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden backdrop-blur-sm md:hidden transition-opacity opacity-0"></div>

    <nav id="sidebar" class="fixed inset-y-0 left-0 z-40 w-full bg-oled-surface border-r border-oled-border flex flex-col justify-between transition-transform duration-300 -translate-x-full md:translate-x-0 md:static md:w-20 lg:w-64">
        <div class="flex flex-col h-full overflow-hidden">
            <div class="h-16 flex items-center justify-between px-4 lg:justify-start lg:px-6 border-b border-oled-border flex-shrink-0">
                <div class="flex items-center justify-center lg:justify-start">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center shadow-[0_0_15px_rgba(139,92,246,0.3)] shrink-0">
                        <i class="ph-bold ph-check text-white text-lg"></i>
                    </div>
                    <span class="block md:hidden lg:block ml-3 font-bold text-xl tracking-tight text-white truncate font-heading">Time<span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">Trekker</span></span>
                </div>
                <button onclick="app.toggleSidebar(false)" class="md:hidden text-gray-400 hover:text-white p-2 rounded-lg hover:bg-oled-highlight transition-colors">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-1">
                <button onclick="app.toggleFocusPanel(true)" class="xl:hidden w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 mb-2 rounded-xl bg-gradient-to-r from-purple-900/30 to-pink-900/30 text-white border border-purple-500/30 hover:border-purple-400 transition-all group relative shadow-[0_0_10px_rgba(147,51,234,0.1)] shrink-0 font-display">
                    <i class="ph-fill ph-timer text-2xl lg:text-xl text-purple-400 shrink-0"></i>
                    <span class="block md:hidden lg:block ml-3 font-bold">Focus Mode</span>
                </button>

                <button onclick="app.setView('today')" id="nav-today" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 rounded-xl text-gray-400 hover:bg-oled-highlight hover:text-white transition-colors group relative shrink-0 font-display">
                    <i class="ph-duotone ph-sun text-2xl lg:text-xl group-hover:text-yellow-400 transition-colors shrink-0"></i>
                    <span class="block md:hidden lg:block ml-3 font-medium">Today</span>
                    <span id="count-today" class="block md:hidden lg:flex ml-auto text-xs bg-oled-highlight text-gray-400 px-2 py-0.5 rounded-full border border-oled-border font-display font-bold">0</span>
                </button>

                <button onclick="app.setView('tomorrow')" id="nav-tomorrow" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 rounded-xl text-gray-400 hover:bg-oled-highlight hover:text-white transition-colors group relative shrink-0 font-display">
                    <i class="ph-duotone ph-calendar-plus text-2xl lg:text-xl group-hover:text-blue-400 transition-colors shrink-0"></i>
                    <span class="block md:hidden lg:block ml-3 font-medium">Tomorrow</span>
                    <span id="count-tomorrow" class="block md:hidden lg:flex ml-auto text-xs bg-oled-highlight text-gray-400 px-2 py-0.5 rounded-full border border-oled-border font-display font-bold">0</span>
                </button>

                <button onclick="app.setView('upcoming')" id="nav-upcoming" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 rounded-xl text-gray-400 hover:bg-oled-highlight hover:text-white transition-colors group relative shrink-0 font-display">
                    <i class="ph-duotone ph-calendar text-2xl lg:text-xl group-hover:text-purple-400 transition-colors shrink-0"></i>
                    <span class="block md:hidden lg:block ml-3 font-medium">Upcoming</span>
                    <span id="count-upcoming" class="block md:hidden lg:flex ml-auto text-xs bg-oled-highlight text-gray-400 px-2 py-0.5 rounded-full border border-oled-border font-display font-bold">0</span>
                </button>
                
                <div class="border-t border-oled-border my-2 mx-2 shrink-0"></div>
                
                <div class="flex md:hidden lg:flex items-center justify-between px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider shrink-0 font-display">
                    <span>Projects</span>
                    <button onclick="app.promptNewProject()" class="hover:text-white" title="New Project"><i class="ph-bold ph-plus"></i></button>
                </div>
                <div class="hidden md:flex lg:hidden items-center justify-center py-2 shrink-0">
                     <button onclick="app.promptNewProject()" class="hover:text-white text-gray-500" title="New Project"><i class="ph-bold ph-plus"></i></button>
                </div>

                <div id="project-list" class="space-y-0.5 font-display"></div>
            </div>
            
            <div class="p-3 border-t border-oled-border shrink-0 flex flex-col gap-2">
                 <button onclick="app.setView('completed')" id="nav-completed" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2 rounded-xl text-gray-500 hover:bg-oled-highlight hover:text-white transition-colors font-display">
                    <i class="ph-duotone ph-check-circle text-xl shrink-0"></i>
                    <span class="block md:hidden lg:block ml-3 text-sm font-medium">Completed</span>
                </button>

                <div id="user-profile-display" class="flex items-center justify-start md:justify-center lg:justify-start w-full border border-oled-border bg-white/5 rounded-xl p-2 transition-colors hidden">
                    <div id="user-avatar-initials" class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold text-white shrink-0 font-heading">
                        U
                    </div>
                    <div class="flex md:hidden lg:flex flex-col ml-3 overflow-hidden">
                        <span id="user-name-text" class="text-xs font-bold text-white truncate font-display">User</span>
                        <span id="user-email-text" class="text-[10px] text-gray-400 truncate font-sans">email@example.com</span>
                    </div>
                </div>

                <button onclick="app.signOut()" class="w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2 rounded-xl text-red-400 hover:bg-oled-highlight transition-colors text-sm font-medium font-display border border-transparent hover:border-red-900/30">
                    <i class="ph-bold ph-sign-out text-lg lg:mr-2"></i>
                    <span class="block md:hidden lg:inline">Sign Out</span>
                </button>

                <a href="https://stack-base.github.io/home" target="_blank" class="flex items-center justify-start md:justify-center lg:justify-start w-full border border-oled-border hover:bg-oled-highlight rounded-xl p-3 transition-colors group no-underline box-border">
                    <span class="hidden md:block lg:hidden text-xs font-bold text-gray-500 group-hover:text-white font-heading">SB</span>
                     
                    <div class="flex md:hidden lg:flex flex-col leading-none">
                        <span class="text-[10px] text-gray-500 font-medium uppercase tracking-wider font-display">Powered by</span>
                        <span class="text-xs text-white font-bold mt-0.5 font-heading">StackBase</span>
                    </div>
                </a>
            </div>
        </div>
    </nav>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-oled-base min-w-0">
        <header class="h-16 flex-shrink-0 flex items-center justify-between px-4 lg:px-8 glass z-10 w-full">
            <div class="flex items-center min-w-0 mr-4">
                <button onclick="app.toggleSidebar()" class="md:hidden text-gray-400 hover:text-white mr-4 transition-colors">
                    <i class="ph-bold ph-list text-2xl"></i>
                </button>
                
                <h1 id="page-title" class="text-xl lg:text-2xl font-bold text-white tracking-tight truncate font-heading">Today</h1>
                <span id="current-date-display" class="ml-4 text-sm text-gray-500 font-medium hidden md:block whitespace-nowrap font-display"></span>
            </div>
            <div class="flex items-center space-x-3 shrink-0">
                 <div class="relative group hidden sm:block">
                    <button class="w-8 h-8 rounded-lg hover:bg-white/10 flex items-center justify-center text-gray-400 transition-colors">
                        <i class="ph-bold ph-sort-ascending"></i>
                    </button>
                 </div>
                 
                <button onclick="app.toggleAddTaskModal()" class="bg-white text-black hover:bg-gray-200 transition-colors px-3 lg:px-4 py-2 rounded-lg font-bold text-xs lg:text-sm flex items-center shadow-[0_0_15px_rgba(255,255,255,0.1)] whitespace-nowrap font-display">
                    <i class="ph-bold ph-plus mr-2"></i> <span class="hidden sm:inline">New Task</span><span class="sm:hidden">New</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-8 relative custom-scrollbar">
            
            <div id="stats-summary" class="hidden md:flex items-end justify-between bg-oled-surface border border-oled-border rounded-2xl p-6 mb-8 w-full max-w-4xl mx-auto shadow-lg shadow-black/50">
                <div class="flex items-center space-x-8 font-display">
                    <div>
                        <div class="text-3xl font-bold text-white leading-none" id="stat-pomos-today">0</div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-2">Pomos Done</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-white leading-none" id="stat-tasks-today">0</div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-2">Tasks Done</div>
                    </div>
                     <div>
                        <div class="text-3xl font-bold text-white leading-none" id="stat-est-remaining">0</div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-2">Est. Remain</div>
                    </div>
                </div>
                
                <div class="text-right">
                    <div class="text-3xl font-bold text-white leading-none font-display" id="stat-focus-time">0h 0m</div>
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-2 font-display">Total Focus Time</div>
                </div>
            </div>

            <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-600 pb-20 pointer-events-none">
                <i class="ph-duotone ph-check-square-offset text-6xl mb-4 opacity-30 text-white"></i>
                <p class="text-lg font-medium text-gray-500 font-heading">No tasks here yet</p>
                <p class="text-sm text-gray-700 font-display">Stay focused, get things done.</p>
            </div>

            <div id="task-list" class="space-y-3 pb-32 lg:pb-10 max-w-4xl mx-auto"></div>
        </div>
    </main>

    <aside id="timer-panel" class="fixed inset-0 z-50 flex flex-col bg-oled-surface transform translate-x-full transition-transform duration-300 xl:static xl:translate-x-0 xl:w-96 xl:border-l xl:border-oled-border xl:z-20 h-full overflow-hidden shadow-2xl shadow-black overflow-x-hidden">
        
        <div class="flex-shrink-0 px-6 py-5 flex items-center justify-between z-20 bg-oled-surface border-b border-oled-border">
            <button onclick="app.toggleFocusPanel(false)" class="xl:hidden hover:text-white flex items-center text-sm font-medium text-gray-400 font-display mr-2">
                <i class="ph-bold ph-arrow-left text-xl"></i>
            </button>

            <div class="flex items-center space-x-6 overflow-x-auto no-scrollbar font-display text-xs font-medium tracking-wide">
                <button onclick="app.setSound('none')" class="sound-option text-purple-400 hover:text-white transition-colors flex items-center whitespace-nowrap" id="sound-none">
                    <i class="ph-bold ph-prohibit mr-1.5 text-lg"></i> None
                </button>
                <button onclick="app.setSound('rain')" class="sound-option text-gray-500 hover:text-white transition-colors flex items-center whitespace-nowrap" id="sound-rain">
                    <i class="ph-bold ph-cloud-rain mr-1.5 text-lg"></i> Rain
                </button>
                <button onclick="app.setSound('cafe')" class="sound-option text-gray-500 hover:text-white transition-colors flex items-center whitespace-nowrap" id="sound-cafe">
                    <i class="ph-bold ph-coffee mr-1.5 text-lg"></i> Cafe
                </button>
                <button onclick="app.setSound('forest')" class="sound-option text-gray-500 hover:text-white transition-colors flex items-center whitespace-nowrap" id="sound-forest">
                    <i class="ph-bold ph-tree mr-1.5 text-lg"></i> Forest
                </button>
            </div>

            <button onclick="app.toggleTimerSettings()" class="ml-4 hover:text-white text-gray-400 transition-colors relative flex-shrink-0">
                <i class="ph-fill ph-gear text-xl"></i>
            </button>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center p-6 relative overflow-y-auto custom-scrollbar overflow-x-hidden">
            
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[400px] h-[400px] bg-purple-900/10 rounded-full blur-[80px] pointer-events-none opacity-50 transition-opacity duration-1000" id="timer-bg-glow"></div>

            <div class="mb-10 w-full z-10 flex flex-col items-center justify-center text-center min-h-[90px]">
                <div id="focus-empty" class="flex flex-col items-center text-gray-500 animate-pulse font-display">
                     <i class="ph-duotone ph-target text-5xl mb-3 opacity-30 text-white"></i>
                    <p class="text-sm font-medium tracking-wide">Select a task to focus</p>
                </div>
                <div id="focus-active" class="hidden animate-fade-in w-full flex flex-col items-center">
                     <div class="inline-flex items-center justify-center px-3 py-1 rounded-full bg-oled-highlight border border-oled-border text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-4 font-display">
                        <i class="ph-fill ph-hash mr-1.5 text-purple-500"></i> <span id="focus-project-badge" class="truncate max-w-[200px]">Project</span>
                    </div>
                    <h2 id="focus-task-title" class="text-2xl font-bold text-white leading-snug mb-3 line-clamp-2 px-2 font-display">Task Title</h2>
                     <div class="flex items-center space-x-2 text-xs text-gray-400 bg-oled-highlight px-4 py-1.5 rounded-full border border-oled-border font-display">
                        <span class="text-purple-400 font-bold text-sm"><span id="focus-completed">0</span> / <span id="focus-total">4</span></span>
                        <span class="uppercase tracking-widest opacity-60 ml-1">Pomos</span>
                    </div>
                </div>
            </div>

            <div class="relative z-10 mb-16 group flex justify-center">
                <div class="relative w-72 h-72 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90 drop-shadow-[0_0_30px_rgba(168,85,247,0.15)]" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#1a1a1a" stroke-width="3" />
                        <circle id="timer-progress" cx="50" cy="50" r="45" fill="none" stroke="url(#gradient)" stroke-width="3" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="0" class="transition-all duration-1000 ease-linear" />
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#c084fc" />
                                <stop offset="100%" stop-color="#e879f9" />
                            </linearGradient>
                        </defs>
                    </svg>

                    <div class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer select-none" onclick="app.toggleTimer()">
                        <div id="timer-display" class="text-[4.5rem] font-bold text-white leading-none tracking-tight font-display drop-shadow-2xl">25:00</div>
                        <div id="timer-mode" class="text-xs font-bold tracking-[0.3em] uppercase mt-4 text-purple-400/80 font-display">Focus</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-center gap-12 z-10">
                <button onclick="app.resetTimer()" class="w-14 h-14 rounded-full bg-oled-highlight border border-oled-border text-gray-400 hover:text-white hover:border-gray-600 flex items-center justify-center transition-all active:scale-95 shadow-lg shadow-black/50">
                    <i class="ph-bold ph-arrow-counter-clockwise text-xl"></i>
                </button>
                
                <button onclick="app.toggleTimer()" id="play-btn" class="relative w-24 h-24 rounded-full flex items-center justify-center transition-transform hover:scale-105 active:scale-95 group">
                    <div id="play-glow" class="absolute inset-0 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 blur-xl opacity-30 group-hover:opacity-60 transition-opacity duration-500"></div>
                    <div class="absolute inset-0 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center shadow-xl border border-white/10">
                         <i class="ph-fill ph-play text-4xl text-white ml-2" id="play-icon"></i>
                    </div>
                </button>
                
                <button onclick="app.skipTimer()" class="w-14 h-14 rounded-full bg-oled-highlight border border-oled-border text-gray-400 hover:text-white hover:border-gray-600 flex items-center justify-center transition-all active:scale-95 shadow-lg shadow-black/50">
                    <i class="ph-bold ph-skip-forward text-xl"></i>
                </button>
            </div>
        </div>
        
        <div id="timer-settings" class="absolute inset-0 bg-oled-surface/95 backdrop-blur z-50 hidden flex-col p-6 animate-fade-in overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white font-heading">Timer Settings</h3>
                <button onclick="app.toggleTimerSettings()"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="space-y-6 font-display">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold mb-2 block">Focus Duration (min)</label>
                    <input type="range" min="5" max="60" step="5" value="25" class="w-full accent-purple-500 h-2 bg-oled-highlight rounded-lg appearance-none cursor-pointer" oninput="app.updateSettings('focus', this.value)">
                    <div class="flex justify-between text-xs text-gray-400 mt-1"><span>5</span><span id="set-focus-val" class="text-white font-bold">25</span><span>60</span></div>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold mb-2 block">Short Break (min)</label>
                    <input type="range" min="1" max="15" step="1" value="5" class="w-full accent-blue-500 h-2 bg-oled-highlight rounded-lg appearance-none cursor-pointer" oninput="app.updateSettings('short', this.value)">
                    <div class="flex justify-between text-xs text-gray-400 mt-1"><span>1</span><span id="set-short-val" class="text-white font-bold">5</span><span>15</span></div>
                </div>
                 <div>
                    <label class="text-xs text-gray-500 uppercase font-bold mb-2 block">Long Break (min)</label>
                    <input type="range" min="10" max="45" step="5" value="15" class="w-full accent-green-500 h-2 bg-oled-highlight rounded-lg appearance-none cursor-pointer" oninput="app.updateSettings('long', this.value)">
                    <div class="flex justify-between text-xs text-gray-400 mt-1"><span>10</span><span id="set-long-val" class="text-white font-bold">15</span><span>45</span></div>
                </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-oled-border">
                    <div>
                        <label class="text-sm font-bold text-white block">Strict Mode</label>
                        <p class="text-[10px] text-gray-500">Prevent stopping the timer early</p>
                    </div>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="strict-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-600 transition-all duration-300 top-[-12px]" onclick="app.updateSettings('strictMode', this.checked)"/>
                        <label for="strict-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-800 cursor-pointer border border-gray-700 top-[-12px] relative"></label>
                    </div>
                </div>
            </div>
        </div>
        
        <audio id="audio-player" loop></audio>
    </aside>

    <div id="add-task-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-end md:items-center justify-center md:p-4 opacity-0 transition-opacity duration-200">
        <div class="bg-oled-surface border border-oled-border w-full h-full md:h-auto md:max-h-[90vh] md:max-w-lg md:rounded-2xl shadow-2xl overflow-hidden transform transition-transform duration-200 flex flex-col" id="add-task-panel">
            <form id="add-task-form" onsubmit="app.handleSaveTask(event)" class="flex flex-col flex-1 min-h-0">
                <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-white font-heading" id="modal-title">New Task</h2>
                        <button type="button" onclick="app.toggleAddTaskModal()" class="text-gray-400 hover:text-white">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>
                    
                    <input type="text" id="task-title" placeholder="I want to..." class="w-full bg-transparent text-2xl font-medium text-white placeholder-gray-600 border-none outline-none mb-6 font-heading" required autocomplete="off">
                    
                    <textarea id="task-note" placeholder="Add a note or description..." class="w-full bg-oled-highlight text-sm text-gray-300 placeholder-gray-600 border border-transparent focus:border-white/10 rounded-lg p-3 outline-none resize-none h-20 mb-6 transition-colors"></textarea>

                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide font-display">Subtasks</label>
                        <div id="subtasks-container" class="space-y-2 mb-2"></div>
                        <button type="button" onclick="app.addSubtaskUI()" class="text-xs text-purple-400 hover:text-purple-300 font-medium flex items-center">
                            <i class="ph-bold ph-plus mr-1"></i> Add Step
                        </button>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide font-display">Tags</label>
                        <input type="text" id="task-tags" placeholder="e.g. Work, Urgent, Design (comma separated)" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-3 py-2 outline-none focus:border-purple-500 transition-colors text-sm font-sans">
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-2 font-display">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Est. Pomos</label>
                            <div class="flex items-center space-x-2 bg-oled-highlight rounded-lg p-1 border border-oled-border h-[42px]">
                                <button type="button" onclick="app.adjustEst(-1)" class="w-8 h-full rounded bg-transparent hover:bg-white/10 text-white flex items-center justify-center transition-colors"><i class="ph-bold ph-minus"></i></button>
                                <span id="est-display" class="text-white font-mono flex-1 text-center font-bold">1</span>
                                <button type="button" onclick="app.adjustEst(1)" class="w-8 h-full rounded bg-transparent hover:bg-white/10 text-white flex items-center justify-center transition-colors"><i class="ph-bold ph-plus"></i></button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Time per Pomo (min)</label>
                            <input type="number" id="task-pomo-duration" value="25" min="1" max="120" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-3 outline-none focus:border-purple-500 transition-colors h-[42px] text-sm text-center font-mono">
                        </div>
                    </div>
                    
                    <div class="mb-6 text-center">
                        <p class="text-[11px] text-gray-500 font-display">Total Estimated Focus Time: <span id="total-est-time-display" class="text-purple-400 font-bold">25m</span></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-2 font-display">
                         <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Priority</label>
                            <div class="relative">
                                <select id="task-priority" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-2.5 outline-none focus:border-purple-500 transition-colors appearance-none text-sm h-[42px]">
                                    <option value="none">None</option>
                                    <option value="high">High Priority (!)</option>
                                    <option value="med">Medium Priority</option>
                                    <option value="low">Low Priority</option>
                                </select>
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none flex items-center"><i class="ph-bold ph-caret-down"></i></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Due Date</label>
                            <input type="date" id="task-date" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-2 outline-none focus:border-purple-500 transition-colors h-[42px] text-sm font-sans">
                        </div>
                    </div>
                    
                    <div class="mb-6 font-display">
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Project / List</label>
                        <div class="relative">
                            <select id="task-project" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-2.5 outline-none focus:border-purple-500 transition-colors text-sm h-[42px] appearance-none">
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none flex items-center"><i class="ph-bold ph-caret-down"></i></div>
                        </div>
                    </div>

                </div>
                <div class="bg-oled-surface p-4 flex justify-between border-t border-oled-border mt-auto shrink-0">
                    <button type="button" onclick="app.toggleAddTaskModal()" class="text-gray-400 hover:text-white font-medium text-sm transition-colors md:hidden">Cancel</button>
                    <button type="submit" id="save-task-btn" class="bg-white text-black hover:bg-gray-200 px-8 py-2.5 rounded-xl font-bold shadow-[0_0_15px_rgba(255,255,255,0.1)] transition-transform active:scale-95 font-display ml-auto">
                        Save Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, getDocs, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDkKhb8m0znWyC2amv6uGpA8KmbkuW-j1U",
            authDomain: "timetrekker-app.firebaseapp.com",
            projectId: "timetrekker-app",
            storageBucket: "timetrekker-app.firebasestorage.app",
            messagingSenderId: "83185163190",
            appId: "1:83185163190:web:e2974c5d0f0274fe5e3f17",
            measurementId: "G-FLZ02E1Y5L"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const appId = 'timetrekker-v1'; 

        const state = {
            user: null,
            tasks: [],
            projects: new Set(['Inbox', 'Work', 'Personal', 'Study']),
            view: 'today',
            filterProject: null,
            selectedTaskId: null,
            editingTaskId: null,
            timer: { active: false, timeLeft: 25 * 60, mode: 'focus', interval: null, settings: { focus: 25, short: 5, long: 15, strictMode: false } },
            newEst: 1,
            sound: 'none'
        };

        const sounds = {
            none: '',
            rain: 'https://cdn.pixabay.com/download/audio/2022/03/24/audio_03d973dfd3.mp3?filename=rain-112232.mp3',
            cafe: 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3?filename=cafe-ambience-6404.mp3', 
            forest: 'https://cdn.pixabay.com/download/audio/2021/09/06/audio_4488354c46.mp3?filename=forest-wind-and-birds-6869.mp3'
        };

        const els = {
            taskList: document.getElementById('task-list'),
            pageTitle: document.getElementById('page-title'),
            emptyState: document.getElementById('empty-state'),
            modal: document.getElementById('add-task-modal'),
            modalPanel: document.getElementById('add-task-panel'),
            modalTitle: document.getElementById('modal-title'),
            saveTaskBtn: document.getElementById('save-task-btn'),
            estDisplay: document.getElementById('est-display'),
            pomoDurationInput: document.getElementById('task-pomo-duration'),
            totalEstTimeDisplay: document.getElementById('total-est-time-display'),
            dateInput: document.getElementById('task-date'),
            timerDisplay: document.getElementById('timer-display'),
            timerProgress: document.getElementById('timer-progress'),
            timerMode: document.getElementById('timer-mode'),
            playIcon: document.getElementById('play-icon'),
            playGlow: document.getElementById('play-glow'),
            timerBgGlow: document.getElementById('timer-bg-glow'),
            focusActive: document.getElementById('focus-active'),
            focusEmpty: document.getElementById('focus-empty'),
            focusTitle: document.getElementById('focus-task-title'),
            focusProject: document.getElementById('focus-project-badge'),
            focusCompleted: document.getElementById('focus-completed'),
            focusTotal: document.getElementById('focus-total'),
            timerPanel: document.getElementById('timer-panel'),
            navCounts: {
                today: document.getElementById('count-today'),
                tomorrow: document.getElementById('count-tomorrow'),
                upcoming: document.getElementById('count-upcoming')
            },
            stats: {
                pomosToday: document.getElementById('stat-pomos-today'),
                tasksToday: document.getElementById('stat-tasks-today'),
                estRemain: document.getElementById('stat-est-remaining'),
                focusTime: document.getElementById('stat-focus-time')
            },
            projectList: document.getElementById('project-list'),
            projectDatalist: document.getElementById('projects-datalist'),
            subtasksContainer: document.getElementById('subtasks-container'),
            audio: document.getElementById('audio-player'),
            soundMenu: document.getElementById('sound-menu'),
            timerSettings: document.getElementById('timer-settings'),
            currentDate: document.getElementById('current-date-display'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            sidebar: document.getElementById('sidebar')
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                
                const profileEl = document.getElementById('user-profile-display');
                const nameEl = document.getElementById('user-name-text');
                const emailEl = document.getElementById('user-email-text');
                const avatarEl = document.getElementById('user-avatar-initials');
                
                if(profileEl && user) {
                    profileEl.classList.remove('hidden');
                    profileEl.classList.add('flex');
                    const name = user.displayName || user.email.split('@')[0];
                    nameEl.innerText = name;
                    emailEl.innerText = user.email;
                    avatarEl.innerText = name.charAt(0).toUpperCase();
                }

                subscribeToTasks(user.uid);
                els.currentDate.innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            } else {
                window.location.href = 'https://stack-base.github.io/account/login.html?redirectUrl=https://stack-base.github.io/timetrekker/application';
            }
        });

        function subscribeToTasks(uid) {
            const q = collection(db, 'artifacts', appId, 'users', uid, 'tasks');
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                const projects = new Set(['Inbox', 'Work', 'Personal', 'Study']);
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tasks.push({ id: doc.id, ...data });
                    if(data.project) projects.add(data.project);
                });
                state.tasks = tasks;
                state.projects = projects;
                
                updateProjectsUI();
                updateCounts();
                renderTasks();
                
                if (state.selectedTaskId) {
                    const t = tasks.find(x => x.id === state.selectedTaskId);
                    if(t) updateTimerUI(t); else { state.selectedTaskId = null; updateTimerUI(null); }
                }
            });
        }

        window.app = {
            customPrompt: {
                resolve: null,
                el: document.getElementById('custom-prompt-modal'),
                input: document.getElementById('prompt-input'),
                title: document.getElementById('prompt-title')
            },
            
            showPrompt: (title, defaultValue = '') => {
                return new Promise((resolve) => {
                    const p = app.customPrompt;
                    p.resolve = resolve;
                    p.title.innerText = title;
                    p.input.value = defaultValue;
                    p.el.classList.remove('hidden');
                    setTimeout(() => p.el.classList.remove('opacity-0'), 10);
                    setTimeout(() => p.el.querySelector('div').classList.replace('scale-95', 'scale-100'), 10);
                    p.input.focus();
                });
            },
            
            closePrompt: (value) => {
                const p = app.customPrompt;
                p.el.classList.add('opacity-0');
                p.el.querySelector('div').classList.replace('scale-100', 'scale-95');
                setTimeout(() => {
                    p.el.classList.add('hidden');
                    if(p.resolve) p.resolve(value);
                    p.resolve = null;
                }, 200);
            },

            setView: (view) => {
                state.view = view;
                state.filterProject = null;
                els.pageTitle.innerText = view.charAt(0).toUpperCase() + view.slice(1);
                updateNavStyles(view);
                window.app.toggleSidebar(false);
                renderTasks();
            },

            setProjectView: (proj) => {
                state.view = 'project';
                state.filterProject = proj;
                els.pageTitle.innerText = proj;
                updateNavStyles('project', proj);
                window.app.toggleSidebar(false);
                renderTasks();
            },

            toggleFocusPanel: (forceOpen = null) => {
                const panel = els.timerPanel;
                const isOpen = !panel.classList.contains('translate-x-full');
                const shouldOpen = forceOpen !== null ? forceOpen : !isOpen;
                if (shouldOpen) panel.classList.remove('translate-x-full');
                else panel.classList.add('translate-x-full');
            },

            toggleSidebar: (forceOpen = null) => {
                const sidebar = els.sidebar;
                const overlay = els.sidebarOverlay;
                const isHidden = sidebar.classList.contains('-translate-x-full');
                const shouldOpen = forceOpen !== null ? forceOpen : isHidden;

                if (shouldOpen) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        overlay.classList.remove('opacity-0');
                    });
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('opacity-0');
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 300);
                }
            },

            promptNewProject: async () => {
                const name = await window.app.showPrompt("Enter project name:");
                if(name) {
                    state.projects.add(name);
                    updateProjectsUI();
                }
            },

            renameProject: async (oldName, e) => {
                e.stopPropagation(); 
                const newName = await window.app.showPrompt(`Rename project "${oldName}" to:`, oldName);
                if (!newName || newName === oldName) return;

                if (!state.user) return;

                const tasksRef = collection(db, 'artifacts', appId, 'users', state.user.uid, 'tasks');
                const q = query(tasksRef, where("project", "==", oldName));
                
                try {
                    const querySnapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    querySnapshot.forEach((doc) => {
                        batch.update(doc.ref, { project: newName });
                    });
                    
                    await batch.commit();
                    
                    state.projects.delete(oldName);
                    state.projects.add(newName);
                    if (state.filterProject === oldName) {
                        window.app.setProjectView(newName);
                    } else {
                        updateProjectsUI();
                    }
                } catch (err) {
                    console.error("Error renaming project:", err);
                    window.app.showToast("Failed to rename project.", "error");
                }
            },

            addSubtaskUI: (value = '') => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 animate-fade-in';
                div.innerHTML = `
                    <div class="w-1.5 h-1.5 rounded-full bg-purple-500 shrink-0"></div>
                    <input type="text" class="subtask-input flex-1 bg-transparent border-b border-oled-border focus:border-purple-500 text-sm text-white py-1 outline-none transition-colors" placeholder="Step description" value="${value}">
                    <button type="button" onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-400"><i class="ph-bold ph-x"></i></button>
                `;
                els.subtasksContainer.appendChild(div);
            },

            toggleAddTaskModal: (taskToEdit = null) => {
                if (els.modal.classList.contains('hidden')) {
                    els.subtasksContainer.innerHTML = '';
                    
                    els.projectSelect.innerHTML = '';
                    state.projects.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p;
                        opt.innerText = p;
                        els.projectSelect.appendChild(opt);
                    });

                    if (taskToEdit) {
                        state.editingTaskId = taskToEdit.id;
                        els.modalTitle.innerText = "Edit Task";
                        els.saveTaskBtn.innerText = "Update Task";
                        
                        document.getElementById('task-title').value = taskToEdit.title;
                        document.getElementById('task-note').value = taskToEdit.note || '';
                        document.getElementById('task-tags').value = taskToEdit.tags ? taskToEdit.tags.join(', ') : '';
                        state.newEst = taskToEdit.estimatedPomos || 1;
                        els.estDisplay.innerText = state.newEst;
                        els.pomoDurationInput.value = taskToEdit.pomoDuration || 25;
                        els.dateInput.value = taskToEdit.dueDate || '';
                        document.getElementById('task-priority').value = taskToEdit.priority || 'none';
                        els.projectSelect.value = taskToEdit.project || 'Inbox';
                        
                        if (taskToEdit.subtasks && Array.isArray(taskToEdit.subtasks)) {
                            taskToEdit.subtasks.forEach(sub => window.app.addSubtaskUI(sub));
                        }
                    } else {
                        state.editingTaskId = null;
                        els.modalTitle.innerText = "New Task";
                        els.saveTaskBtn.innerText = "Save Task";
                        
                        state.newEst = 1;
                        els.estDisplay.innerText = "1";
                        els.pomoDurationInput.value = 25;
                        els.dateInput.value = new Date().toISOString().split('T')[0];
                        document.getElementById('task-title').value = '';
                        document.getElementById('task-note').value = '';
                        document.getElementById('task-tags').value = '';
                        document.getElementById('task-priority').value = 'none';
                        els.projectSelect.value = 'Inbox';
                    }
                    
                    window.app.updateTotalEstDisplay();

                    els.modal.classList.remove('hidden');
                    setTimeout(() => els.modal.classList.remove('opacity-0'), 10);
                    setTimeout(() => els.modalPanel.classList.replace('scale-95', 'scale-100'), 10);
                    document.getElementById('task-title').focus();
                } else {
                    els.modal.classList.add('opacity-0');
                    els.modalPanel.classList.replace('scale-100', 'scale-95');
                    setTimeout(() => els.modal.classList.add('hidden'), 200);
                }
            },

            adjustEst: (d) => {
                let v = state.newEst + d;
                if(v < 1) v = 1; if(v > 50) v = 50;
                state.newEst = v;
                els.estDisplay.innerText = v;
                window.app.updateTotalEstDisplay();
            },
            
            updateTotalEstDisplay: () => {
                const duration = parseInt(els.pomoDurationInput.value) || 25;
                const totalMins = state.newEst * duration;
                const h = Math.floor(totalMins / 60);
                const m = totalMins % 60;
                let text = `${totalMins}m`;
                if (h > 0) text = `${h}h ${m}m`;
                els.totalEstTimeDisplay.innerText = text;
            },

            editTask: (id, e) => {
                e.stopPropagation();
                const task = state.tasks.find(t => t.id === id);
                if (task) window.app.toggleAddTaskModal(task);
            },

            handleSaveTask: async (e) => {
                e.preventDefault();
                const title = document.getElementById('task-title').value;
                if(!title) return;
                
                const subtaskInputs = document.querySelectorAll('.subtask-input');
                const subtasks = Array.from(subtaskInputs).map(input => input.value.trim()).filter(v => v);
                
                const tagsStr = document.getElementById('task-tags').value;
                const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t);
                
                const pomoDuration = parseInt(els.pomoDurationInput.value) || 25;

                const taskData = {
                    title,
                    dueDate: els.dateInput.value,
                    estimatedPomos: state.newEst,
                    pomoDuration: pomoDuration,
                    priority: document.getElementById('task-priority').value,
                    project: document.getElementById('task-project').value || 'Inbox',
                    note: document.getElementById('task-note').value,
                    subtasks: subtasks,
                    tags: tags
                };

                const collectionRef = collection(db, 'artifacts', appId, 'users', state.user.uid, 'tasks');

                if (state.editingTaskId) {
                    await updateDoc(doc(collectionRef, state.editingTaskId), taskData);
                } else {
                    taskData.completedPomos = 0;
                    taskData.status = 'todo';
                    taskData.createdAt = new Date().toISOString();
                    await addDoc(collectionRef, taskData);
                }
                
                window.app.toggleAddTaskModal();
            },

            toggleTaskStatus: async (id, status) => {
                const newStatus = status === 'todo' ? 'done' : 'todo';
                await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'tasks', id), { status: newStatus });
            },

            deleteTask: async (id, e) => {
                e.stopPropagation();
                if(confirm('Delete task?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'tasks', id));
            },

            startTask: (id, e) => {
                e.stopPropagation();
                const task = state.tasks.find(t => t.id === id);
                if(!task) return;
                
                state.selectedTaskId = id;
                renderTasks();
                updateTimerUI(task);
                
                if(!state.timer.active) {
                    const taskDuration = task.pomoDuration || 25;
                    app.updateSettings('focus', taskDuration); 
                    app.toggleTimer();
                } else {
                    if (window.innerWidth < 1280) app.toggleFocusPanel(true);
                }
            },

            selectTask: (id) => {
                state.selectedTaskId = id;
                renderTasks();
                const t = state.tasks.find(x => x.id === id);
                updateTimerUI(t);
                
                if (window.innerWidth < 1280) {
                    window.app.toggleFocusPanel(true);
                }
            },

            showToast: (msg, type='error') => {
               const container = document.getElementById('toast-container');
               const el = document.createElement('div');
               el.className = `px-4 py-2 rounded-lg text-white text-sm font-medium shadow-lg animate-fade-in ${type === 'error' ? 'bg-red-500/90' : 'bg-green-500/90'} backdrop-blur-sm pointer-events-auto`;
               el.innerText = msg;
               container.appendChild(el);
               
               setTimeout(() => {
                   el.classList.replace('animate-fade-in', 'animate-fade-out');
                   setTimeout(() => el.remove(), 300);
               }, 3000);
            },

            toggleTimer: () => {
                if(state.timer.active) {
                    if (state.timer.settings.strictMode && state.timer.mode === 'focus') {
                        if (!confirm("Strict Mode is active! Giving up will stop your streak. Are you sure?")) {
                            return; 
                        }
                    }

                    clearInterval(state.timer.interval);
                    state.timer.active = false;
                    els.playIcon.className = "ph-fill ph-play text-4xl text-white ml-2";
                    if(els.playGlow) els.playGlow.classList.remove('animate-pulse');
                    if(els.timerBgGlow) els.timerBgGlow.classList.remove('animate-breathe');
                    if(state.sound !== 'none') els.audio.pause();
                } else {
                    if(!state.selectedTaskId && state.timer.mode === 'focus') {
                        return;
                    }
                    state.timer.active = true;
                    els.playIcon.className = "ph-fill ph-pause text-4xl text-white";
                    if(els.playGlow) els.playGlow.classList.add('animate-pulse');
                    if(els.timerBgGlow) els.timerBgGlow.classList.add('animate-breathe');
                    
                    if(state.sound !== 'none') els.audio.play().catch(e=>console.log("Audio autoplay blocked"));
                    
                    state.timer.interval = setInterval(() => {
                        state.timer.timeLeft--;
                        updateTimerVisuals();
                        if(state.timer.timeLeft <= 0) window.app.completeTimer();
                    }, 1000);
                }
            },

            resetTimer: () => {
                clearInterval(state.timer.interval);
                state.timer.active = false;
                const min = state.timer.settings[state.timer.mode];
                state.timer.timeLeft = min * 60;
                
                els.playIcon.className = "ph-fill ph-play text-4xl text-white ml-2";
                if(els.playGlow) els.playGlow.classList.remove('animate-pulse');
                if(els.timerBgGlow) els.timerBgGlow.classList.remove('animate-breathe');
                
                els.audio.pause();
                updateTimerVisuals();
            },

            skipTimer: () => window.app.completeTimer(),

            completeTimer: () => {
                clearInterval(state.timer.interval);
                state.timer.active = false;
                els.playIcon.className = "ph-fill ph-play text-4xl text-white ml-2";
                if(els.playGlow) els.playGlow.classList.remove('animate-pulse');
                if(els.timerBgGlow) els.timerBgGlow.classList.remove('animate-breathe');
                els.audio.pause();

                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.connect(ctx.destination);
                osc.frequency.value = 523.25;
                osc.start();
                osc.stop(ctx.currentTime + 0.2);

                if(state.timer.mode === 'focus') {
                    if(state.selectedTaskId) {
                        const t = state.tasks.find(x => x.id === state.selectedTaskId);
                        if(t) updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'tasks', t.id), { completedPomos: (t.completedPomos||0)+1 });
                    }
                    window.app.setTimerMode('short');
                } else {
                    window.app.setTimerMode('focus');
                }
            },
            
            setTimerMode: (mode) => {
                state.timer.mode = mode;
                state.timer.timeLeft = state.timer.settings[mode] * 60;
                els.timerMode.innerText = mode === 'focus' ? 'Focus Mode' : mode === 'short' ? 'Short Break' : 'Long Break';
                els.timerMode.className = `text-xs font-bold tracking-[0.2em] uppercase mt-3 ${mode === 'focus' ? 'text-purple-300' : 'text-blue-300'}`;
                updateTimerVisuals();
            },

            toggleSoundMenu: () => {
                els.soundMenu.classList.toggle('hidden');
            },
            
            setSound: (type) => {
                state.sound = type;
                els.audio.src = sounds[type];
                
                document.querySelectorAll('.sound-option').forEach(btn => {
                    btn.classList.remove('text-purple-400');
                    btn.classList.add('text-gray-500');
                });
                
                const activeBtn = document.getElementById(`sound-${type}`);
                if (activeBtn) {
                    activeBtn.classList.remove('text-gray-500');
                    activeBtn.classList.add('text-purple-400');
                }

                if(type === 'none') {
                    els.audio.pause();
                } else {
                    if(state.timer.active) els.audio.play();
                }
            },

            toggleTimerSettings: () => {
                els.timerSettings.classList.toggle('hidden');
                els.timerSettings.classList.toggle('flex');
            },

            updateSettings: (key, val) => {
                if (key === 'strictMode') {
                    state.timer.settings[key] = val;
                } else {
                    state.timer.settings[key] = parseInt(val);
                    document.getElementById(`set-${key}-val`).innerText = val;
                    if(!state.timer.active && state.timer.mode === key) {
                        state.timer.timeLeft = parseInt(val) * 60;
                        updateTimerVisuals();
                    }
                }
            },

            signOut: () => {
                signOut(auth).then(() => {
                    window.location.href = 'https://stack-base.github.io/account/login.html?redirectUrl=https://stack-base.github.io/timetrekker/application';
                });
            }
        };

        document.getElementById('prompt-cancel-btn').addEventListener('click', () => window.app.closePrompt(null));
        document.getElementById('prompt-confirm-btn').addEventListener('click', () => window.app.closePrompt(window.app.customPrompt.input.value));
        document.getElementById('prompt-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') window.app.closePrompt(window.app.customPrompt.input.value);
        });

        els.pomoDurationInput.addEventListener('input', window.app.updateTotalEstDisplay);

        function updateNavStyles(view, proj) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = view !== 'project' && btn.id === `nav-${view}`;
                if (isActive) {
                    btn.classList.add('bg-oled-highlight', 'text-white', 'border', 'border-oled-border');
                    btn.classList.remove('text-gray-400', 'hover:bg-oled-highlight');
                } else {
                    btn.classList.remove('bg-oled-highlight', 'text-white', 'border', 'border-oled-border');
                    btn.classList.add('text-gray-400', 'hover:bg-oled-highlight');
                }
            });
            document.querySelectorAll('.project-btn').forEach(b => {
                const isActive = view === 'project' && b.dataset.proj === proj;
                if (isActive) {
                    b.classList.add('text-white', 'bg-oled-highlight');
                    b.classList.remove('text-gray-400', 'hover:bg-oled-highlight');
                } else {
                    b.classList.remove('text-white', 'bg-oled-highlight');
                    b.classList.add('text-gray-400', 'hover:bg-oled-highlight');
                }
            });
        }

        function updateProjectsUI() {
            els.projectList.innerHTML = '';
            state.projects.forEach(p => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="group relative flex items-center">
                        <button onclick="app.setProjectView('${p}')" data-proj="${p}" class="project-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-oled-highlight transition-colors text-sm group shrink-0 font-display">
                            <div class="flex items-center min-w-0">
                                <i class="ph-bold ph-hash mr-3 opacity-50 shrink-0"></i>
                                <span class="truncate">${p}</span>
                            </div>
                        </button>
                        <button onclick="app.renameProject('${p}', event)" class="absolute right-2 opacity-0 group-hover:opacity-100 text-gray-500 hover:text-white transition-opacity p-1" title="Rename Project">
                            <i class="ph-bold ph-pencil-simple"></i>
                        </button>
                    </div>
                `;
                els.projectList.appendChild(div);
            });
        }

        function updateCounts() {
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            
            els.navCounts.today.innerText = state.tasks.filter(t => t.dueDate === today && t.status === 'todo').length;
            els.navCounts.tomorrow.innerText = state.tasks.filter(t => t.dueDate === tomorrow && t.status === 'todo').length;
            els.navCounts.upcoming.innerText = state.tasks.filter(t => t.dueDate > tomorrow && t.status === 'todo').length;
            
            const doneToday = state.tasks.filter(t => t.status === 'done' && t.dueDate === today).length;
            const totalPomos = state.tasks.reduce((a,b) => a + (b.completedPomos||0), 0);
            const estRem = state.tasks.filter(t=>t.status==='todo').reduce((a,b) => a + (parseInt(b.estimatedPomos)||0), 0);

            els.stats.pomosToday.innerText = totalPomos;
            els.stats.tasksToday.innerText = doneToday;
            els.stats.estRemain.innerText = estRem;
            
            const focusMinutes = totalPomos * state.timer.settings.focus;
            const hours = Math.floor(focusMinutes / 60);
            const mins = focusMinutes % 60;
            els.stats.focusTime.innerText = `${hours}h ${mins}m`;
        }

        function renderTasks() {
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            
            let list = [];
            
            if (state.view === 'today') list = state.tasks.filter(t => t.dueDate === today && t.status === 'todo');
            else if (state.view === 'tomorrow') list = state.tasks.filter(t => t.dueDate === tomorrow && t.status === 'todo');
            else if (state.view === 'upcoming') list = state.tasks.filter(t => t.dueDate > tomorrow && t.status === 'todo');
            else if (state.view === 'completed') list = state.tasks.filter(t => t.status === 'done');
            else if (state.view === 'project') list = state.tasks.filter(t => t.project === state.filterProject && t.status === 'todo');
            
            const prioMap = { high: 3, med: 2, low: 1, none: 0 };
            list.sort((a,b) => prioMap[b.priority] - prioMap[a.priority]);

            els.taskList.innerHTML = '';
            if(list.length === 0) els.emptyState.classList.remove('hidden'); else els.emptyState.classList.add('hidden');

            list.forEach(t => {
                const isSel = t.id === state.selectedTaskId;
                const percent = Math.min(100, ((t.completedPomos||0)/(t.estimatedPomos||1))*100);
                
                const pColor = { high: 'text-red-500', med: 'text-yellow-500', low: 'text-blue-500', none: 'text-gray-600' }[t.priority || 'none'];
                const boxColor = { high: 'border-red-500', med: 'border-yellow-500', low: 'border-blue-500', none: 'border-gray-600' }[t.priority || 'none'];

                const el = document.createElement('div');
                el.className = `group flex items-start p-4 rounded-xl border transition-all cursor-pointer relative overflow-hidden ${isSel ? 'bg-oled-highlight border-purple-500/50' : 'bg-oled-surface border-oled-border hover:bg-oled-highlight hover:border-oled-border'}`;
                el.onclick = () => window.app.selectTask(t.id);

                let tagsHTML = '';
                if (t.tags && t.tags.length > 0) {
                    tagsHTML = `<div class="flex flex-wrap gap-1 mt-2">
                        ${t.tags.map(tag => `<span class="text-[10px] bg-white/5 border border-white/5 rounded px-1.5 py-0.5 text-gray-400">${tag}</span>`).join('')}
                    </div>`;
                }

                let subtasksHTML = '';
                if (t.subtasks && t.subtasks.length > 0) {
                    subtasksHTML = `<div class="flex items-center text-xs text-gray-500 mt-1">
                        <i class="ph-bold ph-list-checks mr-1"></i>
                        <span>${t.subtasks.length} subtasks</span>
                    </div>`;
                }
                
                const duration = t.pomoDuration || 25;
                const completedMins = (t.completedPomos || 0) * duration;
                const remainingMins = ((t.estimatedPomos || 1) - (t.completedPomos || 0)) * duration;
                const doneH = Math.floor(completedMins / 60);
                const doneM = completedMins % 60;
                const remH = Math.floor(remainingMins > 0 ? remainingMins / 60 : 0);
                const remM = Math.max(0, remainingMins % 60);

                el.innerHTML = `
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${t.priority === 'high' ? 'bg-red-500' : t.priority === 'med' ? 'bg-yellow-500' : 'bg-transparent'}"></div>
                    
                    <label class="custom-checkbox flex-shrink-0 mt-0.5 w-6 h-6 mr-4 cursor-pointer relative z-10" onclick="event.stopPropagation()">
                        <input type="checkbox" class="hidden" ${t.status === 'done' ? 'checked' : ''} onchange="app.toggleTaskStatus('${t.id}', '${t.status}')">
                        <div class="w-5 h-5 border-2 ${boxColor} rounded-md flex items-center justify-center transition-all hover:border-purple-400 bg-oled-surface">
                            <svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </label>
                    
                    <div class="flex-1 min-w-0 pr-24">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-medium text-gray-200 truncate ${t.status === 'done' ? 'line-through text-gray-500' : ''} font-heading">${t.title}</h3>
                            <div class="flex items-center shrink-0">
                                ${t.priority !== 'none' ? `<i class="ph-fill ph-flag ${pColor} text-xs ml-2"></i>` : ''}
                            </div>
                        </div>
                        
                        ${t.note ? `<p class="text-xs text-gray-500 line-clamp-1 mt-0.5 truncate font-display">${t.note}</p>` : ''}
                        
                        ${subtasksHTML}
                        ${tagsHTML}

                        <div class="flex items-center mt-2 space-x-3 font-display">
                            <div class="flex items-center text-xs text-gray-400 bg-oled-highlight px-2 py-0.5 rounded border border-oled-border shrink-0">
                                <i class="ph-fill ph-clock text-pink-500 mr-1 shrink-0"></i>
                                <span class="${percent >= 100 ? 'text-green-400' : ''}">${t.completedPomos||0}/${t.estimatedPomos||1}</span>
                            </div>
                            <div class="flex items-center text-xs text-gray-600 truncate">
                                <i class="ph-bold ph-folder mr-1 shrink-0"></i> <span class="truncate">${t.project}</span>
                            </div>
                            <div class="flex items-center text-[10px] text-gray-400 bg-oled-surface border border-oled-border px-3 py-1 rounded-full ml-auto whitespace-nowrap">
                                <span>Done: ${doneH}h ${doneM}m</span>
                                <span class="mx-1 opacity-30">|</span>
                                <span>Left: ${remH}h ${remM}m</span>
                            </div>
                        </div>
                    </div>

                    <div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center space-x-2 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-all z-20 bg-oled-surface p-1 rounded-lg border border-oled-border shadow-lg">
                        <button onclick="app.startTask('${t.id}', event)" class="w-8 h-8 flex items-center justify-center text-purple-400 hover:text-white transition-colors hover:bg-white/5 rounded-md" title="Start Timer">
                            <i class="ph-fill ph-play"></i>
                        </button>
                        <button onclick="app.editTask('${t.id}', event)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-white transition-colors hover:bg-white/5 rounded-md" title="Edit Task">
                            <i class="ph-bold ph-pencil-simple"></i>
                        </button>
                        <button onclick="app.deleteTask('${t.id}', event)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-red-400 transition-colors hover:bg-white/5 rounded-md" title="Delete Task">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </div>
                    
                    <div class="absolute bottom-0 left-0 right-0 h-px bg-white/5">
                         <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 opacity-30" style="width: ${percent}%"></div>
                    </div>
                `;
                els.taskList.appendChild(el);
            });
        }

        function updateTimerUI(t) {
            if(!t) {
                els.focusEmpty.classList.remove('hidden');
                els.focusActive.classList.add('hidden');
                return;
            }
            els.focusEmpty.classList.add('hidden');
            els.focusActive.classList.remove('hidden');
            
            els.focusTitle.innerText = t.title;
            els.focusProject.innerText = t.project || 'Inbox';
            els.focusCompleted.innerText = t.completedPomos || 0;
            els.focusTotal.innerText = t.estimatedPomos || 1;
        }

        function updateTimerVisuals() {
            const m = Math.floor(state.timer.timeLeft / 60);
            const s = state.timer.timeLeft % 60;
            els.timerDisplay.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            const max = state.timer.settings[state.timer.mode] * 60;
            const fraction = state.timer.timeLeft / max;
            const dashoffset = 283 * (1 - fraction);
            els.timerProgress.style.strokeDashoffset = dashoffset;
        }
        
        window.app.setView('today');
        updateTimerVisuals();
    </script>
</body>
</html>