<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TimeTrekker</title>
<link rel="icon" href="https://stack-base.github.io/media/brand/stackbase/stackbase-icon.png" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={darkMode:'class',theme:{extend:{fontFamily:{sans:['Roboto','sans-serif'],heading:['Ubuntu','sans-serif'],display:['Poppins','sans-serif']},colors:{gray:{850:'#1f2937',900:'#111827',950:'#0B0F19'},oled:{base:'#000000',surface:'#0f0f0f',highlight:'#1a1a1a',border:'#2a2a2a'},priority:{high:'#ef4444',med:'#eab308',low:'#3b82f6',none:'#525252'}}}}};
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script src="https://unpkg.com/@phosphor-icons/web"></script>
<style>
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#262626;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#404040}
.glass{background:rgba(15,15,15,0.95);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid #2a2a2a}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.animate-fade-in{animation:fadeIn .3s ease-out forwards}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}.animate-fade-out{animation:fadeOut .3s ease-out forwards}
.progress-ring__circle{transition:stroke-dashoffset .35s;transform:rotate(-90deg);transform-origin:50% 50%}
.custom-checkbox input:checked+div{background:linear-gradient(to right,#8b5cf6,#ec4899);border-color:transparent}
body{background-color:#000;color:#e5e7eb}
@keyframes breathe{0%,100%{opacity:.4;transform:scale(1)}50%{opacity:.8;transform:scale(1.05)}}.animate-breathe{animation:breathe 4s ease-in-out infinite}
.toggle-checkbox:checked{right:0;border-color:#68D391}.toggle-checkbox:checked+.toggle-label{background-color:#68D391}
.no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
.chart-container{position:relative;width:100%;height:100%}
</style>
</head>
<body class="h-screen w-full overflow-hidden flex selection:bg-purple-500/30 font-sans bg-oled-base">
<div id="toast-container" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center gap-2 pointer-events-none"></div>
<div id="custom-prompt-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
<div class="bg-oled-surface border border-oled-border w-full max-w-sm rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-200">
<h3 id="prompt-title" class="text-lg font-semibold text-white font-heading mb-4">Enter Value</h3>
<input type="text" id="prompt-input" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-3 py-2 outline-none focus:border-purple-500 transition-colors text-sm font-sans mb-6" autocomplete="off">
<div class="flex justify-end space-x-3"><button id="prompt-cancel-btn" class="text-gray-400 hover:text-white font-medium text-sm transition-colors">Cancel</button><button id="prompt-confirm-btn" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg font-bold text-sm transition-colors">Save</button></div></div></div>
<div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden backdrop-blur-sm md:hidden transition-opacity opacity-0"></div>
<nav id="sidebar" class="fixed inset-y-0 left-0 z-40 w-full bg-oled-surface border-r border-oled-border flex flex-col justify-between transition-transform duration-300 -translate-x-full md:translate-x-0 md:static md:w-20 lg:w-64">
<div class="flex flex-col h-full overflow-hidden">
<div class="h-16 flex items-center justify-between px-4 lg:justify-start lg:px-6 border-b border-oled-border flex-shrink-0">
<div class="flex items-center justify-center lg:justify-start"><div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center shadow-[0_0_15px_rgba(139,92,246,0.3)] shrink-0"><i class="ph-bold ph-check text-white text-lg"></i></div><span class="block md:hidden lg:block ml-3 font-bold text-xl tracking-tight text-white truncate font-heading">Time<span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">Trekker</span></span></div>
<button onclick="app.toggleSidebar(false)" class="md:hidden text-gray-400 hover:text-white p-2 rounded-lg hover:bg-oled-highlight transition-colors"><i class="ph-bold ph-x text-xl"></i></button></div>
<div class="flex-1 overflow-y-auto p-3 space-y-1">
<button onclick="app.toggleFocusPanel(true)" class="xl:hidden w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 mb-2 rounded-xl bg-gradient-to-r from-purple-900/30 to-pink-900/30 text-white border border-purple-500/30 hover:border-purple-400 transition-all group relative shadow-[0_0_10px_rgba(147,51,234,0.1)] shrink-0 font-display"><i class="ph-fill ph-timer text-2xl lg:text-xl text-purple-400 shrink-0"></i><span class="block md:hidden lg:block ml-3 font-bold">Focus Mode</span></button>
<button onclick="app.setView('past')" id="nav-past" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 rounded-xl text-gray-400 hover:bg-oled-highlight hover:text-white transition-colors group relative shrink-0 font-display"><i class="ph-duotone ph-clock-counter-clockwise text-2xl lg:text-xl group-hover:text-red-400 transition-colors shrink-0"></i><span class="block md:hidden lg:block ml-3 font-medium">Past</span><span id="count-past" class="block md:hidden lg:flex ml-auto text-xs bg-oled-highlight text-gray-400 px-2 py-0.5 rounded-full border border-oled-border font-display font-bold">0</span></button>
<button onclick="app.setView('today')" id="nav-today" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 rounded-xl text-gray-400 hover:bg-oled-highlight hover:text-white transition-colors group relative shrink-0 font-display"><i class="ph-duotone ph-sun text-2xl lg:text-xl group-hover:text-yellow-400 transition-colors shrink-0"></i><span class="block md:hidden lg:block ml-3 font-medium">Today</span><span id="count-today" class="block md:hidden lg:flex ml-auto text-xs bg-oled-highlight text-gray-400 px-2 py-0.5 rounded-full border border-oled-border font-display font-bold">0</span></button>
<button onclick="app.setView('tomorrow')" id="nav-tomorrow" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 rounded-xl text-gray-400 hover:bg-oled-highlight hover:text-white transition-colors group relative shrink-0 font-display"><i class="ph-duotone ph-calendar-plus text-2xl lg:text-xl group-hover:text-blue-400 transition-colors shrink-0"></i><span class="block md:hidden lg:block ml-3 font-medium">Tomorrow</span><span id="count-tomorrow" class="block md:hidden lg:flex ml-auto text-xs bg-oled-highlight text-gray-400 px-2 py-0.5 rounded-full border border-oled-border font-display font-bold">0</span></button>
<button onclick="app.setView('upcoming')" id="nav-upcoming" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 rounded-xl text-gray-400 hover:bg-oled-highlight hover:text-white transition-colors group relative shrink-0 font-display"><i class="ph-duotone ph-calendar text-2xl lg:text-xl group-hover:text-purple-400 transition-colors shrink-0"></i><span class="block md:hidden lg:block ml-3 font-medium">Upcoming</span><span id="count-upcoming" class="block md:hidden lg:flex ml-auto text-xs bg-oled-highlight text-gray-400 px-2 py-0.5 rounded-full border border-oled-border font-display font-bold">0</span></button>
<button onclick="app.setView('analytics')" id="nav-analytics" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2.5 rounded-xl text-gray-400 hover:bg-oled-highlight hover:text-white transition-colors group relative shrink-0 font-display"><i class="ph-duotone ph-chart-line-up text-2xl lg:text-xl group-hover:text-green-400 transition-colors shrink-0"></i><span class="block md:hidden lg:block ml-3 font-medium">Analytics</span></button>
<div class="border-t border-oled-border my-2 mx-2 shrink-0"></div>
<div class="flex md:hidden lg:flex items-center justify-between px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider shrink-0 font-display"><span>Projects</span><button onclick="app.promptNewProject()" class="hover:text-white" title="New Project"><i class="ph-bold ph-plus"></i></button></div>
<div class="hidden md:flex lg:hidden items-center justify-center py-2 shrink-0"><button onclick="app.promptNewProject()" class="hover:text-white text-gray-500" title="New Project"><i class="ph-bold ph-plus"></i></button></div>
<div id="project-list" class="space-y-0.5 font-display"></div></div>
<div class="p-3 border-t border-oled-border shrink-0 flex flex-col gap-2">
<button onclick="app.setView('completed')" id="nav-completed" class="nav-btn w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2 rounded-xl text-gray-500 hover:bg-oled-highlight hover:text-white transition-colors font-display"><i class="ph-duotone ph-check-circle text-xl shrink-0"></i><span class="block md:hidden lg:block ml-3 text-sm font-medium">Completed</span></button>
<div id="user-profile-display" class="flex items-center justify-start md:justify-center lg:justify-start w-full border border-oled-border bg-white/5 rounded-xl p-2 transition-colors hidden"><div id="user-avatar-initials" class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold text-white shrink-0 font-heading">U</div><div class="flex md:hidden lg:flex flex-col ml-3 overflow-hidden"><span id="user-name-text" class="text-xs font-bold text-white truncate font-display">User</span><span id="user-email-text" class="text-[10px] text-gray-400 truncate font-sans">email@example.com</span></div></div>
<button onclick="app.signOut()" class="w-full flex items-center justify-start md:justify-center lg:justify-start px-3 py-2 rounded-xl text-red-400 hover:bg-oled-highlight transition-colors text-sm font-medium font-display border border-transparent hover:border-red-900/30"><i class="ph-bold ph-sign-out text-lg lg:mr-2"></i><span class="block md:hidden lg:inline">Sign Out</span></button></div></div></nav>
<main class="flex-1 flex flex-col relative overflow-hidden bg-oled-base min-w-0">
<header class="h-16 flex-shrink-0 flex items-center justify-between px-4 lg:px-8 glass z-10 w-full">
<div class="flex items-center min-w-0 mr-4"><button onclick="app.toggleSidebar()" class="md:hidden text-gray-400 hover:text-white mr-4 transition-colors"><i class="ph-bold ph-list text-2xl"></i></button><h1 id="page-title" class="text-xl lg:text-2xl font-bold text-white tracking-tight truncate font-heading">Today</h1><span id="current-date-display" class="ml-4 text-sm text-gray-500 font-medium hidden md:block whitespace-nowrap font-display"></span></div>
<div class="flex items-center space-x-3 shrink-0" id="header-actions"><div class="relative group hidden sm:block"><button class="w-8 h-8 rounded-lg hover:bg-white/10 flex items-center justify-center text-gray-400 transition-colors"><i class="ph-bold ph-sort-ascending"></i></button></div><button onclick="app.toggleAddTaskModal()" class="bg-white text-black hover:bg-gray-200 transition-colors px-3 lg:px-4 py-2 rounded-lg font-bold text-xs lg:text-sm flex items-center shadow-[0_0_15px_rgba(255,255,255,0.1)] whitespace-nowrap font-display"><i class="ph-bold ph-plus mr-2"></i> <span class="hidden sm:inline">New Task</span><span class="sm:hidden">New</span></button></div></header>
<div class="flex-1 overflow-y-auto relative custom-scrollbar">
<div id="task-view-container" class="p-4 lg:p-8">
<div id="stats-summary" class="hidden md:flex items-end justify-between bg-oled-surface border border-oled-border rounded-2xl p-6 mb-8 w-full max-w-4xl mx-auto shadow-lg shadow-black/50">
<div class="flex items-center space-x-8 font-display"><div><div class="text-3xl font-bold text-white leading-none" id="stat-pomos-today">0</div><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-2">Pomos Done</div></div><div><div class="text-3xl font-bold text-white leading-none" id="stat-tasks-today">0</div><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-2">Tasks Done</div></div><div><div class="text-3xl font-bold text-white leading-none" id="stat-est-remaining">0</div><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-2">Est. Remain</div></div></div><div class="text-right"><div class="text-3xl font-bold text-white leading-none font-display" id="stat-focus-time">0h 0m</div><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-2 font-display">Total Focus Time</div></div></div>
<div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-600 pb-20 pointer-events-none"><i class="ph-duotone ph-check-square-offset text-6xl mb-4 opacity-30 text-white"></i><p class="text-lg font-medium text-gray-500 font-heading">No tasks here yet</p><p class="text-sm text-gray-700 font-display">Stay focused, get things done.</p></div><div id="task-list" class="space-y-3 pb-32 lg:pb-10 max-w-4xl mx-auto"></div></div>
<div id="analytics-view-container" class="hidden p-4 lg:p-8 max-w-6xl mx-auto space-y-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="bg-oled-surface border border-oled-border rounded-2xl p-6 relative overflow-hidden group"><div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-clock-countdown text-6xl text-purple-500"></i></div><h3 class="text-gray-400 text-xs uppercase font-bold tracking-widest font-display mb-1">Total Focus</h3><div class="text-3xl font-bold text-white font-heading" id="ana-total-time">0h 0m</div><div class="mt-2 text-xs text-green-400 font-medium flex items-center"><i class="ph-bold ph-trend-up mr-1"></i> <span>All time</span></div></div>
<div class="bg-oled-surface border border-oled-border rounded-2xl p-6 relative overflow-hidden group"><div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-fire text-6xl text-orange-500"></i></div><h3 class="text-gray-400 text-xs uppercase font-bold tracking-widest font-display mb-1">Current Streak</h3><div class="text-3xl font-bold text-white font-heading" id="ana-streak">0 Days</div><div class="mt-2 text-xs text-orange-400 font-medium flex items-center"><span>Keep it burning!</span></div></div>
<div class="bg-oled-surface border border-oled-border rounded-2xl p-6 relative overflow-hidden group"><div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-chart-bar text-6xl text-blue-500"></i></div><h3 class="text-gray-400 text-xs uppercase font-bold tracking-widest font-display mb-1">Daily Average</h3><div class="text-3xl font-bold text-white font-heading" id="ana-daily-avg">0h 0m</div><div class="mt-2 text-xs text-blue-400 font-medium flex items-center"><span>Last 30 Days</span></div></div></div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-2 bg-oled-surface border border-oled-border rounded-2xl p-6"><h3 class="text-white font-bold text-lg mb-6 font-heading flex items-center"><i class="ph-bold ph-activity text-purple-500 mr-2"></i> Activity (Last 7 Days)</h3><div class="h-64 w-full"><canvas id="activityChart"></canvas></div></div>
<div class="bg-oled-surface border border-oled-border rounded-2xl p-6 flex flex-col"><h3 class="text-white font-bold text-lg mb-6 font-heading flex items-center"><i class="ph-bold ph-pie-chart text-pink-500 mr-2"></i> Project Distribution</h3><div class="flex-1 flex items-center justify-center relative"><canvas id="projectChart"></canvas><div id="no-data-project" class="hidden absolute inset-0 flex items-center justify-center text-xs text-gray-500">No Data</div></div></div></div>
<div class="bg-oled-surface border border-oled-border rounded-2xl p-6"><h3 class="text-white font-bold text-lg mb-4 font-heading flex items-center"><i class="ph-bold ph-calendar-check text-green-500 mr-2"></i> Focus Intensity (Day vs Hour)</h3><div class="text-xs text-gray-500 mb-4">Darker blocks indicate more focus sessions.</div><div class="w-full h-48 flex items-center justify-center text-gray-500 text-sm border border-dashed border-gray-800 rounded-lg bg-black/20" id="heatmap-placeholder"><div class="grid grid-cols-24 gap-1 w-full h-full p-2" id="heatmap-grid"></div></div></div></div></div></main>
<aside id="timer-panel" class="fixed inset-0 z-50 flex flex-col bg-oled-surface transform translate-x-full transition-transform duration-300 xl:static xl:translate-x-0 xl:w-96 xl:border-l xl:border-oled-border xl:z-20 h-full overflow-hidden shadow-2xl shadow-black overflow-x-hidden">
<div class="flex-shrink-0 px-6 py-5 flex items-center justify-between z-20 bg-oled-surface border-b border-oled-border">
<button onclick="app.toggleFocusPanel(false)" class="xl:hidden hover:text-white flex items-center text-sm font-medium text-gray-400 font-display mr-2"><i class="ph-bold ph-arrow-left text-xl"></i></button>
<div class="flex items-center space-x-6 overflow-x-auto no-scrollbar font-display text-xs font-medium tracking-wide">
<button onclick="app.setSound('none')" class="sound-option text-purple-400 hover:text-white transition-colors flex items-center whitespace-nowrap" id="sound-none"><i class="ph-bold ph-prohibit mr-1.5 text-lg"></i> None</button>
<button onclick="app.setSound('rain')" class="sound-option text-gray-500 hover:text-white transition-colors flex items-center whitespace-nowrap" id="sound-rain"><i class="ph-bold ph-cloud-rain mr-1.5 text-lg"></i> Rain</button>
<button onclick="app.setSound('cafe')" class="sound-option text-gray-500 hover:text-white transition-colors flex items-center whitespace-nowrap" id="sound-cafe"><i class="ph-bold ph-coffee mr-1.5 text-lg"></i> Cafe</button>
<button onclick="app.setSound('forest')" class="sound-option text-gray-500 hover:text-white transition-colors flex items-center whitespace-nowrap" id="sound-forest"><i class="ph-bold ph-tree mr-1.5 text-lg"></i> Forest</button>
</div><button onclick="app.toggleTimerSettings()" class="ml-4 hover:text-white text-gray-400 transition-colors relative flex-shrink-0"><i class="ph-fill ph-gear text-xl"></i></button></div>
<div class="flex-1 flex flex-col items-center justify-center p-6 relative overflow-y-auto custom-scrollbar overflow-x-hidden">
<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[400px] h-[400px] bg-purple-900/10 rounded-full blur-[80px] pointer-events-none opacity-50 transition-opacity duration-1000" id="timer-bg-glow"></div>
<div class="mb-10 w-full z-10 flex flex-col items-center justify-center text-center min-h-[90px]">
<div id="focus-empty" class="flex flex-col items-center text-gray-500 animate-pulse font-display"><i class="ph-duotone ph-target text-5xl mb-3 opacity-30 text-white"></i><p class="text-sm font-medium tracking-wide">Select a task to focus</p></div>
<div id="focus-active" class="hidden animate-fade-in w-full flex flex-col items-center">
<div class="inline-flex items-center justify-center px-3 py-1 rounded-full bg-oled-highlight border border-oled-border text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-4 font-display"><i class="ph-fill ph-hash mr-1.5 text-purple-500"></i> <span id="focus-project-badge" class="truncate max-w-[200px]">Project</span></div>
<h2 id="focus-task-title" class="text-2xl font-bold text-white leading-snug mb-3 line-clamp-2 px-2 font-display">Task Title</h2>
<div class="flex items-center space-x-2 text-xs text-gray-400 bg-oled-highlight px-4 py-1.5 rounded-full border border-oled-border font-display"><span class="text-purple-400 font-bold text-sm"><span id="focus-completed">0</span> / <span id="focus-total">4</span></span><span class="uppercase tracking-widest opacity-60 ml-1">Pomos</span></div></div></div>
<div class="relative z-10 mb-16 group flex justify-center">
<div class="relative w-72 h-72 flex items-center justify-center">
<svg class="w-full h-full transform -rotate-90 drop-shadow-[0_0_30px_rgba(168,85,247,0.15)]" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="#1a1a1a" stroke-width="3"/><circle id="timer-progress" cx="50" cy="50" r="45" fill="none" stroke="url(#gradient)" stroke-width="3" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="0" class="transition-all duration-1000 ease-linear"/><defs><linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#c084fc"/><stop offset="100%" stop-color="#e879f9"/></linearGradient></defs></svg>
<div class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer select-none" onclick="app.toggleTimer()"><div id="timer-display" class="text-[4.5rem] font-bold text-white leading-none tracking-tight font-display drop-shadow-2xl">25:00</div><div id="timer-mode" class="text-xs font-bold tracking-[0.3em] uppercase mt-4 text-purple-400/80 font-display">Focus</div></div></div></div>
<div class="flex items-center justify-center gap-12 z-10">
<button onclick="app.resetTimer()" class="w-14 h-14 rounded-full bg-oled-highlight border border-oled-border text-gray-400 hover:text-white hover:border-gray-600 flex items-center justify-center transition-all active:scale-95 shadow-lg shadow-black/50"><i class="ph-bold ph-arrow-counter-clockwise text-xl"></i></button>
<button onclick="app.toggleTimer()" id="play-btn" class="relative w-24 h-24 rounded-full flex items-center justify-center transition-transform hover:scale-105 active:scale-95 group"><div id="play-glow" class="absolute inset-0 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 blur-xl opacity-30 group-hover:opacity-60 transition-opacity duration-500"></div><div class="absolute inset-0 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center shadow-xl border border-white/10"><i class="ph-fill ph-play text-4xl text-white ml-2" id="play-icon"></i></div></button>
<button onclick="app.skipTimer()" class="w-14 h-14 rounded-full bg-oled-highlight border border-oled-border text-gray-400 hover:text-white hover:border-gray-600 flex items-center justify-center transition-all active:scale-95 shadow-lg shadow-black/50"><i class="ph-bold ph-skip-forward text-xl"></i></button></div></div>
<div id="timer-settings" class="absolute inset-0 bg-oled-surface/95 backdrop-blur z-50 hidden flex-col p-6 animate-fade-in overflow-y-auto">
<div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-white font-heading">Timer Settings</h3><button onclick="app.toggleTimerSettings()"><i class="ph-bold ph-x text-xl"></i></button></div>
<div class="space-y-6 font-display">
<div><label class="text-xs text-gray-500 uppercase font-bold mb-2 block">Focus Duration (min)</label><input type="range" min="5" max="60" step="5" value="25" class="w-full accent-purple-500 h-2 bg-oled-highlight rounded-lg appearance-none cursor-pointer" oninput="app.updateSettings('focus',this.value)"><div class="flex justify-between text-xs text-gray-400 mt-1"><span>5</span><span id="set-focus-val" class="text-white font-bold">25</span><span>60</span></div></div>
<div><label class="text-xs text-gray-500 uppercase font-bold mb-2 block">Short Break (min)</label><input type="range" min="1" max="15" step="1" value="5" class="w-full accent-blue-500 h-2 bg-oled-highlight rounded-lg appearance-none cursor-pointer" oninput="app.updateSettings('short',this.value)"><div class="flex justify-between text-xs text-gray-400 mt-1"><span>1</span><span id="set-short-val" class="text-white font-bold">5</span><span>15</span></div></div>
<div><label class="text-xs text-gray-500 uppercase font-bold mb-2 block">Long Break (min)</label><input type="range" min="10" max="45" step="5" value="15" class="w-full accent-green-500 h-2 bg-oled-highlight rounded-lg appearance-none cursor-pointer" oninput="app.updateSettings('long',this.value)"><div class="flex justify-between text-xs text-gray-400 mt-1"><span>10</span><span id="set-long-val" class="text-white font-bold">15</span><span>45</span></div></div>
<div class="flex items-center justify-between pt-4 border-t border-oled-border"><div><label class="text-sm font-bold text-white block">Strict Mode</label><p class="text-[10px] text-gray-500">Prevent stopping the timer early</p></div><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="strict-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-600 transition-all duration-300 top-[-12px]" onclick="app.updateSettings('strictMode',this.checked)"/><label for="strict-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-800 cursor-pointer border border-gray-700 top-[-12px] relative"></label></div></div></div></div><audio id="audio-player" loop></audio></aside>
<div id="add-task-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-end md:items-center justify-center md:p-4 opacity-0 transition-opacity duration-200">
<div class="bg-oled-surface border border-oled-border w-full h-full md:h-auto md:max-h-[90vh] md:max-w-lg md:rounded-2xl shadow-2xl overflow-hidden transform transition-transform duration-200 flex flex-col" id="add-task-panel">
<form id="add-task-form" onsubmit="app.handleSaveTask(event)" class="flex flex-col flex-1 min-h-0">
<div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
<div class="flex justify-between items-center mb-6"><h2 class="text-lg font-semibold text-white font-heading" id="modal-title">New Task</h2><button type="button" onclick="app.toggleAddTaskModal()" class="text-gray-400 hover:text-white"><i class="ph-bold ph-x text-xl"></i></button></div>
<input type="text" id="task-title" placeholder="I want to..." class="w-full bg-transparent text-2xl font-medium text-white placeholder-gray-600 border-none outline-none mb-6 font-heading" required autocomplete="off">
<textarea id="task-note" placeholder="Add a note or description..." class="w-full bg-oled-highlight text-sm text-gray-300 placeholder-gray-600 border border-transparent focus:border-white/10 rounded-lg p-3 outline-none resize-none h-20 mb-6 transition-colors"></textarea>
<div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide font-display">Subtasks</label><div id="subtasks-container" class="space-y-2 mb-2"></div><button type="button" onclick="app.addSubtaskUI()" class="text-xs text-purple-400 hover:text-purple-300 font-medium flex items-center"><i class="ph-bold ph-plus mr-1"></i> Add Step</button></div>
<div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide font-display">Tags</label><input type="text" id="task-tags" placeholder="e.g. Work, Urgent, Design (comma separated)" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-3 py-2 outline-none focus:border-purple-500 transition-colors text-sm font-sans"></div>
<div class="grid grid-cols-2 gap-4 mb-2 font-display">
<div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Est. Pomos</label><div class="flex items-center space-x-2 bg-oled-highlight rounded-lg p-1 border border-oled-border h-[42px]"><button type="button" onclick="app.adjustEst(-1)" class="w-8 h-full rounded bg-transparent hover:bg-white/10 text-white flex items-center justify-center transition-colors"><i class="ph-bold ph-minus"></i></button><span id="est-display" class="text-white font-mono flex-1 text-center font-bold">1</span><button type="button" onclick="app.adjustEst(1)" class="w-8 h-full rounded bg-transparent hover:bg-white/10 text-white flex items-center justify-center transition-colors"><i class="ph-bold ph-plus"></i></button></div></div>
<div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Time per Pomo (min)</label><input type="number" id="task-pomo-duration" value="25" min="1" max="120" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-3 outline-none focus:border-purple-500 transition-colors h-[42px] text-sm text-center font-mono"></div></div>
<div class="mb-6 text-center"><p class="text-[11px] text-gray-500 font-display">Total Estimated Focus Time: <span id="total-est-time-display" class="text-purple-400 font-bold">25m</span></p></div>
<div class="grid grid-cols-2 gap-4 mb-2 font-display">
<div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Priority</label><div class="relative" id="priority-dropdown"><button type="button" onclick="app.toggleDropdown('priority')" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-3 flex items-center justify-between outline-none focus:border-purple-500 transition-colors text-sm h-[42px]"><span id="selected-priority">None</span><i class="ph-bold ph-caret-down text-gray-400"></i></button><div id="priority-options" class="absolute left-0 right-0 top-full mt-1 bg-oled-surface border border-oled-border rounded-lg shadow-xl z-20 hidden overflow-hidden"><button type="button" onclick="app.selectOption('priority','none','None')" class="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-oled-highlight hover:text-white transition-colors">None</button><button type="button" onclick="app.selectOption('priority','high','High Priority (!)')" class="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-oled-highlight transition-colors">High Priority (!)</button><button type="button" onclick="app.selectOption('priority','med','Medium Priority')" class="w-full text-left px-3 py-2 text-sm text-yellow-400 hover:bg-oled-highlight transition-colors">Medium Priority</button><button type="button" onclick="app.selectOption('priority','low','Low Priority')" class="w-full text-left px-3 py-2 text-sm text-blue-400 hover:bg-oled-highlight transition-colors">Low Priority</button></div><input type="hidden" id="task-priority" value="none"></div></div>
<div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Due Date</label><input type="date" id="task-date" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-2 outline-none focus:border-purple-500 transition-colors h-[42px] text-sm font-sans"></div></div>
<div class="mb-6 font-display"><label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Project / List</label><div class="relative" id="project-dropdown"><button type="button" onclick="app.toggleDropdown('project')" class="w-full bg-oled-highlight border border-oled-border text-white rounded-lg px-3 flex items-center justify-between outline-none focus:border-purple-500 transition-colors text-sm h-[42px]"><span id="selected-project" class="truncate">Inbox</span><i class="ph-bold ph-caret-down text-gray-400 shrink-0 ml-2"></i></button><div id="project-options" class="absolute left-0 right-0 top-full mt-1 bg-oled-surface border border-oled-border rounded-lg shadow-xl z-20 hidden max-h-48 overflow-y-auto custom-scrollbar"></div><input type="hidden" id="task-project" value="Inbox"></div></div></div>
<div class="bg-oled-surface p-4 flex justify-between border-t border-oled-border mt-auto shrink-0"><button type="button" onclick="app.toggleAddTaskModal()" class="text-gray-400 hover:text-white font-medium text-sm transition-colors md:hidden">Cancel</button><button type="submit" id="save-task-btn" class="bg-white text-black hover:bg-gray-200 px-8 py-2.5 rounded-xl font-bold shadow-[0_0_15px_rgba(255,255,255,0.1)] transition-transform active:scale-95 font-display ml-auto">Save Task</button></div></form></div></div>
<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';import{getAuth,onAuthStateChanged,signOut}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';import{getFirestore,collection,addDoc,updateDoc,deleteDoc,doc,setDoc,onSnapshot,query,where,getDocs,writeBatch,orderBy,serverTimestamp}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
const C={apiKey:"AIzaSyDkKhb8m0znWyC2amv6uGpA8KmbkuW-j1U",authDomain:"timetrekker-app.firebaseapp.com",projectId:"timetrekker-app",storageBucket:"timetrekker-app.firebasestorage.app",messagingSenderId:"83185163190",appId:"1:83185163190:web:e2974c5d0f0274fe5e3f17",measurementId:"G-FLZ02E1Y5L"},appId='timetrekker-v1',fb=initializeApp(C),auth=getAuth(fb),db=getFirestore(fb),D=document,$=id=>D.getElementById(id);
const state={user:null,tasks:[],logs:[],projects:new Set(['Inbox','Work','Personal','Study']),view:'today',filterProject:null,selectedTaskId:null,editingTaskId:null,timer:{mode:'focus',status:'idle',endTime:null,remaining:1500,totalDuration:1500,activeTaskId:null,interval:null,settings:{focus:25,short:5,long:15,strictMode:false}},newEst:1,sound:'none',charts:{activity:null,project:null}};
const sounds={none:'',rain:'https://cdn.pixabay.com/download/audio/2022/03/24/audio_03d973dfd3.mp3?filename=rain-112232.mp3',cafe:'https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3?filename=cafe-ambience-6404.mp3',forest:'https://cdn.pixabay.com/download/audio/2021/09/06/audio_4488354c46.mp3?filename=forest-wind-and-birds-6869.mp3'};
const els={taskList:$('task-list'),taskViewContainer:$('task-view-container'),analyticsViewContainer:$('analytics-view-container'),pageTitle:$('page-title'),emptyState:$('empty-state'),modal:$('add-task-modal'),modalPanel:$('add-task-panel'),modalTitle:$('modal-title'),saveTaskBtn:$('save-task-btn'),estDisplay:$('est-display'),pomoDurationInput:$('task-pomo-duration'),totalEstTimeDisplay:$('total-est-time-display'),dateInput:$('task-date'),timerDisplay:$('timer-display'),timerProgress:$('timer-progress'),timerMode:$('timer-mode'),playIcon:$('play-icon'),playGlow:$('play-glow'),timerBgGlow:$('timer-bg-glow'),focusActive:$('focus-active'),focusEmpty:$('focus-empty'),focusTitle:$('focus-task-title'),focusProject:$('focus-project-badge'),focusCompleted:$('focus-completed'),focusTotal:$('focus-total'),timerPanel:$('timer-panel'),navCounts:{today:$('count-today'),tomorrow:$('count-tomorrow'),upcoming:$('count-upcoming'),past:$('count-past')},stats:{pomosToday:$('stat-pomos-today'),tasksToday:$('stat-tasks-today'),estRemain:$('stat-est-remaining'),focusTime:$('stat-focus-time')},analytics:{totalTime:$('ana-total-time'),streak:$('ana-streak'),dailyAvg:$('ana-daily-avg'),activityChart:$('activityChart'),projectChart:$('projectChart'),heatmap:$('heatmap-grid')},projectList:$('project-list'),subtasksContainer:$('subtasks-container'),audio:$('audio-player'),timerSettings:$('timer-settings'),currentDate:$('current-date-display'),sidebarOverlay:$('sidebar-overlay'),sidebar:$('sidebar'),headerActions:$('header-actions')};
Chart.defaults.color='#9ca3af';Chart.defaults.font.family='Poppins';
onAuthStateChanged(auth,u=>{if(u){state.user=u;const p=$('user-profile-display');if(p){p.classList.remove('hidden');p.classList.add('flex');$('user-name-text').innerText=u.displayName||u.email.split('@')[0];$('user-email-text').innerText=u.email;$('user-avatar-initials').innerText=(u.displayName||u.email).charAt(0).toUpperCase()}subTasks(u.uid);subLogs(u.uid);subTimer(u.uid);els.currentDate.innerText=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}else window.location.href='https://stack-base.github.io/account/login.html?redirectUrl=https://stack-base.github.io/timetrekker/application'});
const subTasks=uid=>onSnapshot(collection(db,'artifacts',appId,'users',uid,'tasks'),s=>{const t=[],p=new Set(['Inbox','Work','Personal','Study']);s.forEach(d=>{const x=d.data();t.push({id:d.id,...x});if(x.project&&x.project!=='Inbox')p.add(x.project)});state.tasks=t;state.projects=p;updateProjectsUI();updateCounts();renderTasks();if(state.timer.activeTaskId){updateTimerUI(t.find(x=>x.id===state.timer.activeTaskId))}});
const subTimer=uid=>onSnapshot(doc(db,'artifacts',appId,'users',uid,'timer','active'),s=>{if(s.exists()){const d=s.data();state.timer={...state.timer,status:d.status||'idle',mode:d.mode||'focus',endTime:d.endTime?d.endTime.toMillis():null,remaining:d.remaining||state.timer.settings[d.mode||'focus']*60,totalDuration:d.totalDuration||state.timer.settings[d.mode||'focus']*60,activeTaskId:d.taskId||null};app.setTimerModeUI(state.timer.mode);if(state.timer.activeTaskId){state.selectedTaskId=state.timer.activeTaskId;updateTimerUI(state.tasks.find(x=>x.id===state.timer.activeTaskId))}else updateTimerUI(null);if(state.timer.status==='running'){startLocalInterval();updateTimerVisuals();if(state.sound!=='none'&&els.audio.paused)els.audio.play().catch(e=>{})}else{stopLocalInterval();updateTimerVisuals();if(!els.audio.paused)els.audio.pause()}}else app.resetTimer(true)});
const startLocalInterval=()=>{if(state.timer.interval)clearInterval(state.timer.interval);state.timer.interval=setInterval(()=>{updateTimerVisuals();if(state.timer.status==='running'&&state.timer.endTime&&Date.now()>=state.timer.endTime)app.completeTimer()},100);els.playIcon.className="ph-fill ph-pause text-4xl text-white";if(els.playGlow)els.playGlow.classList.add('animate-pulse');if(els.timerBgGlow)els.timerBgGlow.classList.add('animate-breathe')};
const stopLocalInterval=()=>{if(state.timer.interval)clearInterval(state.timer.interval);state.timer.interval=null;els.playIcon.className="ph-fill ph-play text-4xl text-white ml-2";if(els.playGlow)els.playGlow.classList.remove('animate-pulse');if(els.timerBgGlow)els.timerBgGlow.classList.remove('animate-breathe')};
const updateTimerVisuals=()=>{const{status,endTime,remaining,totalDuration}=state.timer;const s=status==='running'&&endTime?Math.max(0,Math.ceil((endTime-Date.now())/1000)):remaining;const m=Math.floor(s/60),sc=s%60;els.timerDisplay.innerText=`${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;els.timerProgress.style.strokeDashoffset=283*(1-(s/(totalDuration||1)));D.title=`${m}:${sc.toString().padStart(2,'0')} - TimeTrekker`};
const subLogs=uid=>onSnapshot(query(collection(db,'artifacts',appId,'users',uid,'focus_sessions'),orderBy('completedAt','desc')),s=>{const l=[];s.forEach(d=>l.push({id:d.id,...d.data()}));state.logs=l;if(state.view==='analytics')updateAnalytics()});
const app={
customPrompt:{resolve:null,el:$('custom-prompt-modal'),input:$('prompt-input'),title:$('prompt-title')},
showPrompt:(t,v='')=>new Promise(r=>{const p=app.customPrompt;p.resolve=r;p.title.innerText=t;p.input.value=v;p.el.classList.remove('hidden');setTimeout(()=>p.el.classList.remove('opacity-0'),10);p.input.focus()}),
closePrompt:v=>{const p=app.customPrompt;p.el.classList.add('opacity-0');setTimeout(()=>{p.el.classList.add('hidden');if(p.resolve)p.resolve(v);p.resolve=null},200)},
setView:v=>{state.view=v;state.filterProject=null;els.pageTitle.innerText=v.charAt(0).toUpperCase()+v.slice(1);updateNavStyles(v);app.toggleSidebar(false);if(v==='analytics'){els.taskViewContainer.classList.add('hidden');els.analyticsViewContainer.classList.remove('hidden');els.headerActions.classList.add('invisible');updateAnalytics()}else{els.taskViewContainer.classList.remove('hidden');els.analyticsViewContainer.classList.add('hidden');els.headerActions.classList.remove('invisible');renderTasks()}},
setProjectView:p=>{state.view='project';state.filterProject=p;els.pageTitle.innerText=p;updateNavStyles('project',p);app.toggleSidebar(false);els.taskViewContainer.classList.remove('hidden');els.analyticsViewContainer.classList.add('hidden');els.headerActions.classList.remove('invisible');renderTasks()},
toggleFocusPanel:f=>{const p=els.timerPanel,i=!p.classList.contains('translate-x-full');(f!==null?f:!i)?p.classList.remove('translate-x-full'):p.classList.add('translate-x-full')},
toggleSidebar:f=>{const s=els.sidebar,o=els.sidebarOverlay,h=s.classList.contains('-translate-x-full');if(f!==null?f:h){s.classList.remove('-translate-x-full');o.classList.remove('hidden');requestAnimationFrame(()=>o.classList.remove('opacity-0'))}else{s.classList.add('-translate-x-full');o.classList.add('opacity-0');setTimeout(()=>o.classList.add('hidden'),300)}},
promptNewProject:async()=>{const n=await app.showPrompt("Enter project name:");if(n){state.projects.add(n);updateProjectsUI()}},
renameProject:async(o,e)=>{e.stopPropagation();const n=await app.showPrompt(`Rename "${o}" to:`,o);if(!n||n===o||!state.user)return;try{const b=writeBatch(db);(await getDocs(query(collection(db,'artifacts',appId,'users',state.user.uid,'tasks'),where("project","==",o)))).forEach(d=>b.update(d.ref,{project:n}));await b.commit();state.projects.delete(o);state.projects.add(n);state.filterProject===o?app.setProjectView(n):updateProjectsUI()}catch(err){app.showToast("Failed rename")}},
deleteProject:async(p,e)=>{e.stopPropagation();if(!confirm(`Delete "${p}"? Tasks move to Inbox.`)||!state.user)return;try{const b=writeBatch(db);(await getDocs(query(collection(db,'artifacts',appId,'users',state.user.uid,'tasks'),where("project","==",p)))).forEach(d=>b.update(d.ref,{project:'Inbox'}));await b.commit();state.projects.delete(p);state.filterProject===p?app.setView('today'):updateProjectsUI()}catch(err){app.showToast("Failed delete")}},
addSubtaskUI:(v='')=>{const d=D.createElement('div');d.className='flex items-center space-x-2 animate-fade-in';d.innerHTML=`<div class="w-1.5 h-1.5 rounded-full bg-purple-500 shrink-0"></div><input type="text" class="subtask-input flex-1 bg-transparent border-b border-oled-border focus:border-purple-500 text-sm text-white py-1 outline-none transition-colors" placeholder="Step description" value="${v}"><button type="button" onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-400"><i class="ph-bold ph-x"></i></button>`;els.subtasksContainer.appendChild(d)},
toggleDropdown:t=>{const d=$(`${t}-options`);D.querySelectorAll('[id$="-options"]').forEach(x=>{if(x.id!==`${t}-options`)x.classList.add('hidden')});if(d.classList.contains('hidden')){d.classList.remove('hidden');d.classList.add('animate-fade-in')}else d.classList.add('hidden')},
selectOption:(t,v,d)=>{$(`selected-${t}`).innerText=d;$(`task-${t}`).value=v;$(`${t}-options`).classList.add('hidden')},
toggleAddTaskModal:(t=null)=>{if(els.modal.classList.contains('hidden')){els.subtasksContainer.innerHTML='';const po=$('project-options');po.innerHTML='';state.projects.forEach(p=>{const b=D.createElement('button');b.type='button';b.onclick=()=>app.selectOption('project',p,p);b.className="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-oled-highlight hover:text-white transition-colors flex items-center";b.innerHTML=`<i class="ph-bold ph-folder mr-2 text-gray-500"></i> ${p}`;po.appendChild(b)});if(t){state.editingTaskId=t.id;els.modalTitle.innerText="Edit Task";els.saveTaskBtn.innerText="Update Task";$('task-title').value=t.title;$('task-note').value=t.note||'';$('task-tags').value=t.tags?t.tags.join(', '):'';state.newEst=t.estimatedPomos||1;els.estDisplay.innerText=state.newEst;els.pomoDurationInput.value=t.pomoDuration||25;els.dateInput.value=t.dueDate||'';const pm={none:'None',high:'High Priority (!)',med:'Medium Priority',low:'Low Priority'};app.selectOption('priority',t.priority||'none',pm[t.priority||'none']);app.selectOption('project',t.project||'Inbox',t.project||'Inbox');if(t.subtasks)t.subtasks.forEach(s=>app.addSubtaskUI(s))}else{state.editingTaskId=null;els.modalTitle.innerText="New Task";els.saveTaskBtn.innerText="Save Task";state.newEst=1;els.estDisplay.innerText="1";els.pomoDurationInput.value=25;els.dateInput.value=new Date().toISOString().split('T')[0];$('task-title').value='';$('task-note').value='';$('task-tags').value='';app.selectOption('priority','none','None');app.selectOption('project','Inbox','Inbox')}app.updateTotalEstDisplay();els.modal.classList.remove('hidden');setTimeout(()=>els.modal.classList.remove('opacity-0'),10);setTimeout(()=>els.modalPanel.classList.replace('scale-95','scale-100'),10);$('task-title').focus()}else{els.modal.classList.add('opacity-0');els.modalPanel.classList.replace('scale-100','scale-95');setTimeout(()=>els.modal.classList.add('hidden'),200)}},
adjustEst:d=>{let v=state.newEst+d;if(v<1)v=1;if(v>50)v=50;state.newEst=v;els.estDisplay.innerText=v;app.updateTotalEstDisplay()},
updateTotalEstDisplay:()=>{const d=parseInt(els.pomoDurationInput.value)||25,t=state.newEst*d,h=Math.floor(t/60);els.totalEstTimeDisplay.innerText=h>0?`${h}h ${t%60}m`:`${t}m`},
editTask:(id,e)=>{e.stopPropagation();const t=state.tasks.find(x=>x.id===id);if(t)app.toggleAddTaskModal(t)},
handleSaveTask:async e=>{e.preventDefault();const title=$('task-title').value;if(!title)return;const subtasks=Array.from(D.querySelectorAll('.subtask-input')).map(i=>i.value.trim()).filter(v=>v),tags=$('task-tags').value.split(',').map(t=>t.trim()).filter(t=>t),data={title,dueDate:els.dateInput.value,estimatedPomos:state.newEst,pomoDuration:parseInt(els.pomoDurationInput.value)||25,priority:$('task-priority').value,project:$('task-project').value,note:$('task-note').value,subtasks,tags};const ref=collection(db,'artifacts',appId,'users',state.user.uid,'tasks');state.editingTaskId?await updateDoc(doc(ref,state.editingTaskId),data):await addDoc(ref,{...data,completedPomos:0,status:'todo',createdAt:new Date().toISOString()});app.toggleAddTaskModal()},
toggleTaskStatus:async(id,s)=>await updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'tasks',id),{status:s==='todo'?'done':'todo'}),
deleteTask:async(id,e)=>{e.stopPropagation();if(confirm('Delete task?'))await deleteDoc(doc(db,'artifacts',appId,'users',state.user.uid,'tasks',id))},
startTask:async(id,e)=>{e.stopPropagation();const t=state.tasks.find(x=>x.id===id);if(!t)return;state.selectedTaskId=id;renderTasks();updateTimerUI(t);if(window.innerWidth<1280)app.toggleFocusPanel(true);if(state.timer.status!=='running'){const d=t.pomoDuration||25;await setDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'running',mode:'focus',taskId:id,remaining:d*60,totalDuration:d*60,endTime:new Date(Date.now()+d*60000)});app.updateSettings('focus',d)}},
selectTask:id=>{state.selectedTaskId=id;renderTasks();const t=state.tasks.find(x=>x.id===id);updateTimerUI(t);if(state.timer.status!=='running')updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{taskId:id}).catch(()=>{});if(window.innerWidth<1280)app.toggleFocusPanel(true)},
showToast:(m,t='error')=>{const c=$('toast-container'),e=D.createElement('div');e.className=`px-4 py-2 rounded-lg text-white text-sm font-medium shadow-lg animate-fade-in ${t==='error'?'bg-red-500/90':'bg-green-500/90'} backdrop-blur-sm pointer-events-auto`;e.innerText=m;c.appendChild(e);setTimeout(()=>{e.classList.replace('animate-fade-in','animate-fade-out');setTimeout(()=>e.remove(),300)},3000)},
toggleTimer:async()=>{if(Notification.permission==='default')try{await Notification.requestPermission()}catch(e){}if(Notification.permission==='denied')app.showToast("Enable notifications!","error");if(state.timer.status==='running'){if(state.timer.settings.strictMode&&state.timer.mode==='focus'&&!confirm("Strict Mode active! Quit?"))return;await updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'paused',endTime:null,remaining:Math.max(0,Math.ceil((state.timer.endTime-Date.now())/1000))})}else{if(!state.timer.activeTaskId&&state.timer.mode==='focus'){app.showToast("Select task!","error");return}await updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'running',endTime:new Date(Date.now()+state.timer.remaining*1000)})}},
resetTimer:async(r=false)=>{if(!r){const d=state.timer.settings[state.timer.mode];await setDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'idle',endTime:null,remaining:d*60,totalDuration:d*60,mode:state.timer.mode,taskId:state.timer.activeTaskId||null})}},
skipTimer:()=>app.completeTimer(),
completeTimer:async()=>{if(state.timer.status==='idle')return;stopLocalInterval();const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator();o.connect(c.destination);o.frequency.value=523.25;o.start();o.stop(c.currentTime+.2);try{if(Notification.permission==='granted')new Notification(state.timer.mode==='focus'?"Focus Complete!":"Break Over!",{icon:"https://stack-base.github.io/media/brand/stackbase/stackbase-icon.png"});else if(Notification.permission!=='denied')Notification.requestPermission().then(p=>{if(p==='granted')new Notification("Timer Complete")})}catch(e){}if(state.timer.mode==='focus'){if(state.timer.activeTaskId){const t=state.tasks.find(x=>x.id===state.timer.activeTaskId);if(t){await updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'tasks',t.id),{completedPomos:(t.completedPomos||0)+1});await addDoc(collection(db,'artifacts',appId,'users',state.user.uid,'focus_sessions'),{taskId:t.id,taskTitle:t.title,project:t.project||'Inbox',duration:state.timer.totalDuration/60,completedAt:serverTimestamp()})}}app.setTimerMode('short')}else app.setTimerMode('focus')},
setTimerMode:async m=>{const v=state.timer.settings[m];await setDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'idle',mode:m,remaining:v*60,totalDuration:v*60,endTime:null,taskId:state.timer.activeTaskId||null})},
setTimerModeUI:m=>{els.timerMode.innerText=m==='focus'?'Focus Mode':m==='short'?'Short Break':'Long Break';els.timerMode.className=`text-xs font-bold tracking-[0.2em] uppercase mt-3 ${m==='focus'?'text-purple-300':'text-blue-300'}`},
setSound:t=>{state.sound=t;els.audio.src=sounds[t];D.querySelectorAll('.sound-option').forEach(b=>b.className=b.className.replace('text-purple-400','text-gray-500'));const a=$(`sound-${t}`);if(a)a.className=a.className.replace('text-gray-500','text-purple-400');t==='none'?els.audio.pause():(state.timer.status==='running'&&els.audio.play())},
toggleTimerSettings:()=>{els.timerSettings.classList.toggle('hidden');els.timerSettings.classList.toggle('flex')},
updateSettings:(k,v)=>{if(k==='strictMode')state.timer.settings[k]=v;else{state.timer.settings[k]=parseInt(v);$(`set-${k}-val`).innerText=v}},
signOut:()=>signOut(auth).then(()=>window.location.href='https://stack-base.github.io/account/login.html?redirectUrl=https://stack-base.github.io/timetrekker/application')
};
window.app=app;
function updateAnalytics(){if(!state.logs.length)return;const totalMins=state.logs.reduce((a,l)=>a+(l.duration||25),0);els.analytics.totalTime.innerText=`${Math.floor(totalMins/60)}h ${Math.round(totalMins%60)}m`;const dates=[...new Set(state.logs.map(l=>l.completedAt?new Date(l.completedAt.seconds*1000).toDateString():''))].filter(d=>d).sort((a,b)=>new Date(b)-new Date(a));let streak=0;if(dates.length>0){const t=new Date().toDateString(),y=new Date(Date.now()-86400000).toDateString();if(dates[0]===t||dates[0]===y){streak=1;let c=new Date(dates[0]);for(let i=1;i<dates.length;i++){let p=new Date(dates[i]);if((c-p)/(864e5)<=1.5){streak++;c=p}else break}}}els.analytics.streak.innerText=`${streak} Days`;const d30=new Date();d30.setDate(d30.getDate()-30);const r=state.logs.filter(l=>l.completedAt&&new Date(l.completedAt.seconds*1000)>d30),avg=r.length>0?(r.reduce((a,b)=>a+(b.duration||25),0)/30):0;els.analytics.dailyAvg.innerText=`${Math.floor(avg/60)}h ${Math.round(avg%60)}m`;const days=[],dp=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days.push(d.toLocaleDateString('en-US',{weekday:'short'}));const s=new Date(d.setHours(0,0,0,0)),e=new Date(d.setHours(23,59,59,999)),dm=state.logs.filter(l=>{if(!l.completedAt)return!1;const t=new Date(l.completedAt.seconds*1000);return t>=s&&t<=e}).reduce((a,b)=>a+(b.duration||25),0);dp.push((dm/60).toFixed(1))}if(state.charts.activity)state.charts.activity.destroy();const ctx=els.analytics.activityChart.getContext('2d'),g=ctx.createLinearGradient(0,0,0,300);g.addColorStop(0,'rgba(168,85,247,0.5)');g.addColorStop(1,'rgba(168,85,247,0)');state.charts.activity=new Chart(ctx,{type:'line',data:{labels:days,datasets:[{label:'Focus Hours',data:dp,borderColor:'#a855f7',backgroundColor:g,borderWidth:2,pointBackgroundColor:'#1f2937',pointBorderColor:'#a855f7',fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,grid:{color:'#2a2a2a'},ticks:{color:'#6b7280'}},x:{grid:{display:!1},ticks:{color:'#6b7280'}}},plugins:{legend:{display:!1}}}});const pm={};state.logs.forEach(l=>{const p=l.project||'Other';pm[p]=(pm[p]||0)+(l.duration||25)});const pl=Object.keys(pm),pd=Object.values(pm).map(m=>(m/60).toFixed(1));if(pl.length===0)$('no-data-project').classList.remove('hidden');else{$('no-data-project').classList.add('hidden');if(state.charts.project)state.charts.project.destroy();state.charts.project=new Chart(els.analytics.projectChart.getContext('2d'),{type:'doughnut',data:{labels:pl,datasets:[{data:pd,backgroundColor:['#a855f7','#ec4899','#3b82f6','#eab308','#ef4444','#10b981'],borderWidth:0,hoverOffset:4}]},options:{responsive:!0,cutout:'70%',plugins:{legend:{position:'right',labels:{color:'#9ca3af',font:{size:10}}}}}})}const hg=els.analytics.heatmap;hg.innerHTML='';const hd=Array(7).fill(0).map(()=>Array(24).fill(0));state.logs.forEach(l=>{if(!l.completedAt)return;const d=new Date(l.completedAt.seconds*1000);hd[d.getDay()][d.getHours()]++});let max=0;hd.forEach(r=>r.forEach(c=>{if(c>max)max=c}));hg.className="grid grid-rows-7 grid-cols-24 gap-1 w-full h-full";const ds=['S','M','T','W','T','F','S'];for(let d=0;d<7;d++)for(let h=0;h<24;h++){const v=hd[d][h],div=D.createElement('div');div.style.backgroundColor=`rgba(168,85,247,${Math.max(0.1,max>0?v/max:0)})`;div.className="rounded-sm w-full h-full";if(v>0)div.title=`${ds[d]} @ ${h}:00 - ${v} sessions`;hg.appendChild(div)}}
$('prompt-cancel-btn').addEventListener('click',()=>app.closePrompt(null));$('prompt-confirm-btn').addEventListener('click',()=>app.closePrompt(app.customPrompt.input.value));$('prompt-input').addEventListener('keypress',e=>{if(e.key==='Enter')app.closePrompt(app.customPrompt.input.value)});D.addEventListener('click',e=>{if(!e.target.closest('#project-dropdown')&&!e.target.closest('#priority-dropdown')){D.getElementById('project-options').classList.add('hidden');D.getElementById('priority-options').classList.add('hidden')}});els.pomoDurationInput.addEventListener('input',app.updateTotalEstDisplay);
function updateNavStyles(v,p){D.querySelectorAll('.nav-btn').forEach(b=>{const i=b.id===`nav-${v}`;b.classList.toggle('bg-oled-highlight',i);b.classList.toggle('text-white',i);b.classList.toggle('border',i);b.classList.toggle('border-oled-border',i);b.classList.toggle('text-gray-400',!i);b.classList.toggle('hover:bg-oled-highlight',!i)});D.querySelectorAll('.project-btn').forEach(b=>{const i=v==='project'&&b.dataset.proj===p;b.classList.toggle('text-white',i);b.classList.toggle('bg-oled-highlight',i);b.classList.toggle('text-gray-400',!i);b.classList.toggle('hover:bg-oled-highlight',!i)})}
function updateProjectsUI(){els.projectList.innerHTML='';state.projects.forEach(p=>{const d=D.createElement('div');d.innerHTML=`<div class="group relative flex items-center"><button onclick="app.setProjectView('${p}')" data-proj="${p}" class="project-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-oled-highlight transition-colors text-sm group shrink-0 font-display"><div class="flex items-center min-w-0"><i class="ph-bold ph-hash mr-3 opacity-50 shrink-0"></i><span class="truncate">${p}</span></div></button><div class="absolute right-2 flex opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="app.renameProject('${p}', event)" class="text-gray-500 hover:text-white p-1"><i class="ph-bold ph-pencil-simple"></i></button><button onclick="app.deleteProject('${p}', event)" class="text-gray-500 hover:text-red-400 p-1 ml-1"><i class="ph-bold ph-trash"></i></button></div></div>`;els.projectList.appendChild(d)})}
function updateCounts(){const t=new Date().toISOString().split('T')[0],tm=new Date(Date.now()+864e5).toISOString().split('T')[0];els.navCounts.today.innerText=state.tasks.filter(x=>x.dueDate===t&&x.status==='todo').length;els.navCounts.tomorrow.innerText=state.tasks.filter(x=>x.dueDate===tm&&x.status==='todo').length;els.navCounts.upcoming.innerText=state.tasks.filter(x=>x.dueDate>tm&&x.status==='todo').length;els.navCounts.past.innerText=state.tasks.filter(x=>x.dueDate<t&&x.status==='todo').length;const tp=state.tasks.reduce((a,b)=>a+(b.completedPomos||0),0);els.stats.pomosToday.innerText=tp;els.stats.tasksToday.innerText=state.tasks.filter(x=>x.status==='done'&&x.dueDate===t).length;els.stats.estRemain.innerText=state.tasks.filter(x=>x.status==='todo').reduce((a,b)=>a+(parseInt(b.estimatedPomos)||0),0);const fm=tp*state.timer.settings.focus;els.stats.focusTime.innerText=`${Math.floor(fm/60)}h ${fm%60}m`}
function renderTasks(){const t=new Date().toISOString().split('T')[0],tm=new Date(Date.now()+864e5).toISOString().split('T')[0];let l=[];if(state.view==='today')l=state.tasks.filter(x=>x.dueDate===t&&x.status==='todo');else if(state.view==='tomorrow')l=state.tasks.filter(x=>x.dueDate===tm&&x.status==='todo');else if(state.view==='upcoming')l=state.tasks.filter(x=>x.dueDate>tm&&x.status==='todo');else if(state.view==='past')l=state.tasks.filter(x=>x.dueDate<t&&x.status==='todo');else if(state.view==='completed')l=state.tasks.filter(x=>x.status==='done');else if(state.view==='project')l=state.tasks.filter(x=>x.project===state.filterProject&&x.status==='todo');const pm={high:3,med:2,low:1,none:0};l.sort((a,b)=>pm[b.priority]-pm[a.priority]);els.taskList.innerHTML='';if(l.length===0)els.emptyState.classList.remove('hidden');else els.emptyState.classList.add('hidden');l.forEach(x=>{const isSel=x.id===state.selectedTaskId,pc=Math.min(100,((x.completedPomos||0)/(x.estimatedPomos||1))*100),col={high:'text-red-500',med:'text-yellow-500',low:'text-blue-500',none:'text-gray-600'}[x.priority||'none'],bcol={high:'border-red-500',med:'border-yellow-500',low:'border-blue-500',none:'border-gray-600'}[x.priority||'none'],sty=isSel?{high:'border-red-500/50 bg-red-500/5 shadow-[0_0_30px_-5px_rgba(239,68,68,0.2)] scale-[1.01] z-10',med:'border-yellow-500/50 bg-yellow-500/5 shadow-[0_0_30px_-5px_rgba(234,179,8,0.2)] scale-[1.01] z-10',low:'border-blue-500/50 bg-blue-500/5 shadow-[0_0_30px_-5px_rgba(59,130,246,0.2)] scale-[1.01] z-10',none:'border-gray-500/50 bg-gray-500/5 shadow-[0_0_30px_-5px_rgba(107,114,128,0.2)] scale-[1.01] z-10'}[x.priority||'none']:'bg-oled-surface border-oled-border hover:bg-oled-highlight hover:border-oled-border scale-100',el=D.createElement('div');el.className=`group flex items-start p-4 rounded-xl border transition-all duration-300 ease-out cursor-pointer relative overflow-hidden ${sty}`;el.onclick=()=>app.selectTask(x.id);const d=x.pomoDuration||25,cm=(x.completedPomos||0)*d,rm=((x.estimatedPomos||1)-(x.completedPomos||0))*d;el.innerHTML=`<div class="absolute left-0 top-0 bottom-0 w-1 ${x.priority==='high'?'bg-red-500':x.priority==='med'?'bg-yellow-500':'bg-transparent'}"></div><label class="custom-checkbox flex-shrink-0 mt-0.5 w-6 h-6 mr-4 cursor-pointer relative z-10" onclick="event.stopPropagation()"><input type="checkbox" class="hidden" ${x.status==='done'?'checked':''} onchange="app.toggleTaskStatus('${x.id}','${x.status}')"><div class="w-5 h-5 border-2 ${bcol} rounded-md flex items-center justify-center transition-all hover:border-purple-400 bg-oled-surface"><svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div></label><div class="flex-1 min-w-0 pr-24"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-200 truncate ${x.status==='done'?'line-through text-gray-500':''} font-heading">${x.title}</h3><div class="flex items-center shrink-0">${x.priority!=='none'?`<i class="ph-fill ph-flag ${col} text-xs ml-2"></i>`:''}</div></div>${x.note?`<p class="text-xs text-gray-500 line-clamp-1 mt-0.5 truncate font-display">${x.note}</p>`:''}${x.subtasks&&x.subtasks.length>0?`<div class="flex items-center text-xs text-gray-500 mt-1"><i class="ph-bold ph-list-checks mr-1"></i><span>${x.subtasks.length} subtasks</span></div>`:''}${x.tags&&x.tags.length?`<div class="flex flex-wrap gap-1 mt-2">${x.tags.map(t=>`<span class="text-[10px] bg-white/5 border border-white/5 rounded px-1.5 py-0.5 text-gray-400">${t}</span>`).join('')}</div>`:''}<div class="flex items-center mt-2 space-x-3 font-display"><div class="flex items-center text-xs text-gray-400 bg-oled-highlight px-2 py-0.5 rounded border border-oled-border shrink-0"><i class="ph-fill ph-clock text-pink-500 mr-1 shrink-0"></i><span class="${pc>=100?'text-green-400':''}">${x.completedPomos||0}/${x.estimatedPomos||1}</span></div><div class="flex items-center text-xs text-gray-600 truncate"><i class="ph-bold ph-folder mr-1 shrink-0"></i><span class="truncate">${x.project}</span></div><div class="flex items-center text-[10px] text-gray-400 bg-oled-surface border border-oled-border px-3 py-1 rounded-full ml-auto whitespace-nowrap"><span>Done: ${Math.floor(cm/60)}h ${cm%60}m</span><span class="mx-1 opacity-30">|</span><span>Left: ${Math.floor(rm>0?rm/60:0)}h ${Math.max(0,rm%60)}m</span></div></div></div><div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center space-x-2 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-all z-20 bg-oled-surface p-1 rounded-lg border border-oled-border shadow-lg"><button onclick="app.startTask('${x.id}',event)" class="w-8 h-8 flex items-center justify-center text-purple-400 hover:text-white transition-colors hover:bg-white/5 rounded-md"><i class="ph-fill ph-play"></i></button><button onclick="app.editTask('${x.id}',event)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-white transition-colors hover:bg-white/5 rounded-md"><i class="ph-bold ph-pencil-simple"></i></button><button onclick="app.deleteTask('${x.id}',event)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-red-400 transition-colors hover:bg-white/5 rounded-md"><i class="ph-bold ph-trash"></i></button></div><div class="absolute bottom-0 left-0 right-0 h-px bg-white/5"><div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 opacity-30" style="width: ${pc}%"></div></div>`;els.taskList.appendChild(el)})}
function updateTimerUI(t){if(!t){els.focusEmpty.classList.remove('hidden');els.focusActive.classList.add('hidden');return}els.focusEmpty.classList.add('hidden');els.focusActive.classList.remove('hidden');els.focusTitle.innerText=t.title;els.focusProject.innerText=t.project||'Inbox';els.focusCompleted.innerText=t.completedPomos||0;els.focusTotal.innerText=t.estimatedPomos||1}
app.setView('today');
</script></body></html>