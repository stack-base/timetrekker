<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TimeTrekker</title>
<link rel="icon" href="https://stack-base.github.io/media/brand/stackbase/stackbase-icon.png" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={
  darkMode:'class',
  theme:{
    extend:{
      fontFamily:{sans:['Inter','sans-serif']},
      colors:{
        brand:{DEFAULT:'#ff5757',hover:'#e04848',dim:'#4a1a1a'},
        dark:{bg:'#181818',sidebar:'#202020',card:'#282828',border:'#333333',hover:'#383838'},
        text:{main:'#e5e7eb',muted:'#a3a3a3',faint:'#525252'},
        priority:{high:'#ef4444',med:'#eab308',low:'#3b82f6',none:'#525252'}
      }
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script src="https://unpkg.com/@phosphor-icons/web"></script>
<style>
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:#202020}
::-webkit-scrollbar-thumb{background:#404040;border-radius:4px;border:2px solid #202020}
::-webkit-scrollbar-thumb:hover{background:#505050}
body{background-color:#181818;color:#e5e7eb;font-family:'Inter',sans-serif;-webkit-font-smoothing:antialiased}
.custom-checkbox input:checked+div{background-color:#ff5757;border-color:#ff5757}
.custom-checkbox input:checked+div svg{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}.animate-fade-in{animation:fadeIn .2s ease-out forwards}
input[type=range]{-webkit-appearance:none;background:transparent}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:16px;width:16px;border-radius:50%;background:#ff5757;cursor:pointer;margin-top:-6px;box-shadow:0 1px 3px rgba(0,0,0,.3)}
input[type=range]::-webkit-slider-runnable-track{width:100%;height:4px;cursor:pointer;background:#404040;border-radius:2px}
.chart-container{position:relative;width:100%;height:100%}
/* Table Styles */
.analysis-table th { text-align:left; font-size:11px; text-transform:uppercase; color:#a3a3a3; padding:12px; border-bottom:1px solid #333; }
.analysis-table td { font-size:13px; color:#e5e7eb; padding:12px; border-bottom:1px solid #282828; }
.analysis-table tr:last-child td { border-bottom:none; }
/* Custom Global Tooltip */
#global-tooltip {
    pointer-events: none;
    position: fixed;
    z-index: 9999;
    background: rgba(32, 32, 32, 0.95);
    border: 1px solid #404040;
    backdrop-filter: blur(4px);
    padding: 8px 12px;
    border-radius: 6px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    font-size: 12px;
    color: white;
    opacity: 0;
    transition: opacity 0.1s ease;
    transform: translate(-50%, -100%) translateY(-10px);
    white-space: nowrap;
}
#global-tooltip strong { display: block; color: #ff5757; margin-bottom: 2px; font-size: 13px; }
#global-tooltip .sub { color: #a3a3a3; font-size: 11px; }

/* Apple-style Liquid Glass Toggles */
.glass-toggle-group {
    display: inline-flex;
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    padding: 4px;
    border-radius: 9999px;
    border: 1px solid rgba(255, 255, 255, 0.08);
}
.glass-toggle-btn {
    padding: 4px 12px;
    border-radius: 9999px;
    font-size: 11px;
    font-weight: 600;
    color: #a3a3a3;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid transparent;
}
.glass-toggle-btn:hover {
    color: #e5e7eb;
}
.glass-toggle-btn.active {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    border-color: rgba(255, 255, 255, 0.05);
}
</style>
</head>
<body class="h-screen w-full overflow-hidden flex bg-dark-bg text-text-main">

<div id="global-tooltip"></div>

<div id="toast-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center gap-2 pointer-events-none"></div>

<div id="custom-prompt-modal" class="fixed inset-0 bg-black/60 z-[110] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-200 backdrop-blur-sm">
    <div class="bg-dark-card border border-dark-border w-full max-w-sm rounded-lg shadow-xl p-6 transform scale-95 transition-transform duration-200">
        <h3 id="prompt-title" class="text-lg font-semibold text-white mb-4">Enter Value</h3>
        <input type="text" id="prompt-input" class="w-full bg-dark-bg border border-dark-border text-white rounded px-3 py-2 outline-none focus:border-brand transition-colors text-sm mb-6" autocomplete="off">
        <div class="flex justify-end space-x-3">
            <button id="prompt-cancel-btn" class="text-text-muted hover:text-white text-sm font-medium transition-colors">Cancel</button>
            <button id="prompt-confirm-btn" class="bg-brand hover:bg-brand-hover text-white px-4 py-2 rounded text-sm font-medium transition-colors shadow-sm">Save</button>
        </div>
    </div>
</div>

<div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden backdrop-blur-sm md:hidden transition-opacity opacity-0"></div>

<nav id="sidebar" class="fixed inset-y-0 left-0 z-40 w-full bg-dark-sidebar border-r border-dark-border flex flex-col justify-between transition-transform duration-300 -translate-x-full md:translate-x-0 md:static md:w-20 lg:w-64 shadow-lg">
    <div class="flex flex-col h-full overflow-hidden">
        <div class="h-16 flex items-center justify-between px-4 lg:px-6 border-b border-dark-border shrink-0">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand to-red-600 flex items-center justify-center shadow-lg shadow-brand/20">
                    <i class="ph-bold ph-check text-white text-lg"></i>
                </div>
                <span class="block md:hidden lg:block ml-3 font-bold text-lg text-white tracking-tight">TimeTrekker</span>
            </div>
            <button onclick="app.toggleSidebar(false)" class="md:hidden text-text-muted hover:text-white"><i class="ph-bold ph-x text-xl"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-1">
            <button onclick="app.toggleFocusPanel(true)" class="xl:hidden w-full flex items-center px-3 py-2 mb-4 rounded bg-brand/10 text-brand border border-brand/20 hover:bg-brand/20 transition-colors">
                <i class="ph-fill ph-timer text-xl"></i><span class="ml-3 font-medium">Focus Mode</span>
            </button>
            <button onclick="app.setView('past')" id="nav-past" class="nav-btn w-full flex items-center px-3 py-2 rounded text-text-muted hover:bg-dark-hover hover:text-white transition-colors group">
                <i class="ph-regular ph-clock-counter-clockwise text-xl group-hover:text-brand transition-colors"></i><span class="block md:hidden lg:block ml-3 font-medium text-sm">Past</span><span id="count-past" class="block md:hidden lg:flex ml-auto text-xs bg-dark-bg text-text-muted px-2 py-0.5 rounded-full border border-dark-border">0</span>
            </button>
            <button onclick="app.setView('today')" id="nav-today" class="nav-btn w-full flex items-center px-3 py-2 rounded text-text-muted hover:bg-dark-hover hover:text-white transition-colors group">
                <i class="ph-regular ph-sun text-xl group-hover:text-brand transition-colors"></i><span class="block md:hidden lg:block ml-3 font-medium text-sm">Today</span><span id="count-today" class="block md:hidden lg:flex ml-auto text-xs bg-dark-bg text-text-muted px-2 py-0.5 rounded-full border border-dark-border">0</span>
            </button>
            <button onclick="app.setView('tomorrow')" id="nav-tomorrow" class="nav-btn w-full flex items-center px-3 py-2 rounded text-text-muted hover:bg-dark-hover hover:text-white transition-colors group">
                <i class="ph-regular ph-calendar-plus text-xl group-hover:text-brand transition-colors"></i><span class="block md:hidden lg:block ml-3 font-medium text-sm">Tomorrow</span><span id="count-tomorrow" class="block md:hidden lg:flex ml-auto text-xs bg-dark-bg text-text-muted px-2 py-0.5 rounded-full border border-dark-border">0</span>
            </button>
            <button onclick="app.setView('upcoming')" id="nav-upcoming" class="nav-btn w-full flex items-center px-3 py-2 rounded text-text-muted hover:bg-dark-hover hover:text-white transition-colors group">
                <i class="ph-regular ph-calendar text-xl group-hover:text-brand transition-colors"></i><span class="block md:hidden lg:block ml-3 font-medium text-sm">Upcoming</span><span id="count-upcoming" class="block md:hidden lg:flex ml-auto text-xs bg-dark-bg text-text-muted px-2 py-0.5 rounded-full border border-dark-border">0</span>
            </button>
            <button onclick="app.setView('analytics')" id="nav-analytics" class="nav-btn w-full flex items-center px-3 py-2 rounded text-text-muted hover:bg-dark-hover hover:text-white transition-colors group">
                <i class="ph-regular ph-chart-line-up text-xl group-hover:text-brand transition-colors"></i><span class="block md:hidden lg:block ml-3 font-medium text-sm">Analytics</span>
            </button>
            <div class="mt-6 mb-2 px-3 flex items-center justify-between text-xs font-semibold text-text-faint uppercase tracking-wider">
                <span class="block md:hidden lg:block">Projects</span><button onclick="app.promptNewProject()" class="hover:text-white transition-colors" title="New Project"><i class="ph-bold ph-plus"></i></button>
            </div>
            <div id="project-list" class="space-y-0.5"></div>
        </div>
        <div class="p-4 border-t border-dark-border shrink-0 flex flex-col gap-1">
            <button onclick="app.setView('completed')" id="nav-completed" class="nav-btn w-full flex items-center px-3 py-2 rounded text-text-muted hover:bg-dark-hover hover:text-white transition-colors">
                <i class="ph-regular ph-check-circle text-xl"></i><span class="block md:hidden lg:block ml-3 text-sm font-medium">Completed</span>
            </button>
            <div id="user-profile-display" class="hidden items-center p-2 rounded hover:bg-dark-hover transition-colors cursor-default mt-2">
                <div id="user-avatar-initials" class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center text-xs font-bold text-white shrink-0">U</div>
                <div class="flex md:hidden lg:flex flex-col ml-3 overflow-hidden"><span id="user-name-text" class="text-sm font-medium text-white truncate">User</span><span id="user-email-text" class="text-xs text-text-muted truncate">email@example.com</span></div>
                <button onclick="app.signOut()" class="ml-auto text-text-muted hover:text-red-400 p-1 md:hidden lg:block" title="Sign Out"><i class="ph-bold ph-sign-out"></i></button>
            </div>
            <div class="mt-3 text-[10px] text-text-faint text-center md:hidden lg:block tracking-wide uppercase font-bold opacity-60">Powered by StackBase</div>
        </div>
    </div>
</nav>

<main class="flex-1 flex flex-col relative overflow-hidden bg-dark-bg min-w-0">
    <header class="h-16 flex-shrink-0 flex items-center justify-between px-6 border-b border-dark-border bg-dark-bg z-10 w-full">
        <div class="flex items-center min-w-0 mr-4">
            <button onclick="app.toggleSidebar()" class="md:hidden text-text-muted hover:text-white mr-4"><i class="ph-bold ph-list text-2xl"></i></button>
            <h1 id="page-title" class="text-xl font-semibold text-white tracking-tight truncate">Today</h1>
            <span id="current-date-display" class="ml-4 text-sm text-text-muted hidden md:block border-l border-dark-border pl-4"></span>
        </div>
        <div class="flex items-center space-x-3 shrink-0" id="header-actions">
            <button onclick="app.toggleAddTaskModal()" class="bg-brand hover:bg-brand-hover text-white px-4 py-2 rounded text-sm font-medium flex items-center transition-colors shadow-sm">
                <i class="ph-bold ph-plus mr-2"></i> <span class="hidden sm:inline">Add Task</span><span class="sm:hidden">Add</span>
            </button>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto relative custom-scrollbar bg-dark-bg">
        <div id="task-view-container" class="p-6 lg:p-10 max-w-5xl mx-auto">
            <div id="stats-summary" class="hidden md:flex items-center justify-between bg-dark-card border border-dark-border rounded-lg p-5 mb-8 shadow-sm">
                <div class="flex space-x-12">
                    <div><div class="text-2xl font-bold text-white" id="stat-pomos-today">0</div><div class="text-xs text-text-muted uppercase font-semibold tracking-wide mt-1">Pomos</div></div>
                    <div><div class="text-2xl font-bold text-white" id="stat-tasks-today">0</div><div class="text-xs text-text-muted uppercase font-semibold tracking-wide mt-1">Tasks Done</div></div>
                    <div><div class="text-2xl font-bold text-white" id="stat-est-remaining">0</div><div class="text-xs text-text-muted uppercase font-semibold tracking-wide mt-1">Est. Pomo</div></div>
                </div>
                <div class="text-right"><div class="text-2xl font-bold text-brand" id="stat-focus-time">0h 0m</div><div class="text-xs text-text-muted uppercase font-semibold tracking-wide mt-1">Focus Time</div></div>
            </div>
            <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-text-faint pb-20 pointer-events-none">
                <i class="ph-light ph-check-square-offset text-6xl mb-4 opacity-50"></i><p class="text-lg font-medium text-text-muted">No tasks found</p><p class="text-sm">Add a task to get started.</p>
            </div>
            <div id="task-list" class="space-y-2 pb-32"></div>
        </div>

        <div id="analytics-view-container" class="hidden p-6 lg:p-10 max-w-7xl mx-auto space-y-6 pb-20">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-2">
                <div>
                    <h2 class="text-2xl font-bold text-white">Analytics Dashboard</h2>
                    <p class="text-sm text-text-muted mt-1">Comprehensive productivity analysis</p>
                </div>
                <div class="bg-dark-card border border-dark-border rounded p-1 flex">
                    <button onclick="app.setRange('week')" id="btn-range-week" class="px-4 py-1.5 rounded text-xs font-medium bg-brand text-white shadow-sm transition-all">Week</button>
                    <button onclick="app.setRange('month')" id="btn-range-month" class="px-4 py-1.5 rounded text-xs font-medium text-text-muted hover:text-white transition-all">Month</button>
                    <button onclick="app.setRange('year')" id="btn-range-year" class="px-4 py-1.5 rounded text-xs font-medium text-text-muted hover:text-white transition-all">Year</button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4">
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Total Focus</div>
                    <div class="text-2xl font-bold text-brand" id="ana-time-total">0h</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">This Week</div>
                    <div class="text-2xl font-bold text-brand" id="ana-time-week">0m</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Today</div>
                    <div class="text-2xl font-bold text-brand" id="ana-time-today">0m</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Total Tasks</div>
                    <div class="text-2xl font-bold text-blue-500" id="ana-task-total">0</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Week Tasks</div>
                    <div class="text-2xl font-bold text-blue-500" id="ana-task-week">0</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Today Tasks</div>
                    <div class="text-2xl font-bold text-blue-500" id="ana-task-today">0</div>
                </div>

                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Completion %</div>
                    <div class="text-xl font-bold text-green-500" id="ana-completion-rate">0%</div>
                    <div class="text-[10px] text-text-faint mt-1">Based on active tasks</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Avg Session</div>
                    <div class="text-xl font-bold text-white" id="ana-avg-session">0m</div>
                    <div class="text-[10px] text-text-faint mt-1">Minutes per pomo</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Morning Focus</div>
                    <div class="text-xl font-bold text-yellow-500" id="ana-early-bird">0h</div>
                    <div class="text-[10px] text-text-faint mt-1">Before 12 PM</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Night Focus</div>
                    <div class="text-xl font-bold text-indigo-400" id="ana-night-owl">0h</div>
                    <div class="text-[10px] text-text-faint mt-1">After 8 PM</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Best Streak</div>
                    <div class="text-xl font-bold text-purple-500" id="ana-streak-days">0 Days</div>
                    <div class="text-[10px] text-text-faint mt-1">Consecutive activity</div>
                </div>
                 <div class="bg-dark-card border border-dark-border rounded-lg p-5">
                    <div class="text-xs text-text-muted font-bold uppercase tracking-wider mb-2">Projects</div>
                    <div class="text-xl font-bold text-white" id="ana-project-count">0</div>
                    <div class="text-[10px] text-text-faint mt-1">Active projects</div>
                </div>
            </div>
            
            <div class="bg-brand/5 border border-brand/20 rounded-lg p-4 flex items-start gap-3">
                <i class="ph-fill ph-lightbulb text-brand text-xl mt-0.5"></i>
                <div class="text-sm text-text-muted">
                    <span class="block text-white font-semibold mb-1">Smart Insights</span>
                    <span id="insight-text">Not enough data to generate insights yet. Start tracking your focus sessions!</span>
                </div>
            </div>

            <div class="bg-dark-card border border-dark-border rounded-lg p-6 shadow-sm">
                 <h3 class="text-lg font-semibold text-white mb-6">Pomodoro Records</h3>
                 <div class="overflow-x-auto custom-scrollbar pb-2">
                    <div class="min-w-[600px] w-full">
                        <div class="flex text-[10px] text-text-muted font-mono mb-2 pl-24"><span class="flex-1 border-l border-dark-border pl-1">00:00</span><span class="flex-1 border-l border-dark-border pl-1">04:00</span><span class="flex-1 border-l border-dark-border pl-1">08:00</span><span class="flex-1 border-l border-dark-border pl-1">12:00</span><span class="flex-1 border-l border-dark-border pl-1">16:00</span><span class="flex-1 border-l border-dark-border pl-1">20:00</span></div>
                        <div id="pomo-timeline-grid" class="space-y-1"></div>
                    </div>
                 </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-dark-card border border-dark-border rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-white">Focus Trend</h3>
                        <div class="glass-toggle-group">
                            <button onclick="app.toggleChartType('focus', 'line')" id="btn-focus-line" class="glass-toggle-btn">Line</button>
                            <button onclick="app.toggleChartType('focus', 'bar')" id="btn-focus-bar" class="glass-toggle-btn active">Bar</button>
                        </div>
                    </div>
                    <div class="h-[250px] w-full relative"><canvas id="focusBarChart"></canvas></div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-white">Task Completion</h3>
                        <div class="glass-toggle-group">
                            <button onclick="app.toggleChartType('task', 'line')" id="btn-task-line" class="glass-toggle-btn">Line</button>
                            <button onclick="app.toggleChartType('task', 'bar')" id="btn-task-bar" class="glass-toggle-btn active">Bar</button>
                        </div>
                    </div>
                    <div class="h-[250px] w-full relative"><canvas id="taskBarChart"></canvas></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                 <div class="bg-dark-card border border-dark-border rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-white">Hourly Productivity</h3>
                            <p class="text-xs text-text-muted mt-0.5">Which hours of the day you focus the most.</p>
                        </div>
                        <div class="glass-toggle-group">
                            <button onclick="app.toggleChartType('hourly', 'line')" id="btn-hourly-line" class="glass-toggle-btn">Line</button>
                            <button onclick="app.toggleChartType('hourly', 'bar')" id="btn-hourly-bar" class="glass-toggle-btn active">Bar</button>
                        </div>
                    </div>
                    <div class="h-[250px] w-full relative"><canvas id="hourlyChart"></canvas></div>
                </div>
                 <div class="bg-dark-card border border-dark-border rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-white">Weekly Performance</h3>
                             <p class="text-xs text-text-muted mt-0.5">Your best days of the week.</p>
                        </div>
                        <div class="glass-toggle-group">
                            <button onclick="app.toggleChartType('weekday', 'line')" id="btn-weekday-line" class="glass-toggle-btn">Line</button>
                            <button onclick="app.toggleChartType('weekday', 'bar')" id="btn-weekday-bar" class="glass-toggle-btn active">Bar</button>
                        </div>
                    </div>
                    <div class="h-[250px] w-full relative"><canvas id="weekdayChart"></canvas></div>
                </div>
            </div>

             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                 <div class="bg-dark-card border border-dark-border rounded-lg p-6 shadow-sm flex flex-col">
                    <h3 class="text-sm font-bold uppercase text-text-muted mb-4">Projects</h3>
                    <div class="h-[180px] w-full relative flex justify-center mb-4"><canvas id="projectChart"></canvas></div>
                    <div id="project-rank-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2 max-h-[150px]"></div>
                </div>
                 <div class="bg-dark-card border border-dark-border rounded-lg p-6 shadow-sm flex flex-col">
                    <h3 class="text-sm font-bold uppercase text-text-muted mb-4">Task Priorities</h3>
                    <div class="h-[180px] w-full relative flex justify-center mb-4"><canvas id="priorityChart"></canvas></div>
                    <div class="text-center text-xs text-text-muted">High vs Med vs Low</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-6 shadow-sm flex flex-col">
                     <h3 class="text-sm font-bold uppercase text-text-muted mb-4">Top Tags</h3>
                     <div id="tag-rank-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-3">
                         <p class="text-sm text-text-muted italic">No tags data available.</p>
                     </div>
                </div>
            </div>

            <div class="bg-dark-card border border-dark-border rounded-lg overflow-hidden shadow-sm">
                <div class="p-6 border-b border-dark-border flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-white">Recent Sessions Log</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full analysis-table">
                        <thead><tr><th>Time</th><th>Task</th><th>Project</th><th>Duration</th></tr></thead>
                        <tbody id="session-log-body"></tbody>
                    </table>
                </div>
                <div class="p-3 text-center border-t border-dark-border">
                    <span class="text-xs text-text-muted">Showing last 20 sessions</span>
                </div>
            </div>

        </div>
    </div>
</main>

<aside id="timer-panel" class="fixed inset-0 z-50 flex flex-col bg-dark-card border-l border-dark-border transform translate-x-full transition-transform duration-300 xl:static xl:translate-x-0 xl:w-[400px] xl:z-20 h-full overflow-hidden shadow-2xl">
    <div class="flex-shrink-0 px-6 py-4 flex items-center justify-between border-b border-dark-border bg-dark-card">
        <button onclick="app.toggleFocusPanel(false)" class="xl:hidden text-text-muted hover:text-white"><i class="ph-bold ph-arrow-left text-xl"></i></button>
        <div class="flex items-center space-x-4 overflow-x-auto no-scrollbar text-xs font-medium">
             <button onclick="app.setSound('none')" id="sound-none" class="sound-option text-brand hover:text-white transition-colors flex items-center whitespace-nowrap"><i class="ph-fill ph-speaker-slash mr-1 text-lg"></i> Silent</button>
             <button onclick="app.setSound('rain')" id="sound-rain" class="sound-option text-text-muted hover:text-white transition-colors flex items-center whitespace-nowrap"><i class="ph-fill ph-cloud-rain mr-1 text-lg"></i> Rain</button>
             <button onclick="app.setSound('cafe')" id="sound-cafe" class="sound-option text-text-muted hover:text-white transition-colors flex items-center whitespace-nowrap"><i class="ph-fill ph-coffee mr-1 text-lg"></i> Cafe</button>
             <button onclick="app.setSound('forest')" id="sound-forest" class="sound-option text-text-muted hover:text-white transition-colors flex items-center whitespace-nowrap"><i class="ph-fill ph-tree mr-1 text-lg"></i> Forest</button>
        </div>
        <button onclick="app.toggleTimerSettings()" class="text-text-muted hover:text-white"><i class="ph-fill ph-gear text-xl"></i></button>
    </div>
    <div class="flex-1 flex flex-col items-center justify-center p-8 relative">
        <div class="mb-12 w-full text-center min-h-[80px]">
            <div id="focus-empty" class="flex flex-col items-center text-text-muted animate-pulse"><p class="text-sm font-medium">Select a task to start focusing</p></div>
            <div id="focus-active" class="hidden animate-fade-in w-full flex flex-col items-center">
                <div class="inline-flex items-center justify-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-dark-bg text-text-muted border border-dark-border mb-3"><span id="focus-project-badge" class="truncate max-w-[150px]">Project</span></div>
                <h2 id="focus-task-title" class="text-xl font-bold text-white leading-snug mb-2 line-clamp-2 px-2">Task Title</h2>
                <div class="flex items-center space-x-1 text-xs text-text-muted"><span class="text-brand font-bold" id="focus-completed">0</span><span>/</span><span id="focus-total">4</span><span>Pomos</span></div>
            </div>
        </div>
        <div class="relative mb-16">
            <div class="relative w-64 h-64 flex items-center justify-center">
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100"><circle cx="50" cy="50" r="46" fill="none" stroke="#333" stroke-width="2"/><circle id="timer-progress" cx="50" cy="50" r="46" fill="none" stroke="#ff5757" stroke-width="2" stroke-linecap="round" stroke-dasharray="289" stroke-dashoffset="0" class="transition-all duration-1000 ease-linear"/></svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer select-none" onclick="app.toggleTimer()"><div id="timer-display" class="text-6xl font-light text-white tracking-tighter tabular-nums">25:00</div><div id="timer-mode" class="text-xs font-bold tracking-widest uppercase mt-4 text-brand">FOCUS</div></div>
            </div>
        </div>
        <div class="flex items-center justify-center gap-8">
             <button onclick="app.resetTimer()" class="p-4 rounded-full text-text-muted hover:text-white hover:bg-dark-hover transition-colors"><i class="ph-bold ph-arrow-counter-clockwise text-2xl"></i></button>
             <button onclick="app.toggleTimer()" id="play-btn" class="w-16 h-16 rounded-full bg-brand hover:bg-brand-hover text-white flex items-center justify-center transition-transform active:scale-95 shadow-lg"><i class="ph-fill ph-play text-3xl ml-1" id="play-icon"></i></button>
             <button onclick="app.skipTimer()" class="p-4 rounded-full text-text-muted hover:text-white hover:bg-dark-hover transition-colors"><i class="ph-bold ph-skip-forward text-2xl"></i></button>
        </div>
    </div>
    <div id="timer-settings" class="absolute inset-0 bg-dark-card/95 backdrop-blur z-50 hidden flex-col p-8 animate-fade-in">
        <div class="flex justify-between items-center mb-8"><h3 class="text-xl font-bold text-white">Timer Settings</h3><button onclick="app.toggleTimerSettings()" class="text-text-muted hover:text-white"><i class="ph-bold ph-x text-xl"></i></button></div>
        <div class="space-y-8">
            <div><label class="text-xs text-text-muted uppercase font-bold mb-4 block">Focus Duration</label><div class="flex items-center gap-4"><span class="text-xs text-text-muted w-8">5m</span><input type="range" min="5" max="60" step="5" value="25" oninput="app.updateSettings('focus',this.value)"><span class="text-sm font-bold text-white w-8 text-right" id="set-focus-val">25</span></div></div>
             <div><label class="text-xs text-text-muted uppercase font-bold mb-4 block">Short Break</label><div class="flex items-center gap-4"><span class="text-xs text-text-muted w-8">1m</span><input type="range" min="1" max="15" step="1" value="5" oninput="app.updateSettings('short',this.value)"><span class="text-sm font-bold text-white w-8 text-right" id="set-short-val">5</span></div></div>
             <div><label class="text-xs text-text-muted uppercase font-bold mb-4 block">Long Break</label><div class="flex items-center gap-4"><span class="text-xs text-text-muted w-8">10m</span><input type="range" min="10" max="45" step="5" value="15" oninput="app.updateSettings('long',this.value)"><span class="text-sm font-bold text-white w-8 text-right" id="set-long-val">15</span></div></div>
            <div class="flex items-center justify-between pt-6 border-t border-dark-border"><div><label class="text-sm font-bold text-white block">Strict Mode</label><p class="text-xs text-text-muted mt-1">Prevent stopping the timer early</p></div><label class="custom-checkbox relative flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onclick="app.updateSettings('strictMode',this.checked)"><div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand"></div></label></div>
        </div>
    </div>
    <audio id="audio-player" loop></audio>
</aside>

<div id="add-task-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div class="bg-dark-card border border-dark-border w-full max-w-lg rounded-lg shadow-2xl overflow-hidden transform scale-95 transition-transform duration-200" id="add-task-panel">
        <form id="add-task-form" onsubmit="app.handleSaveTask(event)" class="flex flex-col max-h-[90vh]">
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6"><h2 class="text-lg font-bold text-white" id="modal-title">New Task</h2><button type="button" onclick="app.toggleAddTaskModal()" class="text-text-muted hover:text-white"><i class="ph-bold ph-x text-xl"></i></button></div>
                <input type="text" id="task-title" placeholder="What needs to be done?" class="w-full bg-transparent text-xl font-medium text-white placeholder-text-muted border-none outline-none mb-4" required autocomplete="off">
                <textarea id="task-note" placeholder="Description or notes..." class="w-full bg-dark-bg border border-dark-border focus:border-brand rounded text-sm text-white p-3 outline-none resize-none h-24 mb-6 transition-colors"></textarea>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="text-xs font-bold text-text-muted uppercase mb-1.5 block">Est. Pomodoros</label><div class="flex items-center h-10 bg-dark-bg border border-dark-border rounded px-1"><button type="button" onclick="app.adjustEst(-1)" class="w-8 h-full text-text-muted hover:text-white hover:bg-dark-hover rounded transition-colors"><i class="ph-bold ph-minus"></i></button><span id="est-display" class="flex-1 text-center font-mono font-bold text-white">1</span><button type="button" onclick="app.adjustEst(1)" class="w-8 h-full text-text-muted hover:text-white hover:bg-dark-hover rounded transition-colors"><i class="ph-bold ph-plus"></i></button></div></div>
                     <div><label class="text-xs font-bold text-text-muted uppercase mb-1.5 block">Due Date</label><input type="date" id="task-date" class="w-full h-10 bg-dark-bg border border-dark-border rounded px-3 text-sm text-white focus:border-brand outline-none transition-colors"></div>
                </div>
                 <div class="grid grid-cols-2 gap-4 mb-4">
                     <div class="relative" id="project-dropdown"><label class="text-xs font-bold text-text-muted uppercase mb-1.5 block">Project</label><button type="button" onclick="app.toggleDropdown('project')" class="w-full h-10 bg-dark-bg border border-dark-border rounded px-3 flex items-center justify-between text-sm text-white focus:border-brand outline-none"><span id="selected-project" class="truncate">Inbox</span><i class="ph-fill ph-caret-down text-text-muted"></i></button><div id="project-options" class="absolute left-0 right-0 top-full mt-1 bg-dark-card border border-dark-border rounded shadow-xl z-20 hidden max-h-40 overflow-y-auto"></div><input type="hidden" id="task-project" value="Inbox"></div>
                     <div class="relative" id="priority-dropdown"><label class="text-xs font-bold text-text-muted uppercase mb-1.5 block">Priority</label><button type="button" onclick="app.toggleDropdown('priority')" class="w-full h-10 bg-dark-bg border border-dark-border rounded px-3 flex items-center justify-between text-sm text-white focus:border-brand outline-none"><span id="selected-priority">None</span><i class="ph-fill ph-caret-down text-text-muted"></i></button><div id="priority-options" class="absolute left-0 right-0 top-full mt-1 bg-dark-card border border-dark-border rounded shadow-xl z-20 hidden"><button type="button" onclick="app.selectOption('priority','none','None')" class="w-full text-left px-3 py-2 text-sm text-text-muted hover:bg-dark-hover hover:text-white">None</button><button type="button" onclick="app.selectOption('priority','high','High Priority (! Urgent)')" class="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-dark-hover">High Priority (! Urgent)</button><button type="button" onclick="app.selectOption('priority','med','Medium Priority')" class="w-full text-left px-3 py-2 text-sm text-yellow-400 hover:bg-dark-hover">Medium Priority</button><button type="button" onclick="app.selectOption('priority','low','Low Priority')" class="w-full text-left px-3 py-2 text-sm text-blue-400 hover:bg-dark-hover">Low Priority</button></div><input type="hidden" id="task-priority" value="none"></div>
                </div>
                <div class="mb-4">
                    <label class="text-xs font-bold text-text-muted uppercase mb-1.5 block">Tags</label>
                    <input type="text" id="task-tags" placeholder="e.g. Work, Study, Design (comma separated)" class="w-full h-10 bg-dark-bg border border-dark-border rounded px-3 text-sm text-white focus:border-brand outline-none transition-colors">
                </div>
                <input type="hidden" id="task-pomo-duration" value="25">
                 <div class="mb-2"><div id="subtasks-container" class="space-y-2"></div><button type="button" onclick="app.addSubtaskUI()" class="text-xs text-brand hover:text-brand-hover font-medium flex items-center mt-2"><i class="ph-bold ph-plus mr-1"></i> Add Subtask</button></div>
            </div>
            <div class="p-4 border-t border-dark-border bg-dark-card flex justify-end gap-3">
                <button type="button" onclick="app.toggleAddTaskModal()" class="px-4 py-2 rounded text-sm font-medium text-text-muted hover:text-white transition-colors">Cancel</button>
                <button type="submit" id="save-task-btn" class="px-6 py-2 rounded text-sm font-medium bg-brand text-white hover:bg-brand-hover shadow-sm transition-colors">Save Task</button>
            </div>
        </form>
    </div>
</div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';import{getAuth,onAuthStateChanged,signOut}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';import{getFirestore,collection,addDoc,updateDoc,deleteDoc,doc,setDoc,onSnapshot,query,where,getDocs,writeBatch,orderBy,serverTimestamp}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
const C={apiKey:"AIzaSyDkKhb8m0znWyC2amv6uGpA8KmbkuW-j1U",authDomain:"timetrekker-app.firebaseapp.com",projectId:"timetrekker-app",storageBucket:"timetrekker-app.firebasestorage.app",messagingSenderId:"83185163190",appId:"1:83185163190:web:e2974c5d0f0274fe5e3f17",measurementId:"G-FLZ02E1Y5L"},appId='timetrekker-v1',fb=initializeApp(C),auth=getAuth(fb),db=getFirestore(fb),D=document,$=id=>D.getElementById(id);

// Add chartTypes to state to track Bar vs Line preference
const state={
    user:null,tasks:[],logs:[],projects:new Set(['Inbox','Work','Personal','Study']),view:'today',filterProject:null,selectedTaskId:null,editingTaskId:null,
    timer:{mode:'focus',status:'idle',endTime:null,remaining:1500,totalDuration:1500,activeTaskId:null,interval:null,settings:{focus:25,short:5,long:15,strictMode:false}},
    newEst:1,sound:'none',
    charts:{focusBar:null,taskBar:null,project:null,hourly:null,weekday:null,priority:null},
    chartTypes: { focus: 'bar', task: 'bar', hourly: 'bar', weekday: 'bar' }, // New State
    analytics:{range:'week',metric:'time'}
};

const sounds={none:'',rain:'https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg',cafe:'https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg',forest:'https://actions.google.com/sounds/v1/ambiences/forest_morning.ogg'};
const els={taskList:$('task-list'),taskViewContainer:$('task-view-container'),analyticsViewContainer:$('analytics-view-container'),pageTitle:$('page-title'),emptyState:$('empty-state'),modal:$('add-task-modal'),modalPanel:$('add-task-panel'),modalTitle:$('modal-title'),saveTaskBtn:$('save-task-btn'),estDisplay:$('est-display'),dateInput:$('task-date'),timerDisplay:$('timer-display'),timerProgress:$('timer-progress'),timerMode:$('timer-mode'),playIcon:$('play-icon'),focusActive:$('focus-active'),focusEmpty:$('focus-empty'),focusTitle:$('focus-task-title'),focusProject:$('focus-project-badge'),focusCompleted:$('focus-completed'),focusTotal:$('focus-total'),timerPanel:$('timer-panel'),navCounts:{today:$('count-today'),tomorrow:$('count-tomorrow'),upcoming:$('count-upcoming'),past:$('count-past')},stats:{pomosToday:$('stat-pomos-today'),tasksToday:$('stat-tasks-today'),estRemain:$('stat-est-remaining'),focusTime:$('stat-focus-time')},analytics:{
    timeTotal:$('ana-time-total'),timeWeek:$('ana-time-week'),timeToday:$('ana-time-today'),
    taskTotal:$('ana-task-total'),taskWeek:$('ana-task-week'),taskToday:$('ana-task-today'),
    completionRate:$('ana-completion-rate'),avgSession:$('ana-avg-session'),
    earlyBird:$('ana-early-bird'),nightOwl:$('ana-night-owl'),streakDays:$('ana-streak-days'),
    projectCount:$('ana-project-count'),insightText:$('insight-text'),
    timelineGrid:$('pomo-timeline-grid'),focusBarChart:$('focusBarChart'),taskBarChart:$('taskBarChart'),
    projectChart:$('projectChart'),hourlyChart:$('hourlyChart'),weekdayChart:$('weekdayChart'),priorityChart:$('priorityChart'),
    projList:$('project-rank-list'),tagList:$('tag-rank-list'),sessionLogBody:$('session-log-body')
},projectList:$('project-list'),subtasksContainer:$('subtasks-container'),audio:$('audio-player'),timerSettings:$('timer-settings'),currentDate:$('current-date-display'),sidebarOverlay:$('sidebar-overlay'),sidebar:$('sidebar'),headerActions:$('header-actions')};

// ---- GLOBAL CHART POLISH CONFIGURATION ----
Chart.defaults.font.family='Inter';
Chart.defaults.color='#a3a3a3';
Chart.defaults.borderColor='#333';
Chart.defaults.scale.grid.color='rgba(255,255,255,0.03)'; // More subtle grid
Chart.defaults.scale.grid.borderColor='transparent';
Chart.defaults.scale.grid.borderDash=[4,4]; // Dashed grid lines
Chart.defaults.plugins.tooltip.backgroundColor='rgba(32, 32, 32, 0.95)';
Chart.defaults.plugins.tooltip.titleColor='#fff';
Chart.defaults.plugins.tooltip.bodyColor='#a3a3a3';
Chart.defaults.plugins.tooltip.borderColor='#333';
Chart.defaults.plugins.tooltip.borderWidth=1;
Chart.defaults.plugins.tooltip.padding=10;
Chart.defaults.plugins.tooltip.cornerRadius=6;
Chart.defaults.plugins.tooltip.displayColors=false;
// ------------------------------------------

onAuthStateChanged(auth,u=>{if(u){state.user=u;const p=$('user-profile-display');if(p){p.classList.remove('hidden');p.classList.add('flex');$('user-name-text').innerText=u.displayName||u.email.split('@')[0];$('user-email-text').innerText=u.email;$('user-avatar-initials').innerText=(u.displayName||u.email).charAt(0).toUpperCase()}subTasks(u.uid);subLogs(u.uid);subTimer(u.uid);els.currentDate.innerText=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}else window.location.href='https://stack-base.github.io/account/login.html?redirectUrl=https://stack-base.github.io/timetrekker/application'});
const subTasks=uid=>onSnapshot(collection(db,'artifacts',appId,'users',uid,'tasks'),s=>{const t=[],p=new Set(['Inbox','Work','Personal','Study']);s.forEach(d=>{const x=d.data();t.push({id:d.id,...x});if(x.project&&x.project!=='Inbox')p.add(x.project)});state.tasks=t;state.projects=p;updateProjectsUI();updateCounts();renderTasks();if(state.timer.activeTaskId){updateTimerUI(t.find(x=>x.id===state.timer.activeTaskId))}if(state.view==='analytics')updateAnalytics()});
const subTimer=uid=>onSnapshot(doc(db,'artifacts',appId,'users',uid,'timer','active'),s=>{if(s.exists()){const d=s.data();state.timer={...state.timer,status:d.status||'idle',mode:d.mode||'focus',endTime:d.endTime?d.endTime.toMillis():null,remaining:d.remaining||state.timer.settings[d.mode||'focus']*60,totalDuration:d.totalDuration||state.timer.settings[d.mode||'focus']*60,activeTaskId:d.taskId||null};app.setTimerModeUI(state.timer.mode);if(state.timer.activeTaskId){state.selectedTaskId=state.timer.activeTaskId;updateTimerUI(state.tasks.find(x=>x.id===state.timer.activeTaskId))}else updateTimerUI(null);if(state.timer.status==='running'){startLocalInterval();updateTimerVisuals();if(state.sound!=='none'&&els.audio.paused)els.audio.play().catch(e=>{})}else{stopLocalInterval();updateTimerVisuals();if(!els.audio.paused)els.audio.pause()}}else app.resetTimer(true)});
const startLocalInterval=()=>{if(state.timer.interval)clearInterval(state.timer.interval);state.timer.interval=setInterval(()=>{updateTimerVisuals();if(state.timer.status==='running'&&state.timer.endTime&&Date.now()>=state.timer.endTime)app.completeTimer()},100);els.playIcon.className="ph-fill ph-pause text-3xl ml-1"};
const stopLocalInterval=()=>{if(state.timer.interval)clearInterval(state.timer.interval);state.timer.interval=null;els.playIcon.className="ph-fill ph-play text-3xl ml-1"};
const updateTimerVisuals=()=>{const{status,endTime,remaining,totalDuration}=state.timer;const s=status==='running'&&endTime?Math.max(0,Math.ceil((endTime-Date.now())/1000)):remaining;const m=Math.floor(s/60),sc=s%60;els.timerDisplay.innerText=`${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;els.timerProgress.style.strokeDashoffset=289*(1-(s/(totalDuration||1)));D.title=`${m}:${sc.toString().padStart(2,'0')} - TimeTrekker`};
const subLogs=uid=>onSnapshot(query(collection(db,'artifacts',appId,'users',uid,'focus_sessions')),s=>{const l=[];s.forEach(d=>l.push({id:d.id,...d.data()}));l.sort((a,b)=>(b.completedAt?.seconds||0)-(a.completedAt?.seconds||0));state.logs=l;if(state.view==='analytics')updateAnalytics()});
const app={
customPrompt:{resolve:null,el:$('custom-prompt-modal'),input:$('prompt-input'),title:$('prompt-title')},
showPrompt:(t,v='')=>new Promise(r=>{const p=app.customPrompt;p.resolve=r;p.title.innerText=t;p.input.value=v;p.el.classList.remove('hidden');setTimeout(()=>p.el.classList.remove('opacity-0'),10);p.input.focus()}),
closePrompt:v=>{const p=app.customPrompt;p.el.classList.add('opacity-0');setTimeout(()=>{p.el.classList.add('hidden');if(p.resolve)p.resolve(v);p.resolve=null},200)},
setView:v=>{state.view=v;state.filterProject=null;els.pageTitle.innerText=v.charAt(0).toUpperCase()+v.slice(1);updateNavStyles(v);app.toggleSidebar(false);if(v==='analytics'){els.taskViewContainer.classList.add('hidden');els.analyticsViewContainer.classList.remove('hidden');els.headerActions.classList.add('invisible');updateAnalytics()}else{els.taskViewContainer.classList.remove('hidden');els.analyticsViewContainer.classList.add('hidden');els.headerActions.classList.remove('invisible');renderTasks()}},
setProjectView:p=>{state.view='project';state.filterProject=p;els.pageTitle.innerText=p;updateNavStyles('project',p);app.toggleSidebar(false);els.taskViewContainer.classList.remove('hidden');els.analyticsViewContainer.classList.add('hidden');els.headerActions.classList.remove('invisible');renderTasks()},
setRange:r=>{state.analytics.range=r;['week','month','year'].forEach(k=>{const b=$(`btn-range-${k}`);b.className=k===r?"px-4 py-1.5 rounded text-xs font-medium bg-brand text-white shadow-sm transition-all":"px-4 py-1.5 rounded text-xs font-medium text-text-muted hover:text-white transition-all"});updateAnalytics()},

// New Function: Switch Chart Type
toggleChartType: (chartKey, type) => {
    state.chartTypes[chartKey] = type;
    // Update button visual states
    ['bar', 'line'].forEach(t => {
        const btn = $(`btn-${chartKey}-${t}`);
        if(btn) {
            if(t === type) btn.classList.add('active');
            else btn.classList.remove('active');
        }
    });
    updateAnalytics(); // Re-render charts
},

toggleFocusPanel:f=>{const p=els.timerPanel,i=!p.classList.contains('translate-x-full');(f!==null?f:!i)?p.classList.remove('translate-x-full'):p.classList.add('translate-x-full')},
toggleSidebar:f=>{const s=els.sidebar,o=els.sidebarOverlay,h=s.classList.contains('-translate-x-full');const show=(typeof f==='boolean')?f:h;if(show){s.classList.remove('-translate-x-full');o.classList.remove('hidden');requestAnimationFrame(()=>o.classList.remove('opacity-0'))}else{s.classList.add('-translate-x-full');o.classList.add('opacity-0');setTimeout(()=>o.classList.add('hidden'),300)}},
promptNewProject:async()=>{const n=await app.showPrompt("Enter project name:");if(n){state.projects.add(n);updateProjectsUI()}},
renameProject:async(o,e)=>{e.stopPropagation();const n=await app.showPrompt(`Rename "${o}" to:`,o);if(!n||n===o||!state.user)return;try{const b=writeBatch(db);(await getDocs(query(collection(db,'artifacts',appId,'users',state.user.uid,'tasks'),where("project","==",o)))).forEach(d=>b.update(d.ref,{project:n}));await b.commit();state.projects.delete(o);state.projects.add(n);state.filterProject===o?app.setProjectView(n):updateProjectsUI()}catch(err){app.showToast("Failed rename")}},
deleteProject:async(p,e)=>{e.stopPropagation();if(!confirm(`Delete "${p}"? Tasks move to Inbox.`)||!state.user)return;try{const b=writeBatch(db);(await getDocs(query(collection(db,'artifacts',appId,'users',state.user.uid,'tasks'),where("project","==",p)))).forEach(d=>b.update(d.ref,{project:'Inbox'}));await b.commit();state.projects.delete(p);state.filterProject===p?app.setView('today'):updateProjectsUI()}catch(err){app.showToast("Failed delete")}},
addSubtaskUI:(v='')=>{const d=D.createElement('div');d.className='flex items-center space-x-2 animate-fade-in';d.innerHTML=`<div class="w-1.5 h-1.5 rounded-full bg-brand shrink-0"></div><input type="text" class="subtask-input flex-1 bg-transparent border-b border-dark-border focus:border-brand text-sm text-white py-1 outline-none transition-colors" placeholder="Subtask..." value="${v}"><button type="button" onclick="this.parentElement.remove()" class="text-text-muted hover:text-red-400"><i class="ph-bold ph-x"></i></button>`;els.subtasksContainer.appendChild(d)},
toggleDropdown:t=>{const d=$(`${t}-options`);D.querySelectorAll('[id$="-options"]').forEach(x=>{if(x.id!==`${t}-options`)x.classList.add('hidden')});if(d.classList.contains('hidden')){d.classList.remove('hidden');d.classList.add('animate-fade-in')}else d.classList.add('hidden')},
selectOption:(t,v,d)=>{$(`selected-${t}`).innerText=d;$(`task-${t}`).value=v;$(`${t}-options`).classList.add('hidden')},
toggleAddTaskModal:(t=null)=>{if(els.modal.classList.contains('hidden')){els.subtasksContainer.innerHTML='';const po=$('project-options');po.innerHTML='';state.projects.forEach(p=>{const b=D.createElement('button');b.type='button';b.onclick=()=>app.selectOption('project',p,p);b.className="w-full text-left px-3 py-2 text-sm text-text-muted hover:bg-dark-hover hover:text-white transition-colors flex items-center";b.innerHTML=`<i class="ph-bold ph-folder mr-2"></i> ${p}`;po.appendChild(b)});if(t){state.editingTaskId=t.id;els.modalTitle.innerText="Edit Task";els.saveTaskBtn.innerText="Save Changes";$('task-title').value=t.title;$('task-note').value=t.note||'';$('task-tags').value=t.tags?t.tags.join(', '):'';state.newEst=t.estimatedPomos||1;els.estDisplay.innerText=state.newEst;els.dateInput.value=t.dueDate||'';const pm={none:'None',high:'High Priority (! Urgent)',med:'Medium Priority',low:'Low Priority'};app.selectOption('priority',t.priority||'none',pm[t.priority||'none']||'None');app.selectOption('project',t.project||'Inbox',t.project||'Inbox');if(t.subtasks)t.subtasks.forEach(s=>app.addSubtaskUI(s))}else{state.editingTaskId=null;els.modalTitle.innerText="New Task";els.saveTaskBtn.innerText="Save Task";state.newEst=1;els.estDisplay.innerText="1";els.dateInput.value=new Date().toISOString().split('T')[0];$('task-title').value='';$('task-note').value='';$('task-tags').value='';app.selectOption('priority','none','None');app.selectOption('project','Inbox','Inbox')}els.modal.classList.remove('hidden');setTimeout(()=>els.modal.classList.remove('opacity-0'),10);setTimeout(()=>els.modalPanel.classList.replace('scale-95','scale-100'),10);$('task-title').focus()}else{els.modal.classList.add('opacity-0');els.modalPanel.classList.replace('scale-100','scale-95');setTimeout(()=>els.modal.classList.add('hidden'),200)}},
adjustEst:d=>{let v=state.newEst+d;if(v<1)v=1;if(v>50)v=50;state.newEst=v;els.estDisplay.innerText=v},
editTask:(id,e)=>{e.stopPropagation();const t=state.tasks.find(x=>x.id===id);if(t)app.toggleAddTaskModal(t)},
handleSaveTask:async e=>{e.preventDefault();const title=$('task-title').value;if(!title)return;const subtasks=Array.from(D.querySelectorAll('.subtask-input')).map(i=>i.value.trim()).filter(v=>v),tags=$('task-tags').value.split(',').map(t=>t.trim()).filter(t=>t),data={title,dueDate:els.dateInput.value,estimatedPomos:state.newEst,priority:$('task-priority').value,project:$('task-project').value,note:$('task-note').value,subtasks,tags};const ref=collection(db,'artifacts',appId,'users',state.user.uid,'tasks');state.editingTaskId?await updateDoc(doc(ref,state.editingTaskId),data):await addDoc(ref,{...data,completedPomos:0,status:'todo',createdAt:new Date().toISOString()});app.toggleAddTaskModal()},
toggleTaskStatus:async(id,s)=>{const d={status:s==='todo'?'done':'todo'};if(s==='todo')d.completedAt=new Date().toISOString();await updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'tasks',id),d)},
deleteTask:async(id,e)=>{e.stopPropagation();if(confirm('Delete task?'))await deleteDoc(doc(db,'artifacts',appId,'users',state.user.uid,'tasks',id))},
startTask:async(id,e)=>{e.stopPropagation();const t=state.tasks.find(x=>x.id===id);if(!t)return;state.selectedTaskId=id;renderTasks();updateTimerUI(t);if(window.innerWidth<1280)app.toggleFocusPanel(true);if(state.timer.status!=='running'){const d=t.pomoDuration||25;await setDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'running',mode:'focus',taskId:id,remaining:d*60,totalDuration:d*60,endTime:new Date(Date.now()+d*60000)});app.updateSettings('focus',d)}},
selectTask:id=>{state.selectedTaskId=id;renderTasks();const t=state.tasks.find(x=>x.id===id);updateTimerUI(t);if(state.timer.status!=='running')updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{taskId:id}).catch(()=>{});if(window.innerWidth<1280)app.toggleFocusPanel(true)},
showToast:(m,t='error')=>{const c=$('toast-container'),e=D.createElement('div');e.className=`px-4 py-2 rounded shadow text-white text-sm font-medium animate-fade-in ${t==='error'?'bg-red-500':'bg-green-600'}`;e.innerText=m;c.appendChild(e);setTimeout(()=>{e.style.opacity='0';setTimeout(()=>e.remove(),300)},3000)},
toggleTimer:async()=>{if(Notification.permission==='default')try{await Notification.requestPermission()}catch(e){}if(state.timer.status==='running'){if(state.timer.settings.strictMode&&state.timer.mode==='focus'&&!confirm("Strict Mode active! Quit?"))return;await updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'paused',endTime:null,remaining:Math.max(0,Math.ceil((state.timer.endTime-Date.now())/1000))})}else{if(!state.timer.activeTaskId&&state.timer.mode==='focus'){app.showToast("Select task!","error");return}await updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'running',endTime:new Date(Date.now()+state.timer.remaining*1000)})}},
resetTimer:async(r=false)=>{if(!r){const d=state.timer.settings[state.timer.mode];await setDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'idle',endTime:null,remaining:d*60,totalDuration:d*60,mode:state.timer.mode,taskId:state.timer.activeTaskId||null})}},
skipTimer:()=>app.completeTimer(),
completeTimer:async()=>{if(state.timer.status==='idle')return;stopLocalInterval();const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator();o.connect(c.destination);o.frequency.value=523.25;o.start();o.stop(c.currentTime+.2);try{if(Notification.permission==='granted')new Notification("Timer Complete");}catch(e){}if(state.timer.mode==='focus'){if(state.timer.activeTaskId){const t=state.tasks.find(x=>x.id===state.timer.activeTaskId);if(t){await updateDoc(doc(db,'artifacts',appId,'users',state.user.uid,'tasks',t.id),{completedPomos:(t.completedPomos||0)+1});await addDoc(collection(db,'artifacts',appId,'users',state.user.uid,'focus_sessions'),{taskId:t.id,taskTitle:t.title,project:t.project||'Inbox',duration:state.timer.totalDuration/60,completedAt:serverTimestamp()})}}app.setTimerMode('short')}else app.setTimerMode('focus')},
setTimerMode:async m=>{const v=state.timer.settings[m];await setDoc(doc(db,'artifacts',appId,'users',state.user.uid,'timer','active'),{status:'idle',mode:m,remaining:v*60,totalDuration:v*60,endTime:null,taskId:state.timer.activeTaskId||null})},
setTimerModeUI:m=>{els.timerMode.innerText=m==='focus'?'FOCUS':m==='short'?'SHORT BREAK':'LONG BREAK';els.timerMode.className=`text-xs font-bold tracking-widest uppercase mt-4 ${m==='focus'?'text-brand':'text-blue-400'}`},
setSound:t=>{state.sound=t;els.audio.src=sounds[t];D.querySelectorAll('.sound-option').forEach(b=>b.className=b.className.replace('text-brand','text-text-muted'));const a=$(`sound-${t}`);if(a)a.className=a.className.replace('text-text-muted','text-brand');t==='none'?els.audio.pause():(state.timer.status==='running'&&els.audio.play())},
toggleTimerSettings:()=>{els.timerSettings.classList.toggle('hidden');els.timerSettings.classList.toggle('flex')},
updateSettings:(k,v)=>{if(k==='strictMode')state.timer.settings[k]=v;else{state.timer.settings[k]=parseInt(v);$(`set-${k}-val`).innerText=v}},
signOut:()=>signOut(auth).then(()=>window.location.href='https://stack-base.github.io/account/login.html?redirectUrl=https://stack-base.github.io/timetrekker/application')
};
window.app=app;

// Helper to create beautiful gradient for Line Charts (Apple Style)
function createGradient(ctx, color) {
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, color + '90'); // High opacity at top
    gradient.addColorStop(1, color + '05'); // Fade out at bottom
    return gradient;
}

function updateAnalytics(){
    if((!state.logs.length && !state.tasks.length) && state.view==='analytics')return;
    const getDayStr=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    const now=new Date(), todayStr=getDayStr(now);
    const startOfWeek=new Date(now); const day=startOfWeek.getDay()||7; if(day!==1)startOfWeek.setDate(now.getDate()-(day-1)); startOfWeek.setHours(0,0,0,0);
    
    // Data Filters
    const logsToday=state.logs.filter(l=>l.completedAt && getDayStr(new Date(l.completedAt.seconds*1000))===todayStr);
    const logsWeek=state.logs.filter(l=>l.completedAt && new Date(l.completedAt.seconds*1000)>=startOfWeek);
    const tasksDone=state.tasks.filter(t=>t.status==='done');
    const tasksToday=tasksDone.filter(t=>t.completedAt && t.completedAt.startsWith(todayStr));
    const tasksWeek=tasksDone.filter(t=>{if(!t.completedAt)return false; return new Date(t.completedAt)>=startOfWeek;});

    // Formatting Utils
    const fmtTime=m=>{const h=Math.floor(m/60), rem=Math.round(m%60); return h>0 ? `${h}h ${rem}m` : `${rem}m`;};
    
    // 1. Core Metrics
    els.analytics.timeTotal.innerText = fmtTime(state.logs.reduce((a,b)=>a+(b.duration||25),0));
    els.analytics.timeWeek.innerText = fmtTime(logsWeek.reduce((a,b)=>a+(b.duration||25),0));
    els.analytics.timeToday.innerText = fmtTime(logsToday.reduce((a,b)=>a+(b.duration||25),0));
    els.analytics.taskTotal.innerText = tasksDone.length;
    els.analytics.taskWeek.innerText = tasksWeek.length;
    els.analytics.taskToday.innerText = tasksToday.length;

    // 2. Advanced Stats
    const activeTasks=state.tasks.filter(t=>t.status==='todo').length + tasksDone.length;
    els.analytics.completionRate.innerText = activeTasks>0 ? Math.round((tasksDone.length/activeTasks)*100)+'%' : '0%';
    const avgSess = state.logs.length>0 ? Math.round(state.logs.reduce((a,b)=>a+(b.duration||25),0)/state.logs.length) : 0;
    els.analytics.avgSession.innerText = avgSess + 'm';
    
    let morning=0, night=0;
    state.logs.forEach(l=>{
        if(l.completedAt){
            const h=new Date(l.completedAt.seconds*1000).getHours();
            if(h<12) morning+=(l.duration||25);
            if(h>=20) night+=(l.duration||25);
        }
    });
    els.analytics.earlyBird.innerText = fmtTime(morning);
    els.analytics.nightOwl.innerText = fmtTime(night);
    els.analytics.projectCount.innerText = state.projects.size;

    let cs=0; for(let i=0;i<365;i++){const d=new Date(); d.setDate(now.getDate()-i); if(state.logs.some(l=>l.completedAt && getDayStr(new Date(l.completedAt.seconds*1000))===getDayStr(d))) cs++; else if(i>0) break;}
    els.analytics.streakDays.innerText = cs + ' Days';

    // 3. Hourly Heatmap Data
    const hours=Array(24).fill(0);
    state.logs.forEach(l=>{ if(l.completedAt) hours[new Date(l.completedAt.seconds*1000).getHours()] += (l.duration||25); });
    
    // 4. Weekday Data
    const weekdays=Array(7).fill(0);
    state.logs.forEach(l=>{ if(l.completedAt) { const d=new Date(l.completedAt.seconds*1000).getDay(); weekdays[d==0?6:d-1] += (l.duration||25); } });

    // 5. Smart Insight
    const maxHour = hours.indexOf(Math.max(...hours));
    const maxDayIdx = weekdays.indexOf(Math.max(...weekdays));
    const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    if(state.logs.length > 5) {
        els.analytics.insightText.innerText = `You are most productive around ${maxHour}:00 and your best day is ${days[maxDayIdx]}. Keep it up!`;
    }

    // 6. Timeline Render (Interactive Tooltip Logic)
    const grid=els.analytics.timelineGrid; grid.innerHTML='';
    const tooltip = $('global-tooltip');
    const showTooltip=(e, txt, sub)=>{
        tooltip.innerHTML = `<strong>${txt}</strong><span class="sub">${sub}</span>`;
        tooltip.style.opacity = '1';
        tooltip.style.left = e.pageX + 'px';
        tooltip.style.top = e.pageY + 'px';
    };
    const hideTooltip=()=>{ tooltip.style.opacity = '0'; };

    for(let i=0;i<14;i++){
        const d=new Date(); d.setDate(now.getDate()-i); const dStr=getDayStr(d);
        const dayLogs=state.logs.filter(l=>l.completedAt && getDayStr(new Date(l.completedAt.seconds*1000))===dStr);
        const row=D.createElement('div'); row.className="flex items-center h-8 hover:bg-dark-hover rounded transition-colors";
        const lbl=D.createElement('div'); lbl.className="w-24 text-[10px] text-text-muted font-bold uppercase tracking-wider pl-2 flex-shrink-0";
        lbl.innerText=i===0?"Today":(i===1?"Yesterday":d.toLocaleDateString('en-US',{month:'short',day:'numeric'}));
        const bars=D.createElement('div'); bars.className="flex-1 h-full relative bg-dark-bg rounded mx-2 overflow-hidden border border-dark-border";
        for(let j=1;j<6;j++){const l=D.createElement('div'); l.className="absolute top-0 bottom-0 border-l border-dark-border opacity-30"; l.style.left=`${(j*4/24)*100}%`; bars.appendChild(l);}
        dayLogs.forEach(l=>{
            const ld=new Date(l.completedAt.seconds*1000); const sm=(ld.getHours()*60)+ld.getMinutes();
            const dur=l.duration||25; const lp=((sm-dur)/1440)*100; const wp=(dur/1440)*100;
            const b=D.createElement('div'); b.className="absolute top-1.5 bottom-1.5 rounded-sm bg-brand opacity-80 z-10 hover:bg-white transition-colors cursor-pointer";
            b.style.left=`${lp}%`; b.style.width=`${Math.max(wp,0.5)}%`;
            // Tooltip Events
            b.addEventListener('mousemove', (e)=>showTooltip(e, l.taskTitle||'Focus Session', `${ld.getHours()}:${ld.getMinutes().toString().padStart(2,'0')} - ${dur} mins`));
            b.addEventListener('mouseleave', hideTooltip);
            bars.appendChild(b);
        });
        row.appendChild(lbl); row.appendChild(bars); grid.appendChild(row);
    }

    // --- Charts Logic (Polished with Toggles) ---
    const r=state.analytics.range; 
    let lbl=[], dpFocus=[], dpTask=[];
    let dlb=r==='week'?7:(r==='month'?30:12);
    if(r==='year'){
        for(let i=11;i>=0;i--){
            const d=new Date(now.getFullYear(),now.getMonth()-i,1); lbl.push(d.toLocaleString('default',{month:'short'}));
            const mLogs=state.logs.filter(l=>{if(!l.completedAt)return!1; const ld=new Date(l.completedAt.seconds*1000); return ld.getMonth()===d.getMonth() && ld.getFullYear()===d.getFullYear();});
            dpFocus.push((mLogs.reduce((a,b)=>a+(b.duration||25),0)/60).toFixed(1));
            const mTasks=state.tasks.filter(t=>{if(t.status!=='done'||!t.completedAt)return!1; const td=new Date(t.completedAt); return td.getMonth()===d.getMonth() && td.getFullYear()===d.getFullYear();});
            dpTask.push(mTasks.length);
        }
    } else {
        for(let i=dlb-1;i>=0;i--){
            const d=new Date(); d.setDate(now.getDate()-i); const dStr=getDayStr(d);
            lbl.push(d.toLocaleDateString('en-US',{weekday:'short',day:r==='month'?'numeric':undefined}));
            const dLogs=state.logs.filter(l=>l.completedAt && getDayStr(new Date(l.completedAt.seconds*1000))===dStr);
            dpFocus.push((dLogs.reduce((a,b)=>a+(b.duration||25),0)/60).toFixed(1));
            const dTasks=state.tasks.filter(t=>t.status==='done' && t.completedAt && t.completedAt.startsWith(dStr));
            dpTask.push(dTasks.length);
        }
    }

    const commonOptions = {
        responsive: true, maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.03)', borderDash: [4, 4] } }, x: { grid: { display: false } } },
        plugins: { legend: { display: false } },
        elements: { bar: { borderRadius: 4, hoverBackgroundColor: '#fff' }, line: { tension: 0.4 } },
        interaction: { mode: 'index', intersect: false }
    };

    // Helper to get Chart Config based on type (Bar vs Line)
    const getChartConfig = (ctx, type, labels, data, color, tooltipLabel) => {
        const isLine = type === 'line';
        return {
            type: type,
            data: {
                labels: labels, 
                datasets: [{
                    label: tooltipLabel, 
                    data: data, 
                    backgroundColor: isLine ? createGradient(ctx, color) : color,
                    borderColor: color,
                    borderRadius: 4,
                    fill: isLine,
                    borderWidth: isLine ? 2 : 0,
                    pointRadius: isLine ? 0 : 0,
                    pointHoverRadius: 6
                }]
            },
            options: { ...commonOptions, plugins: { ...commonOptions.plugins, tooltip: { callbacks: { label: (c)=>c.raw + ' ' + (tooltipLabel.includes('Hours') ? 'hrs' : (tooltipLabel.includes('Tasks')?'tasks':'mins')) } } } }
        };
    };

    // Chart: Focus Trend
    if(state.charts.focusBar)state.charts.focusBar.destroy();
    const ctxFocus = els.analytics.focusBarChart.getContext('2d');
    state.charts.focusBar = new Chart(ctxFocus, getChartConfig(ctxFocus, state.chartTypes.focus, lbl, dpFocus, '#ff5757', 'Focus Hours'));

    // Chart: Task Trend
    if(state.charts.taskBar)state.charts.taskBar.destroy();
    const ctxTask = els.analytics.taskBarChart.getContext('2d');
    state.charts.taskBar = new Chart(ctxTask, getChartConfig(ctxTask, state.chartTypes.task, lbl, dpTask, '#3b82f6', 'Tasks Done'));

    // Chart: Hourly
    if(state.charts.hourly)state.charts.hourly.destroy();
    const ctxHourly = els.analytics.hourlyChart.getContext('2d');
    state.charts.hourly = new Chart(ctxHourly, getChartConfig(ctxHourly, state.chartTypes.hourly, Array.from({length:24},(_,i)=>i), hours, '#10b981', 'Minutes'));

    // Chart: Weekday
    if(state.charts.weekday)state.charts.weekday.destroy();
    const ctxWeekday = els.analytics.weekdayChart.getContext('2d');
    state.charts.weekday = new Chart(ctxWeekday, getChartConfig(ctxWeekday, state.chartTypes.weekday, ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], weekdays, '#f59e0b', 'Minutes'));

    // Chart: Project (Doughnut - Unchanged)
    const pm={}; state.logs.forEach(l=>{const p=l.project||'Inbox';pm[p]=(pm[p]||0)+(l.duration||25)});
    const sp=Object.entries(pm).sort((a,b)=>b[1]-a[1]);
    if(state.charts.project)state.charts.project.destroy();
    state.charts.project=new Chart(els.analytics.projectChart.getContext('2d'),{
        type:'doughnut', data:{labels:sp.map(x=>x[0]), datasets:[{data:sp.map(x=>x[1]),backgroundColor:['#ff5757','#8b5cf6','#3b82f6','#10b981','#f59e0b'],borderColor:'#282828',borderWidth:4, hoverOffset: 4}]},
        options:{responsive:!0,maintainAspectRatio:!1,cutout:'75%',plugins:{legend:{display:!1}, tooltip:{callbacks:{label:c=>c.label+': '+Math.round(c.raw)+'m'}}}}
    });
    els.analytics.projList.innerHTML = sp.map(x=>`<div class="flex justify-between text-xs text-text-muted"><span>${x[0]}</span><span>${Math.round(x[1])}m</span></div>`).join('');

    // Chart: Priority (Doughnut - Unchanged)
    const prioCounts={high:0, med:0, low:0, none:0};
    tasksDone.forEach(t=>priCounts[t.priority||'none']++);
    if(state.charts.priority)state.charts.priority.destroy();
    state.charts.priority=new Chart(els.analytics.priorityChart.getContext('2d'),{
        type:'doughnut', data:{labels:['High','Med','Low','None'], datasets:[{data:[priCounts.high, priCounts.med, priCounts.low, priCounts.none],backgroundColor:['#ef4444','#eab308','#3b82f6','#525252'],borderColor:'#282828',borderWidth:4, hoverOffset: 4}]},
        options:{responsive:!0,maintainAspectRatio:!1,cutout:'75%',plugins:{legend:{display:!1}}}
    });

    // Tag Ranking
    const tagCounts={};
    tasksDone.forEach(t=>{ if(t.tags) t.tags.forEach(tg=> tagCounts[tg]=(tagCounts[tg]||0)+1); });
    const sortedTags = Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
    if(sortedTags.length>0) {
        els.analytics.tagList.innerHTML = sortedTags.map((x,i)=>`<div class="flex items-center justify-between text-xs"><div class="flex items-center"><span class="w-4 text-text-faint mr-2">${i+1}.</span><span class="text-white bg-dark-hover px-1.5 py-0.5 rounded">${x[0]}</span></div><span class="text-text-muted">${x[1]} tasks</span></div>`).join('');
    }

    // Session Log Table
    els.analytics.sessionLogBody.innerHTML = state.logs.slice(0,20).map(l=>{
        const d = l.completedAt ? new Date(l.completedAt.seconds*1000) : new Date();
        return `<tr><td class="text-text-muted">${d.toLocaleDateString()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}</td><td class="font-medium text-white">${l.taskTitle}</td><td><span class="px-2 py-0.5 rounded-full text-[10px] bg-dark-hover border border-dark-border text-text-muted">${l.project}</span></td><td class="text-brand font-mono">${l.duration||25}m</td></tr>`;
    }).join('');
}

$('prompt-cancel-btn').addEventListener('click',()=>app.closePrompt(null));$('prompt-confirm-btn').addEventListener('click',()=>app.closePrompt(app.customPrompt.input.value));$('prompt-input').addEventListener('keypress',e=>{if(e.key==='Enter')app.closePrompt(app.customPrompt.input.value)});D.addEventListener('click',e=>{if(!e.target.closest('#project-dropdown')&&!e.target.closest('#priority-dropdown')){D.getElementById('project-options').classList.add('hidden');D.getElementById('priority-options').classList.add('hidden')}});
function updateNavStyles(v,p){D.querySelectorAll('.nav-btn').forEach(b=>{const i=b.id===`nav-${v}`;b.classList.toggle('bg-brand',i);b.classList.toggle('bg-opacity-10',i);b.classList.toggle('text-brand',i);b.classList.toggle('text-text-muted',!i);if(i)b.classList.remove('hover:text-white');else b.classList.add('hover:text-white')});D.querySelectorAll('.project-btn').forEach(b=>{const i=v==='project'&&b.dataset.proj===p;b.classList.toggle('text-brand',i);b.classList.toggle('bg-brand',i);b.classList.toggle('bg-opacity-10',i);b.classList.toggle('text-text-muted',!i)})}
function updateProjectsUI(){els.projectList.innerHTML='';state.projects.forEach(p=>{const d=D.createElement('div');d.innerHTML=`<div class="group relative flex items-center"><button onclick="app.setProjectView('${p}')" data-proj="${p}" class="project-btn w-full flex items-center justify-between px-3 py-2 rounded text-text-muted hover:bg-dark-hover hover:text-white transition-colors text-sm group shrink-0"><div class="flex items-center min-w-0"><i class="ph-bold ph-hash mr-3 opacity-50 shrink-0"></i><span class="truncate font-medium">${p}</span></div></button><div class="absolute right-2 flex opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="app.renameProject('${p}', event)" class="text-text-muted hover:text-white p-1"><i class="ph-bold ph-pencil-simple"></i></button><button onclick="app.deleteProject('${p}', event)" class="text-text-muted hover:text-red-400 p-1 ml-1"><i class="ph-bold ph-trash"></i></button></div></div>`;els.projectList.appendChild(d)})}
function updateCounts(){const getDayStr=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');const t=getDayStr(new Date()),tm=getDayStr(new Date(Date.now()+864e5));els.navCounts.today.innerText=state.tasks.filter(x=>x.dueDate===t&&x.status==='todo').length;els.navCounts.tomorrow.innerText=state.tasks.filter(x=>x.dueDate===tm&&x.status==='todo').length;els.navCounts.upcoming.innerText=state.tasks.filter(x=>x.dueDate>tm&&x.status==='todo').length;els.navCounts.past.innerText=state.tasks.filter(x=>x.dueDate<t&&x.status==='todo').length;const tp=state.tasks.reduce((a,b)=>a+(b.completedPomos||0),0);els.stats.pomosToday.innerText=tp;els.stats.tasksToday.innerText=state.tasks.filter(x=>x.status==='done'&&x.dueDate===t).length;els.stats.estRemain.innerText=state.tasks.filter(x=>x.status==='todo').reduce((a,b)=>a+(parseInt(b.estimatedPomos)||0),0);const fm=tp*state.timer.settings.focus;els.stats.focusTime.innerText=`${Math.floor(fm/60)}h ${fm%60}m`}
function renderTasks(){const getDayStr=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');const t=getDayStr(new Date()),tm=getDayStr(new Date(Date.now()+864e5));let l=[];if(state.view==='today')l=state.tasks.filter(x=>x.dueDate===t&&x.status==='todo');else if(state.view==='tomorrow')l=state.tasks.filter(x=>x.dueDate===tm&&x.status==='todo');else if(state.view==='upcoming')l=state.tasks.filter(x=>x.dueDate>tm&&x.status==='todo');else if(state.view==='past')l=state.tasks.filter(x=>x.dueDate<t&&x.status==='todo');else if(state.view==='completed')l=state.tasks.filter(x=>x.status==='done');else if(state.view==='project')l=state.tasks.filter(x=>x.project===state.filterProject&&x.status==='todo');const pm={high:3,med:2,low:1,none:0};l.sort((a,b)=>pm[b.priority]-pm[a.priority]);els.taskList.innerHTML='';if(l.length===0)els.emptyState.classList.remove('hidden');else els.emptyState.classList.add('hidden');l.forEach(x=>{const isSel=x.id===state.selectedTaskId,pc=Math.min(100,((x.completedPomos||0)/(x.estimatedPomos||1))*100),col={high:'text-red-400',med:'text-yellow-400',low:'text-blue-400',none:'text-text-muted'}[x.priority||'none'],sty=isSel?{high:'bg-dark-card border-red-500 shadow-sm z-10',med:'bg-dark-card border-yellow-500 shadow-sm z-10',low:'bg-dark-card border-blue-500 shadow-sm z-10',none:'bg-dark-card border-brand shadow-sm z-10'}[x.priority||'none']:'bg-dark-card border-dark-border hover:border-text-faint',el=D.createElement('div');el.className=`group flex items-start p-4 rounded-lg border transition-all duration-200 ease-out cursor-pointer relative ${sty}`;el.onclick=()=>app.selectTask(x.id);el.innerHTML=`<div class="absolute left-0 top-0 bottom-0 w-1 rounded-l-lg ${x.priority==='high'?'bg-red-500':x.priority==='med'?'bg-yellow-500':'bg-transparent'}"></div><label class="custom-checkbox flex-shrink-0 mt-0.5 w-5 h-5 mr-4 cursor-pointer relative z-10" onclick="event.stopPropagation()"><input type="checkbox" class="hidden" ${x.status==='done'?'checked':''} onchange="app.toggleTaskStatus('${x.id}','${x.status}')"><div class="w-5 h-5 border-2 border-text-faint rounded-full flex items-center justify-center transition-all hover:border-brand bg-dark-bg"><svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div></label><div class="flex-1 min-w-0 pr-20"><div class="flex items-center justify-between"><h3 class="text-base font-medium text-white truncate ${x.status==='done'?'line-through text-text-muted':''}">${x.title}</h3></div>${x.note?`<p class="text-xs text-text-muted line-clamp-1 mt-0.5 truncate">${x.note}</p>`:''}<div class="flex items-center mt-2 space-x-4"><div class="flex items-center text-xs text-text-muted"><i class="ph-bold ph-folder mr-1.5 text-text-faint"></i><span>${x.project}</span></div><div class="flex items-center text-xs text-text-muted"><i class="ph-fill ph-circle text-brand mr-1.5 text-[8px]"></i><span class="${pc>=100?'text-brand':''}">${x.completedPomos||0}/${x.estimatedPomos||1}</span></div>${x.tags&&x.tags.length?`<div class="flex gap-1 ml-auto">${x.tags.map(t=>`<span class="px-1.5 py-0.5 rounded text-[10px] bg-brand/10 text-brand border border-brand/20">${t}</span>`).join('')}</div>`:''}</div></div></div><div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center space-x-1 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-all z-20"><button onclick="app.startTask('${x.id}',event)" class="w-8 h-8 flex items-center justify-center text-brand hover:bg-brand hover:text-white transition-colors rounded"><i class="ph-fill ph-play"></i></button><button onclick="app.editTask('${x.id}',event)" class="w-8 h-8 flex items-center justify-center text-text-muted hover:text-white hover:bg-dark-hover transition-colors rounded"><i class="ph-bold ph-pencil-simple"></i></button><button onclick="app.deleteTask('${x.id}',event)" class="w-8 h-8 flex items-center justify-center text-text-muted hover:text-red-400 hover:bg-dark-hover transition-colors rounded"><i class="ph-bold ph-trash"></i></button></div>`;els.taskList.appendChild(el)})}
function updateTimerUI(t){if(!t){els.focusEmpty.classList.remove('hidden');els.focusActive.classList.add('hidden');return}els.focusEmpty.classList.add('hidden');els.focusActive.classList.remove('hidden');els.focusTitle.innerText=t.title;els.focusProject.innerText=t.project||'Inbox';els.focusCompleted.innerText=t.completedPomos||0;els.focusTotal.innerText=t.estimatedPomos||1}
app.setView('today');
</script></body></html>