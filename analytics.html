<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TimeTrekker Admin</title>
<link rel="icon" href="https://stack-base.github.io/media/brand/stackbase/stackbase-icon.png" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={
  darkMode:'class',
  theme:{
    extend:{
      fontFamily:{sans:['Inter','sans-serif']},
      colors:{
        brand:{DEFAULT:'#ff5757',hover:'#e04848',dim:'#4a1a1a'},
        dark:{bg:'#0f0f0f',sidebar:'#141414',card:'#1e1e1e',border:'#2a2a2a',hover:'#333333'},
        text:{main:'#e5e7eb',muted:'#a3a3a3',faint:'#525252'}
      }
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script src="https://unpkg.com/@phosphor-icons/web"></script>
<style>
::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:#141414}::-webkit-scrollbar-thumb{background:#333;border-radius:4px;border:2px solid #141414}
body{background-color:#0f0f0f;color:#e5e7eb;font-family:'Inter',sans-serif}
.animate-fade-in{animation:fadeIn .3s ease-out forwards}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body class="h-screen w-full flex overflow-hidden">

<aside class="w-64 bg-dark-sidebar border-r border-dark-border flex flex-col shrink-0 z-20">
    <div class="h-16 flex items-center px-6 border-b border-dark-border">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand to-red-600 flex items-center justify-center shadow-lg shadow-brand/20">
            <i class="ph-bold ph-chart-polar text-white text-lg"></i>
        </div>
        <span class="ml-3 font-bold text-lg text-white tracking-tight">TT Admin</span>
    </div>
    <nav class="flex-1 p-4 space-y-1">
        <button class="w-full flex items-center px-3 py-2 rounded bg-brand/10 text-brand border border-brand/20">
            <i class="ph-bold ph-squares-four text-lg"></i><span class="ml-3 font-medium text-sm">Overview</span>
        </button>
        <div class="mt-8 px-3 text-xs font-bold text-text-faint uppercase tracking-wider">Data Sources</div>
        <button class="w-full flex items-center px-3 py-2 rounded text-text-muted hover:text-white hover:bg-dark-hover transition-colors">
            <i class="ph-bold ph-users text-lg"></i><span class="ml-3 font-medium text-sm">Users</span>
        </button>
        <button class="w-full flex items-center px-3 py-2 rounded text-text-muted hover:text-white hover:bg-dark-hover transition-colors">
            <i class="ph-bold ph-check-square text-lg"></i><span class="ml-3 font-medium text-sm">Tasks Master</span>
        </button>
    </nav>
    <div class="p-4 border-t border-dark-border">
        <div class="flex items-center gap-3 mb-4">
             <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold text-white">A</div>
             <div class="flex flex-col min-w-0"><span class="text-sm font-medium text-white truncate">Admin Console</span><span class="text-xs text-text-muted">Connected</span></div>
        </div>
        <button onclick="app.signOut()" class="w-full flex items-center justify-center px-3 py-2 rounded border border-red-900/30 text-red-400 hover:bg-red-900/20 hover:text-red-300 transition-colors text-xs font-bold uppercase tracking-wide">
            <i class="ph-bold ph-sign-out mr-2"></i> Sign Out
        </button>
    </div>
</aside>

<main class="flex-1 flex flex-col min-w-0 bg-dark-bg overflow-hidden relative">
    <header class="h-16 flex items-center justify-between px-8 border-b border-dark-border bg-dark-bg/80 backdrop-blur z-10">
        <h1 class="text-xl font-semibold text-white">Product Analytics</h1>
        <button onclick="app.refreshData()" class="flex items-center px-3 py-1.5 rounded text-xs font-medium bg-dark-card border border-dark-border text-text-muted hover:text-white hover:border-brand transition-all">
            <i class="ph-bold ph-arrows-clockwise mr-2"></i> Refresh Data
        </button>
    </header>

    <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
            <div class="bg-dark-card border border-dark-border rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-users text-6xl text-brand"></i></div>
                <div class="text-sm text-text-muted font-medium uppercase tracking-wider mb-2">Total Users</div>
                <div class="text-3xl font-bold text-white mb-1" id="kpi-users">--</div>
                <div class="text-xs text-green-500 font-medium flex items-center"><i class="ph-bold ph-trend-up mr-1"></i> Lifetime signups</div>
            </div>
            <div class="bg-dark-card border border-dark-border rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-clock text-6xl text-blue-500"></i></div>
                <div class="text-sm text-text-muted font-medium uppercase tracking-wider mb-2">Total Focus Time</div>
                <div class="text-3xl font-bold text-white mb-1" id="kpi-focus">--</div>
                <div class="text-xs text-text-faint">Aggregated hours</div>
            </div>
            <div class="bg-dark-card border border-dark-border rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-check-circle text-6xl text-green-500"></i></div>
                <div class="text-sm text-text-muted font-medium uppercase tracking-wider mb-2">Tasks Created</div>
                <div class="text-3xl font-bold text-white mb-1" id="kpi-tasks">--</div>
                <div class="text-xs text-text-faint">Across all projects</div>
            </div>
            <div class="bg-dark-card border border-dark-border rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-lightning text-6xl text-yellow-500"></i></div>
                <div class="text-sm text-text-muted font-medium uppercase tracking-wider mb-2">Avg Session</div>
                <div class="text-3xl font-bold text-white mb-1" id="kpi-avg">--</div>
                <div class="text-xs text-text-faint">Minutes per focus</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-dark-card border border-dark-border rounded-xl p-6">
                <h3 class="text-lg font-bold text-white mb-6">Global Focus Activity</h3>
                <div class="h-[300px] w-full"><canvas id="activityChart"></canvas></div>
            </div>
            <div class="bg-dark-card border border-dark-border rounded-xl p-6 flex flex-col">
                <h3 class="text-lg font-bold text-white mb-2">Popular Projects</h3>
                <p class="text-xs text-text-muted mb-6">Top categories users create</p>
                <div class="h-[200px] w-full flex justify-center mb-4"><canvas id="projectDistChart"></canvas></div>
                <div id="top-projects-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-dark-card border border-dark-border rounded-xl overflow-hidden flex flex-col h-[400px]">
                <div class="p-6 border-b border-dark-border flex justify-between items-center bg-dark-card/50">
                    <h3 class="text-lg font-bold text-white">Recent Sessions</h3>
                    <span class="text-xs px-2 py-1 rounded bg-brand/10 text-brand border border-brand/20">Live Feed</span>
                </div>
                <div class="flex-1 overflow-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-dark-sidebar sticky top-0 z-10">
                            <tr>
                                <th class="p-4 text-xs font-bold text-text-muted uppercase border-b border-dark-border">Timestamp</th>
                                <th class="p-4 text-xs font-bold text-text-muted uppercase border-b border-dark-border">Task</th>
                                <th class="p-4 text-xs font-bold text-text-muted uppercase border-b border-dark-border">Duration</th>
                            </tr>
                        </thead>
                        <tbody id="live-feed-body" class="text-sm">
                            <tr><td colspan="3" class="p-4 text-center text-text-muted italic">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-dark-card border border-dark-border rounded-xl overflow-hidden flex flex-col h-[400px]">
                <div class="p-6 border-b border-dark-border bg-dark-card/50">
                    <h3 class="text-lg font-bold text-white">System Health</h3>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <div class="flex justify-between text-sm mb-2"><span class="text-text-muted">Task Completion Rate</span><span class="text-white font-bold" id="health-completion">0%</span></div>
                        <div class="w-full bg-dark-bg rounded-full h-2 overflow-hidden"><div id="bar-completion" class="bg-green-500 h-full rounded-full" style="width: 0%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-2"><span class="text-text-muted">High Priority Task Ratio</span><span class="text-white font-bold" id="health-priority">0%</span></div>
                        <div class="w-full bg-dark-bg rounded-full h-2 overflow-hidden"><div id="bar-priority" class="bg-red-500 h-full rounded-full" style="width: 0%"></div></div>
                    </div>
                    
                    <div class="p-4 rounded border border-dark-border bg-dark-bg mt-6">
                        <div class="text-xs text-text-muted font-bold uppercase mb-2">Console Logs</div>
                        <div id="console-log" class="text-[10px] font-mono text-text-faint h-24 overflow-y-auto">
                            > Initializing Admin Console...<br>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
import{getAuth,onAuthStateChanged,signInWithEmailAndPassword,signOut}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
import{getFirestore,collection,collectionGroup,getDocs,query,where,orderBy,limit}from'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

// --- CONFIGURATION ---
const C={apiKey:"AIzaSyDkKhb8m0znWyC2amv6uGpA8KmbkuW-j1U",authDomain:"timetrekker-app.firebaseapp.com",projectId:"timetrekker-app",storageBucket:"timetrekker-app.firebasestorage.app",messagingSenderId:"83185163190",appId:"1:83185163190:web:e2974c5d0f0274fe5e3f17",measurementId:"G-FLZ02E1Y5L"};
const appId='timetrekker-v1';

const fb=initializeApp(C);
const auth=getAuth(fb);
const db=getFirestore(fb);

Chart.defaults.font.family='Inter';
Chart.defaults.color='#a3a3a3';
Chart.defaults.borderColor='#2a2a2a';

// --- LOGGING ---
const log=(msg)=>{
    const b=document.getElementById('console-log');
    if(b) {
        b.innerHTML+=`> ${msg}<br>`;
        b.scrollTop=b.scrollHeight;
    }
    console.log(`[Admin] ${msg}`);
};

// --- STATE ---
const state = { sessions: [], tasks: [], charts: {} };

// --- UI HELPERS ---
const showLoginModal = () => {
    // Check if modal already exists
    if(document.getElementById('dev-login-modal')) return;

    const div = document.createElement('div');
    div.id = 'dev-login-modal';
    div.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm';
    div.innerHTML = `
        <div class="bg-dark-card border border-dark-border p-8 rounded-xl w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center"><i class="ph-bold ph-lock-key mr-2"></i> Admin Login</h2>
            <form id="dev-login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-text-muted uppercase mb-1">Email</label>
                    <input type="email" id="dev-email" class="w-full bg-dark-bg border border-dark-border rounded px-3 py-2 text-white focus:border-brand outline-none" placeholder="admin@example.com" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-text-muted uppercase mb-1">Password</label>
                    <input type="password" id="dev-pass" class="w-full bg-dark-bg border border-dark-border rounded px-3 py-2 text-white focus:border-brand outline-none" placeholder="••••••••" required>
                </div>
                <div id="login-error" class="text-red-500 text-xs hidden"></div>
                <button type="submit" class="w-full bg-brand hover:bg-brand-hover text-white font-bold py-2 rounded transition-colors mt-2">Access Dashboard</button>
            </form>
        </div>
    `;
    document.body.appendChild(div);

    document.getElementById('dev-login-form').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('dev-email').value;
        const pass = document.getElementById('dev-pass').value;
        const btn = e.target.querySelector('button');
        const err = document.getElementById('login-error');
        
        try {
            btn.innerText = 'Authenticating...';
            btn.disabled = true;
            await signInWithEmailAndPassword(auth, email, pass);
            // Auth listener will handle the rest and close modal
        } catch (error) {
            btn.innerText = 'Access Dashboard';
            btn.disabled = false;
            err.innerText = error.message;
            err.classList.remove('hidden');
        }
    };
};

// --- AUTH & INIT ---
onAuthStateChanged(auth, async u => {
    const modal = document.getElementById('dev-login-modal');
    
    if(u){
        if(modal) modal.remove(); // Close login if open
        log(`Authenticated as ${u.email}`);
        log('Starting data aggregation...');
        app.refreshData();
    } else {
        log('No user detected. Showing login prompt...');
        showLoginModal();
    }
});

const app = {
    signOut: async () => {
        try {
            await signOut(auth);
            log('Signed out successfully');
            state.sessions = [];
            state.tasks = [];
            // Clear Charts
            if(state.charts.activity) { state.charts.activity.destroy(); state.charts.activity = null; }
            if(state.charts.proj) { state.charts.proj.destroy(); state.charts.proj = null; }
            // UI Reset
            document.getElementById('live-feed-body').innerHTML = '<tr><td colspan="3" class="p-4 text-center text-text-muted italic">Signed out.</td></tr>';
            ['kpi-users','kpi-focus','kpi-tasks','kpi-avg','health-completion','health-priority'].forEach(id => document.getElementById(id).innerText = '--');
            document.getElementById('bar-completion').style.width = '0%';
            document.getElementById('bar-priority').style.width = '0%';
        } catch (e) {
            log(`Error signing out: ${e.message}`);
        }
    },
    refreshData: async () => {
        try {
            // 1. Fetch Global Sessions
            log('Fetching global sessions...');
            // NOTE: If this fails, you need a Firestore Index. Check Console (F12).
            const qSessions = query(collectionGroup(db, 'focus_sessions'), orderBy('completedAt', 'desc'), limit(500));
            const snapSessions = await getDocs(qSessions);
            state.sessions = snapSessions.docs.map(d => d.data());
            
            // 2. Fetch Global Tasks
            log('Fetching global tasks...');
            const qTasks = query(collectionGroup(db, 'tasks'), limit(500));
            const snapTasks = await getDocs(qTasks);
            state.tasks = snapTasks.docs.map(d => d.data());

            log(`Loaded ${state.sessions.length} sessions and ${state.tasks.length} tasks.`);
            
            updateKPIs();
            updateCharts();
            updateFeed();
            
        } catch (e) {
            log(`ERROR: ${e.message}`);
            if(e.message.includes('index')){
                alert('Missing Firestore Index! Open your browser console (F12) and click the link from Firebase to create it.');
            } else if(e.message.includes('permission') || e.code === 'permission-denied'){
                log('PERMISSION DENIED. Your account cannot read global data.');
                alert('Permission Denied. You need to update your Firestore Security Rules to allow reading "collectionGroup" data.');
            }
        }
    }
};
window.app = app;

function updateKPIs(){
    const totalTime = state.sessions.reduce((a,b)=>a+(b.duration||25),0);
    const h = Math.floor(totalTime/60);
    
    document.getElementById('kpi-users').innerText = "Active"; 
    document.getElementById('kpi-focus').innerText = `${h}h`;
    document.getElementById('kpi-tasks').innerText = state.tasks.length;
    
    const avg = state.sessions.length ? Math.round(totalTime/state.sessions.length) : 0;
    document.getElementById('kpi-avg').innerText = `${avg}m`;

    const done = state.tasks.filter(t=>t.status==='done').length;
    const rate = state.tasks.length ? Math.round((done/state.tasks.length)*100) : 0;
    document.getElementById('health-completion').innerText = `${rate}%`;
    document.getElementById('bar-completion').style.width = `${rate}%`;

    const high = state.tasks.filter(t=>t.priority==='high').length;
    const hRate = state.tasks.length ? Math.round((high/state.tasks.length)*100) : 0;
    document.getElementById('health-priority').innerText = `${hRate}%`;
    document.getElementById('bar-priority').style.width = `${hRate}%`;
}

function updateFeed(){
    const b = document.getElementById('live-feed-body');
    b.innerHTML = state.sessions.slice(0, 20).map(s => {
        const d = s.completedAt ? new Date(s.completedAt.seconds*1000) : new Date();
        return `<tr class="border-b border-dark-border hover:bg-dark-hover transition-colors">
            <td class="p-4 text-text-muted">${d.toLocaleDateString()} <span class="text-text-faint">${d.toLocaleTimeString()}</span></td>
            <td class="p-4 text-white font-medium">${s.taskTitle || 'Unknown Task'}</td>
            <td class="p-4 text-brand">${s.duration||25}m</td>
        </tr>`
    }).join('');
}

function updateCharts(){
    const days = {};
    state.sessions.forEach(s => {
        if(!s.completedAt) return;
        const d = new Date(s.completedAt.seconds*1000).toLocaleDateString();
        days[d] = (days[d]||0) + (s.duration||25);
    });
    
    const sortedDays = Object.keys(days).sort((a,b)=>new Date(a)-new Date(b)).slice(-7);
    
    if(state.charts.activity) state.charts.activity.destroy();
    const ctxA = document.getElementById('activityChart').getContext('2d');
    state.charts.activity = new Chart(ctxA, {
        type: 'line',
        data: {
            labels: sortedDays,
            datasets: [{
                label: 'Global Focus Minutes',
                data: sortedDays.map(d=>days[d]),
                borderColor: '#ff5757',
                backgroundColor: 'rgba(255, 87, 87, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { grid: { color: '#2a2a2a' } }, x: { grid: { display: false } } }
        }
    });

    const projs = {};
    state.sessions.forEach(s => {
        const p = s.project || 'Inbox';
        projs[p] = (projs[p]||0) + 1;
    });
    const sortedProj = Object.entries(projs).sort((a,b)=>b[1]-a[1]).slice(0,5);

    if(state.charts.proj) state.charts.proj.destroy();
    const ctxP = document.getElementById('projectDistChart').getContext('2d');
    state.charts.proj = new Chart(ctxP, {
        type: 'doughnut',
        data: {
            labels: sortedProj.map(x=>x[0]),
            datasets: [{
                data: sortedProj.map(x=>x[1]),
                backgroundColor: ['#ff5757','#3b82f6','#10b981','#f59e0b','#8b5cf6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            cutout: '70%'
        }
    });
    
    document.getElementById('top-projects-list').innerHTML = sortedProj.map((p,i) => 
        `<div class="flex justify-between items-center text-sm p-2 rounded hover:bg-dark-hover">
            <div class="flex items-center"><span class="w-2 h-2 rounded-full mr-3" style="background:${['#ff5757','#3b82f6','#10b981','#f59e0b','#8b5cf6'][i]}"></span><span class="text-white">${p[0]}</span></div>
            <span class="text-text-muted font-mono">${p[1]}</span>
        </div>`
    ).join('');
}
</script>
</body>
</html>